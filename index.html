<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farrier Pro - Multi-User Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <!-- Authorize.Net integration via backend functions -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Google API for Calendar -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2D5016;
      --primary-light: #4A7C2A;
      --secondary: #D4A574;
      --accent: #E8773D;
      --bg: #F5F1E8;
      --surface: #FFFFFF;
      --text: #1A1A1A;
      --text-muted: #666666;
      --success: #4A7C2A;
      --warning: #E8773D;
      --error: #C53030;
      --border: #E0D8C8;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      max-width: 100%;
      min-height: 100vh;
    }

    /* Header */
    .app-header {
      background: var(--primary);
      color: white;
      padding: 1rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo {
      font-family: 'Space Mono', monospace;
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-icon {
      font-size: 2rem;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .user-info {
      font-size: 0.875rem;
    }

    /* Main Content */
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* Auth Forms */
    .auth-container {
      max-width: 450px;
      margin: 3rem auto;
    }

    .auth-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      border: 2px solid var(--border);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .auth-header h1 {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .auth-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: var(--bg);
      padding: 0.25rem;
      border-radius: 8px;
    }

    .auth-tab {
      flex: 1;
      padding: 0.75rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .auth-tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
      border: 2px solid var(--border);
    }

    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--primary);
    }

    .form-group {
      margin-bottom: 1.25rem;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      padding: 0.875rem 2rem;
      border: none;
      border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--secondary);
      color: var(--text);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-google {
      background: white;
      color: #444;
      border: 2px solid var(--border);
    }

    .btn-google:hover {
      background: #f8f9fa;
    }

    /* QR Code Display */
    .qr-section {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      color: white;
      margin-bottom: 2rem;
    }

    .qr-code-container {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      display: inline-block;
      margin: 1.5rem 0;
    }

    .qr-code-container canvas {
      display: block;
    }

    .booking-link {
      background: rgba(255,255,255,0.2);
      padding: 1rem;
      border-radius: 8px;
      word-break: break-all;
      margin-top: 1rem;
      font-family: 'Space Mono', monospace;
      font-size: 0.875rem;
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--surface);
      padding: 1.5rem;
      border-radius: 12px;
      border: 2px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
    }

    .stat-change {
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .stat-change.positive {
      color: var(--success);
    }

    /* Calendar */
    .calendar {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      border: 2px solid var(--border);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .calendar-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .calendar-nav {
      display: flex;
      gap: 0.5rem;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .calendar-day.header {
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      cursor: default;
    }

    .calendar-day:not(.header):hover {
      background: var(--border);
    }

    .calendar-day.today {
      background: var(--primary);
      color: white;
    }

    .calendar-day.has-appointment {
      background: var(--accent);
      color: white;
    }

    /* Appointments List */
    .appointments-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .appointment-item {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s;
    }

    .appointment-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .appointment-info {
      flex: 1;
    }

    .appointment-customer {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
      color: var(--primary);
    }

    .appointment-details {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .appointment-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-success {
      background: #E6F4EA;
      color: var(--success);
    }

    .badge-warning {
      background: #FEF3E2;
      color: var(--warning);
    }

    .badge-secondary {
      background: #f3f4f6;
      color: #6b7280;
      text-decoration: line-through;
    }

    .badge-pending {
      background: #E8EAF6;
      color: #5E35B1;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .success-message {
      background: #E6F4EA;
      border: 2px solid var(--success);
      color: var(--success);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 600;
      text-align: center;
    }

    .error-message {
      background: #FEE;
      border: 2px solid var(--error);
      color: var(--error);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 600;
      text-align: center;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
    }

    .tab {
      padding: 0.75rem 1.5rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* Time Slots */
    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .time-slot {
      padding: 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      font-weight: 600;
    }

    .time-slot:hover {
      border-color: var(--primary);
    }

    .time-slot.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .time-slot.booked {
      opacity: 0.4;
      cursor: not-allowed;
      background: var(--border);
    }

    /* Google Calendar Status */
    .calendar-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .status-indicator.connected {
      background: var(--success);
    }

    .status-indicator.disconnected {
      background: var(--error);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .appointment-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .appointment-actions {
        width: 100%;
      }
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hero {
      text-align: center;
      margin-bottom: 3rem;
    }

    .hero h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 1rem;
      color: var(--primary);
    }

    .hero p {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAQ1LaWG9lE9j5h6X0T0YQKa_j04vJZHE4",
      authDomain: "farrier-pro.firebaseapp.com",
      projectId: "farrier-pro",
      storageBucket: "farrier-pro.firebasestorage.app",
      messagingSenderId: "1010833069179",
      appId: "1:1010833069179:web:844b6055462b55640b3ede",
      measurementId: "G-H14XM830EY"
    };

    // Initialize Firebase
    let app, auth, db;
    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
    } catch (error) {
      console.log("Firebase not configured yet - using demo mode");
    }

    // Google Calendar API Configuration
    const GOOGLE_CLIENT_ID = "458461432563-pkncm66du9pipuihdrbrhfrsuggo7loh.apps.googleusercontent.com";
    const CALENDAR_SCOPES = "https://www.googleapis.com/auth/calendar";

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [userProfile, setUserProfile] = useState(null);

      useEffect(() => {
        // Check authentication state
        if (auth) {
          const unsubscribe = auth.onAuthStateChanged(async (user) => {
            if (user) {
              setUser(user);
              // Load user profile from Firestore
              const profileDoc = await db.collection('farriers').doc(user.uid).get();
              if (profileDoc.exists) {
                setUserProfile(profileDoc.data());
              }
            } else {
              setUser(null);
              setUserProfile(null);
            }
            setLoading(false);
          });
          return () => unsubscribe();
        } else {
          setLoading(false);
        }
      }, []);

      // Check if URL is for customer booking
      const urlParams = new URLSearchParams(window.location.search);
      const farrierId = urlParams.get('farrier');

      if (loading) {
        return (
          <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}>
            <div className="spinner"></div>
          </div>
        );
      }

      // Customer booking view
      if (farrierId) {
        return <CustomerBookingView farrierId={farrierId} />;
      }

      // Authentication view
      if (!user) {
        return <AuthView />;
      }

      // Farrier dashboard
      return <FarrierDashboard user={user} userProfile={userProfile} setUserProfile={setUserProfile} />;
    }

    function AuthView() {
      const [mode, setMode] = useState('login'); // 'login' or 'signup'
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [businessName, setBusinessName] = useState('');
      const [phone, setPhone] = useState('');
      const [address, setAddress] = useState('');
      const [city, setCity] = useState('');
      const [state, setState] = useState('');
      const [zip, setZip] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [successMessage, setSuccessMessage] = useState('');

      const handleForgotPassword = async () => {
        if (!email) {
          setError('Please enter your email address first');
          return;
        }
        
        setError('');
        setLoading(true);
        
        try {
          if (!auth) {
            setError('Firebase not configured. Please add your Firebase credentials.');
            setLoading(false);
            return;
          }
          await auth.sendPasswordResetEmail(email);
          setSuccessMessage('Password reset email sent! Check your inbox.');
          setError('');
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        
        try {
          if (!auth) {
            setError('Firebase not configured. Please add your Firebase credentials.');
            setLoading(false);
            return;
          }
          await auth.signInWithEmailAndPassword(email, password);
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      const handleGoogleSignIn = async () => {
        setError('');
        setLoading(true);
        
        try {
          if (!auth) {
            setError('Firebase not configured.');
            setLoading(false);
            return;
          }

          const provider = new firebase.auth.GoogleAuthProvider();
          const result = await auth.signInWithPopup(provider);
          const user = result.user;

          // Check if user profile exists
          const profileDoc = await db.collection('farriers').doc(user.uid).get();
          
          if (!profileDoc.exists) {
            // First time Google sign-in - create profile
            await db.collection('farriers').doc(user.uid).set({
              businessName: user.displayName || 'My Farrier Business',
              email: user.email,
              phone: '',
              address: '',
              city: '',
              state: '',
              zip: '',
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              googleCalendarConnected: false,
              bookingUrl: window.location.origin + '?farrier=' + user.uid
            });
          }
          
          // User will be automatically logged in by Firebase
        } catch (err) {
          if (err.code !== 'auth/popup-closed-by-user') {
            setError(err.message);
          }
        }
        setLoading(false);
      };

      const handleSignup = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        
        try {
          if (!auth) {
            setError('Firebase not configured. Please add your Firebase credentials.');
            setLoading(false);
            return;
          }

          // Create user account
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;
          
          // Send welcome/verification email
          await user.sendEmailVerification();
          
          // Create farrier profile in Firestore
          await db.collection('farriers').doc(user.uid).set({
            businessName: businessName,
            email: email,
            phone: phone,
            address: address,
            city: city,
            state: state,
            zip: zip,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            googleCalendarConnected: false,
            bookingUrl: window.location.origin + '?farrier=' + user.uid
          });
          
          alert('Welcome! Please check your email to verify your account.');

        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      return (
        <div className="app-container">
          <header className="app-header">
            <div className="header-content">
              <div className="logo">
                <span className="logo-icon">üê¥</span>
                <span>Farrier Pro</span>
              </div>
            </div>
          </header>

          <div className="auth-container">
            <div className="auth-card">
              <div className="auth-header">
                <h1>Welcome Back</h1>
                <p>Manage your farrier business with ease</p>
              </div>

              <div className="auth-tabs">
                <button 
                  className={`auth-tab ${mode === 'login' ? 'active' : ''}`}
                  onClick={() => setMode('login')}
                >
                  Login
                </button>
                <button 
                  className={`auth-tab ${mode === 'signup' ? 'active' : ''}`}
                  onClick={() => setMode('signup')}
                >
                  Sign Up
                </button>
              </div>

              {error && <div className="error-message">{error}</div>}
              {successMessage && <div className="success-message">{successMessage}</div>}

              <form onSubmit={mode === 'login' ? handleLogin : handleSignup}>
                {mode === 'signup' && (
                  <>
                    <div className="form-group">
                      <label>Business Name *</label>
                      <input 
                        type="text"
                        required
                        value={businessName}
                        onChange={(e) => setBusinessName(e.target.value)}
                        placeholder="John's Farrier Services"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Phone Number *</label>
                      <input 
                        type="tel"
                        required
                        value={phone}
                        onChange={(e) => setPhone(e.target.value)}
                        placeholder="(555) 555-5555"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Business Address *</label>
                      <input 
                        type="text"
                        required
                        value={address}
                        onChange={(e) => setAddress(e.target.value)}
                        placeholder="123 Main Street"
                      />
                    </div>
                    
                    <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem'}}>
                      <div className="form-group">
                        <label>City *</label>
                        <input 
                          type="text"
                          required
                          value={city}
                          onChange={(e) => setCity(e.target.value)}
                          placeholder="City"
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>State *</label>
                        <input 
                          type="text"
                          required
                          value={state}
                          onChange={(e) => setState(e.target.value.toUpperCase())}
                          placeholder="VA"
                          maxLength="2"
                          style={{textTransform: 'uppercase'}}
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>ZIP *</label>
                        <input 
                          type="text"
                          required
                          value={zip}
                          onChange={(e) => setZip(e.target.value)}
                          placeholder="12345"
                          maxLength="5"
                          pattern="[0-9]{5}"
                        />
                      </div>
                    </div>
                  </>
                )}

                <div className="form-group">
                  <label>Email</label>
                  <input 
                    type="email"
                    required
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="your@email.com"
                  />
                </div>

                <div className="form-group">
                  <label>Password</label>
                  <input 
                    type="password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    minLength={6}
                  />
                </div>

                <button 
                  type="submit" 
                  className="btn btn-primary" 
                  style={{width: '100%'}}
                  disabled={loading}
                >
                  {loading ? <span className="spinner"></span> : (mode === 'login' ? 'Login' : 'Create Account')}
                </button>

                {/* Divider */}
                <div style={{display: 'flex', alignItems: 'center', margin: '1.5rem 0', gap: '1rem'}}>
                  <div style={{flex: 1, height: '1px', background: '#e0e0e0'}}></div>
                  <span style={{color: '#666', fontSize: '0.875rem'}}>OR</span>
                  <div style={{flex: 1, height: '1px', background: '#e0e0e0'}}></div>
                </div>

                {/* Google Sign-In Button */}
                <button 
                  type="button"
                  onClick={handleGoogleSignIn}
                  className="btn"
                  disabled={loading}
                  style={{
                    width: '100%',
                    background: 'white',
                    color: '#444',
                    border: '1px solid #ddd',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '0.75rem',
                    fontWeight: '500'
                  }}
                >
                  <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/>
                    <path d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
                    <path d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.17.282-1.709V4.958H.957C.347 6.173 0 7.548 0 9c0 1.452.348 2.827.957 4.042l3.007-2.335z" fill="#FBBC05"/>
                    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                  </svg>
                  {mode === 'login' ? 'Sign in with Google' : 'Sign up with Google'}
                </button>
                
                {mode === 'login' && (
                  <div style={{textAlign: 'center', marginTop: '1rem'}}>
                    <button 
                      type="button"
                      onClick={handleForgotPassword}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: 'var(--primary)',
                        textDecoration: 'underline',
                        cursor: 'pointer',
                        fontSize: '0.875rem'
                      }}
                    >
                      Forgot password?
                    </button>
                  </div>
                )}
              </form>
            </div>
          </div>
        </div>
      );
    }

    function FarrierDashboard({ user, userProfile, setUserProfile }) {
      const [tab, setTab] = useState('qrcode');
      const [showQRModal, setShowQRModal] = useState(false);

      const handleLogout = async () => {
        if (auth) {
          await auth.signOut();
        }
      };

      const connectGoogleCalendar = async () => {
        try {
          // TEMPORARY: Use old token client method until API is working
          // This gives 1-hour tokens but at least it works
          const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/calendar',
            callback: async (response) => {
              if (response.access_token) {
                // Save token to Firestore
                if (db) {
                  await db.collection('farriers').doc(user.uid).update({
                    googleCalendarConnected: true,
                    googleAccessToken: response.access_token,
                    googleTokenExpiry: Date.now() + (3600 * 1000) // 1 hour
                  });
                  
                  // Reload profile from Firestore
                  const profileDoc = await db.collection('farriers').doc(user.uid).get();
                  if (profileDoc.exists) {
                    setUserProfile(profileDoc.data());
                  }
                  
                  alert('‚úÖ Google Calendar connected! (Note: You may need to reconnect in 1 hour until refresh tokens are set up)');
                }
              }
            },
          });
          tokenClient.requestAccessToken();
        } catch (error) {
          console.error('Error connecting Google Calendar:', error);
          alert('Error connecting Google Calendar');
        }
      };

      const disconnectGoogleCalendar = async () => {
        if (confirm('Are you sure you want to disconnect Google Calendar? Future appointments will not sync to your calendar.')) {
          try {
            if (db) {
              await db.collection('farriers').doc(user.uid).update({
                googleCalendarConnected: false,
                googleAccessToken: firebase.firestore.FieldValue.delete(),
                googleRefreshToken: firebase.firestore.FieldValue.delete(),
                googleTokenExpiry: firebase.firestore.FieldValue.delete()
              });
              
              // Reload profile from Firestore
              const profileDoc = await db.collection('farriers').doc(user.uid).get();
              if (profileDoc.exists) {
                setUserProfile(profileDoc.data());
              }
              
              alert('Google Calendar disconnected successfully!');
            }
          } catch (error) {
            console.error('Error disconnecting:', error);
            alert('Error disconnecting Google Calendar');
          }
        }
      };

      const tabs = [
        { id: 'qrcode', label: 'My QR Code', icon: 'üì±' },
        { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
        { id: 'calendar', label: 'Calendar', icon: 'üìÖ' },
        { id: 'appointments', label: 'Appointments', icon: 'üìã' },
        { id: 'invoices', label: 'Invoices', icon: 'üí∞' },
        { id: 'reports', label: 'Reports', icon: 'üìà' },
        { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' },
        { id: 'about', label: 'About', icon: '‚ÑπÔ∏è' }
      ];

      return (
        <div className="app-container">
          <header className="app-header">
            <div className="header-content">
              <div className="logo">
                <span className="logo-icon">üê¥</span>
                <span>Farrier Pro</span>
              </div>
              <div className="header-actions">
                <div className="user-info">
                  {userProfile?.businessName || user.email}
                </div>
                <button 
                  className="btn btn-sm" 
                  onClick={handleLogout}
                  style={{background: 'white', color: 'var(--primary)', fontWeight: '600'}}
                >
                  üö™ Logout
                </button>
              </div>
            </div>
          </header>

          <main className="main-content">
            <div className="tabs">
              {tabs.map(t => (
                <button 
                  key={t.id}
                  className={`tab ${tab === t.id ? 'active' : ''}`}
                  onClick={() => setTab(t.id)}
                >
                  {t.icon} {t.label}
                </button>
              ))}
            </div>

            {tab === 'qrcode' && (
              <QRCodeView 
                user={user} 
                userProfile={userProfile}
                connectGoogleCalendar={connectGoogleCalendar}
                disconnectGoogleCalendar={disconnectGoogleCalendar}
              />
            )}
            {tab === 'dashboard' && <DashboardView userId={user.uid} />}
            {tab === 'calendar' && <CalendarView userId={user.uid} />}
            {tab === 'appointments' && <AppointmentsView userId={user.uid} userProfile={userProfile} />}
            {tab === 'invoices' && <InvoicesView userId={user.uid} />}
            {tab === 'reports' && <ReportsView userId={user.uid} />}
            {tab === 'settings' && <SettingsView user={user} userProfile={userProfile} setUserProfile={setUserProfile} />}
            {tab === 'about' && <AboutView />}
          </main>
        </div>
      );
    }

    function ReportsView({ userId }) {
      const [invoices, setInvoices] = useState([]);
      const [loading, setLoading] = useState(true);
      const [dateRange, setDateRange] = useState('thisMonth'); // thisMonth, lastMonth, thisQuarter, thisYear, custom
      const [customStartDate, setCustomStartDate] = useState('');
      const [customEndDate, setCustomEndDate] = useState('');
      const [detailView, setDetailView] = useState(null); // { type: 'month', data: {...} } or { type: 'status', data: {...} } or { type: 'customer', data: {...} } or { type: 'service', data: {...} }

      useEffect(() => {
        loadInvoices();
      }, []);

      const loadInvoices = async () => {
        if (db) {
          try {
            const snapshot = await db.collection('invoices')
              .where('farrierId', '==', userId)
              .get();

            const invoiceData = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            setInvoices(invoiceData);
          } catch (error) {
            console.error('Error loading invoices:', error);
          }
        }
        setLoading(false);
      };

      // Filter invoices by date range
      const getFilteredInvoices = () => {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();

        return invoices.filter(invoice => {
          if (!invoice.createdAt) return false;
          
          const invoiceDate = invoice.createdAt.toDate();
          const invoiceYear = invoiceDate.getFullYear();
          const invoiceMonth = invoiceDate.getMonth();

          switch (dateRange) {
            case 'thisMonth':
              return invoiceYear === currentYear && invoiceMonth === currentMonth;
            
            case 'lastMonth':
              const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
              const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
              return invoiceYear === lastMonthYear && invoiceMonth === lastMonth;
            
            case 'thisQuarter':
              const currentQuarter = Math.floor(currentMonth / 3);
              const invoiceQuarter = Math.floor(invoiceMonth / 3);
              return invoiceYear === currentYear && invoiceQuarter === currentQuarter;
            
            case 'thisYear':
              return invoiceYear === currentYear;
            
            case 'custom':
              if (!customStartDate || !customEndDate) return true;
              const start = new Date(customStartDate);
              const end = new Date(customEndDate);
              end.setHours(23, 59, 59);
              return invoiceDate >= start && invoiceDate <= end;
            
            default:
              return true;
          }
        });
      };

      const filteredInvoices = getFilteredInvoices();

      // Calculate metrics
      const totalRevenue = filteredInvoices
        .filter(inv => inv.status === 'paid')
        .reduce((sum, inv) => sum + (inv.total || 0), 0);

      const totalOutstanding = filteredInvoices
        .filter(inv => inv.status === 'outstanding')
        .reduce((sum, inv) => sum + (inv.total || 0), 0);

      const totalInvoices = filteredInvoices.length;
      const paidInvoices = filteredInvoices.filter(inv => inv.status === 'paid').length;
      const unpaidInvoices = filteredInvoices.filter(inv => inv.status === 'outstanding').length;

      const averageInvoice = totalInvoices > 0 ? totalRevenue / paidInvoices : 0;
      const collectionRate = totalInvoices > 0 ? (paidInvoices / totalInvoices * 100) : 0;

      // Top customers
      const customerTotals = {};
      filteredInvoices.forEach(inv => {
        if (inv.status === 'paid') {
          const name = inv.customerName || 'Unknown';
          customerTotals[name] = (customerTotals[name] || 0) + (inv.total || 0);
        }
      });

      const topCustomers = Object.entries(customerTotals)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      // Service breakdown
      const serviceRevenue = {};
      filteredInvoices.forEach(inv => {
        if (inv.status === 'paid' && inv.items) {
          inv.items.forEach(item => {
            const service = item.description || 'Unknown Service';
            serviceRevenue[service] = (serviceRevenue[service] || 0) + parseFloat(item.amount || 0);
          });
        }
      });

      const topServices = Object.entries(serviceRevenue)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      // Monthly trend (last 6 months)
      const monthlyData = [];
      for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const month = date.getMonth();
        const year = date.getFullYear();
        
        const monthRevenue = invoices
          .filter(inv => {
            if (!inv.createdAt || inv.status !== 'paid') return false;
            const invDate = inv.createdAt.toDate();
            return invDate.getMonth() === month && invDate.getFullYear() === year;
          })
          .reduce((sum, inv) => sum + (inv.total || 0), 0);

        monthlyData.push({
          month: date.toLocaleDateString('en-US', { month: 'short' }),
          year: date.getFullYear(),
          revenue: monthRevenue
        });
      }

      const maxRevenue = Math.max(...monthlyData.map(d => d.revenue), 1);

      // Calculate aging report (overdue invoices)
      const now = new Date();
      const aging = {
        current: { amount: 0, count: 0, invoices: [] },
        days30: { amount: 0, count: 0, invoices: [] },
        days60: { amount: 0, count: 0, invoices: [] },
        days90: { amount: 0, count: 0, invoices: [] },
        days90plus: { amount: 0, count: 0, invoices: [] }
      };

      filteredInvoices.forEach(inv => {
        if (inv.status === 'outstanding' && inv.createdAt) {
          const createdDate = inv.createdAt.toDate();
          const daysOld = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
          
          if (daysOld <= 30) {
            aging.current.amount += inv.total || 0;
            aging.current.count++;
            aging.current.invoices.push(inv);
          } else if (daysOld <= 60) {
            aging.days30.amount += inv.total || 0;
            aging.days30.count++;
            aging.days30.invoices.push(inv);
          } else if (daysOld <= 90) {
            aging.days60.amount += inv.total || 0;
            aging.days60.count++;
            aging.days60.invoices.push(inv);
          } else if (daysOld <= 120) {
            aging.days90.amount += inv.total || 0;
            aging.days90.count++;
            aging.days90.invoices.push(inv);
          } else {
            aging.days90plus.amount += inv.total || 0;
            aging.days90plus.count++;
            aging.days90plus.invoices.push(inv);
          }
        }
      });

      const maxAging = Math.max(
        aging.current.amount,
        aging.days30.amount,
        aging.days60.amount,
        aging.days90.amount,
        aging.days90plus.amount,
        1
      );

      return (
        <div>
          <div style={{marginBottom: '2rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '1rem'}}>
            <div>
              <h1 style={{fontSize: '2rem', color: 'var(--primary)', marginBottom: '0.5rem'}}>
                üìà Reports & Analytics
              </h1>
              <p style={{color: 'var(--text-muted)'}}>
                Financial insights and performance metrics
              </p>
            </div>

            <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
              <button
                onClick={() => setDateRange('thisMonth')}
                className={`btn btn-sm ${dateRange === 'thisMonth' ? 'btn-primary' : 'btn-outline'}`}
              >
                This Month
              </button>
              <button
                onClick={() => setDateRange('lastMonth')}
                className={`btn btn-sm ${dateRange === 'lastMonth' ? 'btn-primary' : 'btn-outline'}`}
              >
                Last Month
              </button>
              <button
                onClick={() => setDateRange('thisQuarter')}
                className={`btn btn-sm ${dateRange === 'thisQuarter' ? 'btn-primary' : 'btn-outline'}`}
              >
                This Quarter
              </button>
              <button
                onClick={() => setDateRange('thisYear')}
                className={`btn btn-sm ${dateRange === 'thisYear' ? 'btn-primary' : 'btn-outline'}`}
              >
                This Year
              </button>
              <button
                onClick={() => setDateRange('custom')}
                className={`btn btn-sm ${dateRange === 'custom' ? 'btn-primary' : 'btn-outline'}`}
              >
                Custom Range
              </button>
            </div>
          </div>

          {dateRange === 'custom' && (
            <div style={{marginBottom: '2rem', padding: '1rem', background: '#f9fafb', borderRadius: '8px', display: 'flex', gap: '1rem', flexWrap: 'wrap'}}>
              <div>
                <label style={{display: 'block', marginBottom: '0.25rem', fontSize: '0.875rem', fontWeight: '500'}}>Start Date</label>
                <input 
                  type="date" 
                  value={customStartDate}
                  onChange={(e) => setCustomStartDate(e.target.value)}
                  style={{padding: '0.5rem', borderRadius: '4px', border: '1px solid #ddd'}}
                />
              </div>
              <div>
                <label style={{display: 'block', marginBottom: '0.25rem', fontSize: '0.875rem', fontWeight: '500'}}>End Date</label>
                <input 
                  type="date" 
                  value={customEndDate}
                  onChange={(e) => setCustomEndDate(e.target.value)}
                  style={{padding: '0.5rem', borderRadius: '4px', border: '1px solid #ddd'}}
                />
              </div>
            </div>
          )}

          {loading ? (
            <div style={{display: 'flex', justifyContent: 'center', padding: '4rem'}}>
              <div className="spinner"></div>
            </div>
          ) : (
            <>
              {/* Key Metrics */}
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem', marginBottom: '2rem'}}>
                <div className="card">
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem', fontWeight: '500'}}>
                    Total Revenue
                  </div>
                  <div style={{fontSize: '2rem', fontWeight: '700', color: '#16a34a'}}>
                    ${totalRevenue.toFixed(2)}
                  </div>
                </div>

                <div className="card">
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem', fontWeight: '500'}}>
                    Outstanding
                  </div>
                  <div style={{fontSize: '2rem', fontWeight: '700', color: '#f59e0b'}}>
                    ${totalOutstanding.toFixed(2)}
                  </div>
                </div>

                <div className="card">
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem', fontWeight: '500'}}>
                    Average Invoice
                  </div>
                  <div style={{fontSize: '2rem', fontWeight: '700', color: 'var(--primary)'}}>
                    ${averageInvoice.toFixed(2)}
                  </div>
                </div>

                <div className="card">
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem', fontWeight: '500'}}>
                    Collection Rate
                  </div>
                  <div style={{fontSize: '2rem', fontWeight: '700', color: 'var(--primary)'}}>
                    {collectionRate.toFixed(1)}%
                  </div>
                </div>
              </div>

              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1.5rem', marginBottom: '2rem'}}>
                {/* Revenue Trend */}
                <div className="card">
                  <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                    üìä 6-Month Revenue Trend <span style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontWeight: 'normal'}}>(click bars)</span>
                  </h3>
                  <div style={{height: '200px', display: 'flex', alignItems: 'flex-end', gap: '0.5rem', justifyContent: 'space-between'}}>
                    {monthlyData.map((data, i) => {
                      const monthInvoices = invoices.filter(inv => {
                        if (!inv.createdAt || inv.status !== 'paid') return false;
                        const invDate = inv.createdAt.toDate();
                        return invDate.toLocaleDateString('en-US', { month: 'short' }) === data.month &&
                               invDate.getFullYear() === data.year;
                      });

                      return (
                        <div 
                          key={i} 
                          style={{flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', cursor: data.revenue > 0 ? 'pointer' : 'default'}}
                          onClick={() => {
                            if (data.revenue > 0) {
                              setDetailView({
                                type: 'month',
                                data: {
                                  month: `${data.month} ${data.year}`,
                                  invoices: monthInvoices,
                                  total: data.revenue
                                }
                              });
                            }
                          }}
                        >
                          <div style={{
                            width: '100%',
                            height: `${(data.revenue / maxRevenue) * 180}px`,
                            minHeight: data.revenue > 0 ? '10px' : '0',
                            background: 'linear-gradient(to top, #16a34a, #22c55e)',
                            borderRadius: '4px 4px 0 0',
                            transition: 'all 0.3s',
                            marginBottom: '0.5rem',
                            transform: 'scale(1)',
                          }}
                          onMouseEnter={(e) => {
                            if (data.revenue > 0) {
                              e.target.style.transform = 'scale(1.05)';
                              e.target.style.filter = 'brightness(1.1)';
                            }
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.transform = 'scale(1)';
                            e.target.style.filter = 'brightness(1)';
                          }}
                          title={`${data.month}: $${data.revenue.toFixed(2)} (click to see invoices)`}></div>
                          <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', fontWeight: '500'}}>
                            {data.month}
                          </div>
                          <div style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>
                            ${(data.revenue / 1000).toFixed(1)}k
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Invoice Status */}
                <div className="card">
                  <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                    üìã Invoice Breakdown <span style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontWeight: 'normal'}}>(click to view)</span>
                  </h3>
                  <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                      <span style={{color: 'var(--text-muted)'}}>Total Invoices</span>
                      <span style={{fontSize: '1.5rem', fontWeight: '700', color: 'var(--primary)'}}>{totalInvoices}</span>
                    </div>
                    <div 
                      style={{
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        padding: '0.5rem',
                        borderRadius: '8px',
                        cursor: paidInvoices > 0 ? 'pointer' : 'default',
                        transition: 'background 0.2s'
                      }}
                      onMouseEnter={(e) => { if (paidInvoices > 0) e.currentTarget.style.background = '#f0fdf4'; }}
                      onMouseLeave={(e) => { e.currentTarget.style.background = 'transparent'; }}
                      onClick={() => {
                        if (paidInvoices > 0) {
                          const paidInvs = filteredInvoices.filter(inv => inv.status === 'paid');
                          setDetailView({
                            type: 'status',
                            data: {
                              status: 'paid',
                              invoices: paidInvs,
                              total: paidInvs.reduce((sum, inv) => sum + (inv.total || 0), 0)
                            }
                          });
                        }
                      }}
                    >
                      <span style={{color: 'var(--text-muted)'}}>‚úÖ Paid</span>
                      <span style={{fontSize: '1.25rem', fontWeight: '600', color: '#16a34a'}}>{paidInvoices}</span>
                    </div>
                    <div 
                      style={{
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        padding: '0.5rem',
                        borderRadius: '8px',
                        cursor: unpaidInvoices > 0 ? 'pointer' : 'default',
                        transition: 'background 0.2s'
                      }}
                      onMouseEnter={(e) => { if (unpaidInvoices > 0) e.currentTarget.style.background = '#fef3c7'; }}
                      onMouseLeave={(e) => { e.currentTarget.style.background = 'transparent'; }}
                      onClick={() => {
                        if (unpaidInvoices > 0) {
                          const unpaidInvs = filteredInvoices.filter(inv => inv.status === 'outstanding');
                          setDetailView({
                            type: 'status',
                            data: {
                              status: 'outstanding',
                              invoices: unpaidInvs,
                              total: unpaidInvs.reduce((sum, inv) => sum + (inv.total || 0), 0)
                            }
                          });
                        }
                      }}
                    >
                      <span style={{color: 'var(--text-muted)'}}>‚è≥ Unpaid</span>
                      <span style={{fontSize: '1.25rem', fontWeight: '600', color: '#f59e0b'}}>{unpaidInvoices}</span>
                    </div>
                    <div style={{marginTop: '1rem', height: '30px', display: 'flex', borderRadius: '8px', overflow: 'hidden', cursor: 'pointer'}}>
                      {paidInvoices > 0 && (
                        <div 
                          style={{
                            width: `${(paidInvoices / totalInvoices) * 100}%`,
                            background: '#16a34a',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '0.75rem',
                            fontWeight: '600',
                            transition: 'filter 0.2s'
                          }}
                          onMouseEnter={(e) => { e.target.style.filter = 'brightness(1.1)'; }}
                          onMouseLeave={(e) => { e.target.style.filter = 'brightness(1)'; }}
                          onClick={() => {
                            const paidInvs = filteredInvoices.filter(inv => inv.status === 'paid');
                            setDetailView({
                              type: 'status',
                              data: {
                                status: 'paid',
                                invoices: paidInvs,
                                total: paidInvs.reduce((sum, inv) => sum + (inv.total || 0), 0)
                              }
                            });
                          }}
                        >
                          {((paidInvoices / totalInvoices) * 100).toFixed(0)}%
                        </div>
                      )}
                      {unpaidInvoices > 0 && (
                        <div 
                          style={{
                            width: `${(unpaidInvoices / totalInvoices) * 100}%`,
                            background: '#f59e0b',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '0.75rem',
                            fontWeight: '600',
                            transition: 'filter 0.2s'
                          }}
                          onMouseEnter={(e) => { e.target.style.filter = 'brightness(1.1)'; }}
                          onMouseLeave={(e) => { e.target.style.filter = 'brightness(1)'; }}
                          onClick={() => {
                            const unpaidInvs = filteredInvoices.filter(inv => inv.status === 'outstanding');
                            setDetailView({
                              type: 'status',
                              data: {
                                status: 'outstanding',
                                invoices: unpaidInvs,
                                total: unpaidInvs.reduce((sum, inv) => sum + (inv.total || 0), 0)
                              }
                            });
                          }}
                        >
                          {((unpaidInvoices / totalInvoices) * 100).toFixed(0)}%
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              {/* Aging Report */}
              <div style={{marginBottom: '2rem'}}>
                <div className="card">
                  <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                    üìÖ Accounts Receivable Aging <span style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontWeight: 'normal'}}>(click bars)</span>
                  </h3>
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '1.5rem'}}>
                    Outstanding invoices by age
                  </div>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '1rem'}}>
                    {[
                      { label: 'Current', sublabel: '0-30 days', data: aging.current, color: '#22c55e' },
                      { label: '30 Days', sublabel: '31-60 days', data: aging.days30, color: '#eab308' },
                      { label: '60 Days', sublabel: '61-90 days', data: aging.days60, color: '#f97316' },
                      { label: '90 Days', sublabel: '91-120 days', data: aging.days90, color: '#ef4444' },
                      { label: '120+ Days', sublabel: 'over 120', data: aging.days90plus, color: '#991b1b' }
                    ].map((bucket, i) => (
                      <div 
                        key={i}
                        style={{
                          display: 'flex',
                          flexDirection: 'column',
                          alignItems: 'center',
                          cursor: bucket.data.count > 0 ? 'pointer' : 'default',
                          padding: '1rem',
                          borderRadius: '8px',
                          transition: 'all 0.3s'
                        }}
                        onMouseEnter={(e) => {
                          if (bucket.data.count > 0) {
                            e.currentTarget.style.background = '#f9fafb';
                            e.currentTarget.style.transform = 'translateY(-4px)';
                          }
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = 'transparent';
                          e.currentTarget.style.transform = 'translateY(0)';
                        }}
                        onClick={() => {
                          if (bucket.data.count > 0) {
                            setDetailView({
                              type: 'status',
                              data: {
                                status: `${bucket.label} (${bucket.sublabel})`,
                                invoices: bucket.data.invoices,
                                total: bucket.data.amount
                              }
                            });
                          }
                        }}
                      >
                        <div style={{
                          width: '100%',
                          height: '120px',
                          display: 'flex',
                          alignItems: 'flex-end',
                          marginBottom: '0.75rem'
                        }}>
                          <div style={{
                            width: '100%',
                            height: `${bucket.data.amount > 0 ? Math.max((bucket.data.amount / maxAging) * 100, 10) : 0}%`,
                            background: bucket.data.count > 0 ? `linear-gradient(to top, ${bucket.color}, ${bucket.color}dd)` : '#e5e7eb',
                            borderRadius: '8px 8px 0 0',
                            transition: 'all 0.3s',
                            position: 'relative'
                          }}
                          onMouseEnter={(e) => {
                            if (bucket.data.count > 0) {
                              e.target.style.filter = 'brightness(1.1)';
                              e.target.style.transform = 'scaleY(1.05)';
                            }
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.filter = 'brightness(1)';
                            e.target.style.transform = 'scaleY(1)';
                          }}
                          title={`${bucket.label}: $${bucket.data.amount.toFixed(2)} (${bucket.data.count} invoice${bucket.data.count !== 1 ? 's' : ''})`}
                          ></div>
                        </div>
                        <div style={{textAlign: 'center'}}>
                          <div style={{fontSize: '0.75rem', fontWeight: '600', color: 'var(--text)', marginBottom: '0.25rem'}}>
                            {bucket.label}
                          </div>
                          <div style={{fontSize: '0.65rem', color: 'var(--text-muted)', marginBottom: '0.5rem'}}>
                            {bucket.sublabel}
                          </div>
                          <div style={{fontSize: '1rem', fontWeight: '700', color: bucket.color}}>
                            ${bucket.data.amount.toFixed(0)}
                          </div>
                          <div style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>
                            {bucket.data.count} invoice{bucket.data.count !== 1 ? 's' : ''}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  {totalOutstanding > 0 && (
                    <div style={{
                      marginTop: '1.5rem',
                      padding: '1rem',
                      background: totalOutstanding > 500 ? '#fef2f2' : '#f0fdf4',
                      borderRadius: '8px',
                      borderLeft: `4px solid ${totalOutstanding > 500 ? '#ef4444' : '#22c55e'}`
                    }}>
                      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <span style={{fontWeight: '600', color: 'var(--text)'}}>Total Outstanding:</span>
                        <span style={{fontSize: '1.5rem', fontWeight: '700', color: totalOutstanding > 500 ? '#ef4444' : '#22c55e'}}>
                          ${totalOutstanding.toFixed(2)}
                        </span>
                      </div>
                    </div>
                  )}
                </div>
              </div>

              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1.5rem'}}>
                {/* Top Customers */}
                <div className="card">
                  <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                    üë• Top 5 Customers <span style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontWeight: 'normal'}}>(click to view)</span>
                  </h3>
                  {topCustomers.length > 0 ? (
                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                      {topCustomers.map(([name, total], i) => {
                        const customerInvoices = filteredInvoices.filter(inv => inv.customerName === name && inv.status === 'paid');
                        return (
                          <div 
                            key={i} 
                            style={{
                              display: 'flex', 
                              justifyContent: 'space-between', 
                              alignItems: 'center', 
                              padding: '0.75rem', 
                              background: '#f9fafb', 
                              borderRadius: '8px',
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.background = '#dcfce7';
                              e.currentTarget.style.transform = 'translateX(4px)';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.background = '#f9fafb';
                              e.currentTarget.style.transform = 'translateX(0)';
                            }}
                            onClick={() => {
                              setDetailView({
                                type: 'customer',
                                data: {
                                  name,
                                  invoices: customerInvoices,
                                  total
                                }
                              });
                            }}
                          >
                            <div>
                              <div style={{fontWeight: '600'}}>{name}</div>
                              <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Rank #{i + 1} ‚Ä¢ {customerInvoices.length} invoice{customerInvoices.length !== 1 ? 's' : ''}</div>
                            </div>
                            <div style={{fontSize: '1.25rem', fontWeight: '700', color: '#16a34a'}}>
                              ${total.toFixed(2)}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <p style={{color: 'var(--text-muted)', textAlign: 'center', padding: '2rem'}}>
                      No customer data yet
                    </p>
                  )}
                </div>

                {/* Top Services */}
                <div className="card">
                  <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                    üîß Top 5 Services <span style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontWeight: 'normal'}}>(click to view)</span>
                  </h3>
                  {topServices.length > 0 ? (
                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                      {topServices.map(([service, revenue], i) => {
                        const serviceInvoices = filteredInvoices.filter(inv => 
                          inv.status === 'paid' && 
                          inv.items && 
                          inv.items.some(item => item.description === service)
                        );
                        return (
                          <div 
                            key={i} 
                            style={{
                              display: 'flex', 
                              justifyContent: 'space-between', 
                              alignItems: 'center', 
                              padding: '0.75rem', 
                              background: '#f9fafb', 
                              borderRadius: '8px',
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.background = '#dcfce7';
                              e.currentTarget.style.transform = 'translateX(4px)';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.background = '#f9fafb';
                              e.currentTarget.style.transform = 'translateX(0)';
                            }}
                            onClick={() => {
                              setDetailView({
                                type: 'service',
                                data: {
                                  service,
                                  invoices: serviceInvoices,
                                  total: revenue
                                }
                              });
                            }}
                          >
                            <div style={{flex: 1}}>
                              <div style={{fontWeight: '600', fontSize: '0.9rem'}}>{service}</div>
                              <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Rank #{i + 1} ‚Ä¢ {serviceInvoices.length} invoice{serviceInvoices.length !== 1 ? 's' : ''}</div>
                            </div>
                            <div style={{fontSize: '1.25rem', fontWeight: '700', color: '#16a34a'}}>
                              ${revenue.toFixed(2)}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <p style={{color: 'var(--text-muted)', textAlign: 'center', padding: '2rem'}}>
                      No service data yet
                    </p>
                  )}
                </div>
              </div>
            </>
          )}

          {/* Detail Modal */}
          {detailView && (
            <div className="modal-overlay" onClick={() => setDetailView(null)}>
              <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '800px'}}>
                <div className="modal-header">
                  <h2>
                    {detailView.type === 'month' && `üìÖ ${detailView.data.month} Invoices`}
                    {detailView.type === 'status' && `${detailView.data.status === 'paid' ? '‚úÖ' : '‚è≥'} ${detailView.data.status === 'paid' ? 'Paid' : 'Unpaid'} Invoices`}
                    {detailView.type === 'customer' && `üë§ ${detailView.data.name}`}
                    {detailView.type === 'service' && `üîß ${detailView.data.service}`}
                  </h2>
                  <button className="close-btn" onClick={() => setDetailView(null)}>√ó</button>
                </div>

                <div style={{padding: '1.5rem'}}>
                  {detailView.data.invoices.length === 0 ? (
                    <p style={{color: 'var(--text-muted)', textAlign: 'center', padding: '2rem'}}>
                      No invoices found
                    </p>
                  ) : (
                    <>
                      <div style={{marginBottom: '1rem', fontSize: '0.9rem', color: 'var(--text-muted)'}}>
                        {detailView.data.invoices.length} invoice{detailView.data.invoices.length !== 1 ? 's' : ''} ‚Ä¢ 
                        Total: <strong style={{color: 'var(--primary)'}}>${detailView.data.total.toFixed(2)}</strong>
                      </div>
                      <div style={{maxHeight: '400px', overflowY: 'auto'}}>
                        {detailView.data.invoices.map(inv => (
                          <div key={inv.id} style={{
                            padding: '1rem',
                            marginBottom: '0.75rem',
                            background: '#f9fafb',
                            borderRadius: '8px',
                            border: '1px solid #e5e7eb'
                          }}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '0.5rem'}}>
                              <div>
                                <div style={{fontWeight: '600', fontSize: '1rem'}}>{inv.invoiceNumber}</div>
                                <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>{inv.customerName}</div>
                              </div>
                              <div style={{textAlign: 'right'}}>
                                <div style={{fontSize: '1.25rem', fontWeight: '700', color: '#16a34a'}}>
                                  ${inv.total?.toFixed(2)}
                                </div>
                                <span className={`badge badge-${inv.status === 'paid' ? 'success' : 'warning'}`}>
                                  {inv.status}
                                </span>
                              </div>
                            </div>
                            <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>
                              {inv.createdAt?.toDate().toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric'
                              })}
                              {inv.paidAt && inv.status === 'paid' && (
                                <> ‚Ä¢ Paid: {inv.paidAt.toDate().toLocaleDateString('en-US', {
                                  month: 'short',
                                  day: 'numeric'
                                })}</>
                              )}
                            </div>
                            {inv.items && inv.items.length > 0 && (
                              <div style={{marginTop: '0.5rem', paddingTop: '0.5rem', borderTop: '1px solid #e5e7eb'}}>
                                {inv.items.map((item, idx) => (
                                  <div key={idx} style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                                    ‚Ä¢ {item.description} - ${parseFloat(item.amount || 0).toFixed(2)}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function AboutView() {
      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>
            About Farrier Pro
          </h1>

          <div className="card">
            <div style={{textAlign: 'center', padding: '2rem'}}>
              <div style={{fontSize: '4rem', marginBottom: '1rem'}}>üê¥</div>
              <h2 style={{fontSize: '2rem', marginBottom: '0.5rem', color: 'var(--primary)'}}>
                Farrier Pro
              </h2>
              <p style={{fontSize: '1.25rem', color: 'var(--text-muted)', marginBottom: '2rem'}}>
                Professional Farrier Management Platform
              </p>
              
              <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white',
                padding: '1.5rem',
                borderRadius: '8px',
                marginBottom: '2rem'
              }}>
                <div style={{fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem'}}>
                  Version 1.0.0
                </div>
                <div style={{fontSize: '0.875rem', opacity: 0.9}}>
                  Released January 2026
                </div>
              </div>

              <div style={{
                background: '#f8f9fa',
                padding: '2rem',
                borderRadius: '8px',
                marginBottom: '2rem'
              }}>
                <h3 style={{fontSize: '1.25rem', marginBottom: '1rem', color: 'var(--primary)'}}>
                  üìû Support
                </h3>
                <p style={{fontSize: '1.125rem', color: 'var(--text)', marginBottom: '0.5rem'}}>
                  Need help? We're here for you!
                </p>
                <a 
                  href="tel:954-673-3041"
                  style={{
                    fontSize: '1.5rem',
                    fontWeight: 'bold',
                    color: 'var(--primary)',
                    textDecoration: 'none',
                    display: 'inline-block',
                    padding: '0.75rem 1.5rem',
                    background: 'white',
                    borderRadius: '8px',
                    border: '2px solid var(--primary)',
                    marginTop: '0.5rem'
                  }}
                >
                  üì± (954) 673-3041
                </a>
                <p style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginTop: '1rem'}}>
                  Monday - Friday: 9:00 AM - 5:00 PM EST
                </p>
              </div>

              <div style={{
                borderTop: '1px solid #e0e0e0',
                paddingTop: '2rem',
                marginTop: '2rem'
              }}>
                <h3 style={{fontSize: '1.25rem', marginBottom: '1rem', color: 'var(--primary)'}}>
                  ‚ú® Features
                </h3>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                  gap: '1rem',
                  textAlign: 'left'
                }}>
                  <div>
                    <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>üì±</div>
                    <div style={{fontWeight: '500', marginBottom: '0.25rem'}}>QR Code Booking</div>
                    <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Easy customer bookings</div>
                  </div>
                  <div>
                    <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>üìÖ</div>
                    <div style={{fontWeight: '500', marginBottom: '0.25rem'}}>Calendar Sync</div>
                    <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Google Calendar integration</div>
                  </div>
                  <div>
                    <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>üí∞</div>
                    <div style={{fontWeight: '500', marginBottom: '0.25rem'}}>Invoicing</div>
                    <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Professional invoices</div>
                  </div>
                  <div>
                    <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>‚è∞</div>
                    <div style={{fontWeight: '500', marginBottom: '0.25rem'}}>Availability</div>
                    <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Smart scheduling</div>
                  </div>
                </div>
              </div>

              <div style={{
                borderTop: '1px solid #e0e0e0',
                paddingTop: '2rem',
                marginTop: '2rem',
                color: 'var(--text-muted)',
                fontSize: '0.875rem'
              }}>
                <p style={{marginBottom: '0.5rem'}}>
                  ¬© 2026 Farrier Pro. All rights reserved.
                </p>
                <p style={{fontSize: '0.75rem'}}>
                  Built with ‚ù§Ô∏è for professional farriers
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function QRCodeView({ user, userProfile, connectGoogleCalendar, disconnectGoogleCalendar }) {
      const bookingUrl = window.location.origin + window.location.pathname + '?farrier=' + user.uid;
      
      // Use Google Charts API for QR code as backup
      const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(bookingUrl)}&color=2D5016&bgcolor=FFFFFF`;

      const downloadQR = () => {
        const link = document.createElement('a');
        link.download = 'farrier-booking-qr.png';
        link.href = qrImageUrl;
        link.click();
      };

      const copyLink = () => {
        navigator.clipboard.writeText(bookingUrl);
        alert('Booking link copied to clipboard!');
      };

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>
            Your Personal QR Code & Booking Link
          </h1>

          {/* Google Calendar Status */}
          <div className="calendar-status">
            <div className={`status-indicator ${userProfile?.googleCalendarConnected ? 'connected' : 'disconnected'}`}></div>
            <span>
              Google Calendar: {userProfile?.googleCalendarConnected ? 'Connected ‚úì' : 'Not Connected'}
            </span>
            {!userProfile?.googleCalendarConnected ? (
              <button 
                className="btn btn-sm btn-google" 
                onClick={connectGoogleCalendar}
                style={{marginLeft: 'auto'}}
              >
                Connect Google Calendar
              </button>
            ) : (
              <button 
                className="btn btn-sm btn-outline" 
                onClick={disconnectGoogleCalendar}
                style={{marginLeft: 'auto'}}
              >
                üîå Disconnect
              </button>
            )}
          </div>

          <div className="qr-section">
            <h2 style={{fontSize: '1.75rem', marginBottom: '1rem'}}>
              üöó Put This QR Code on Your Vehicle
            </h2>
            <p style={{opacity: 0.9, marginBottom: '1rem'}}>
              Customers can scan this code to book appointments instantly
            </p>

            <div className="qr-code-container">
              <img src={qrImageUrl} alt="QR Code" style={{display: 'block', maxWidth: '100%'}} />
            </div>

            <div style={{display: 'flex', gap: '1rem', justifyContent: 'center', flexWrap: 'wrap'}}>
              <button className="btn btn-success" onClick={downloadQR}>
                üì• Download QR Code
              </button>
              <button className="btn btn-secondary" onClick={copyLink}>
                üìã Copy Booking Link
              </button>
            </div>

            <div className="booking-link">
              {bookingUrl}
            </div>
          </div>

          <div className="card">
            <h2>How to Use Your QR Code</h2>
            <ol style={{paddingLeft: '1.5rem', lineHeight: '2'}}>
              <li><strong>Download</strong> the QR code image above</li>
              <li><strong>Print</strong> it on a sticker or magnetic sign</li>
              <li><strong>Place</strong> it on your vehicle, business cards, or flyers</li>
              <li><strong>Customers scan</strong> with their phone camera</li>
              <li><strong>They book</strong> appointments directly!</li>
            </ol>
            <p style={{marginTop: '1rem', color: 'var(--text-muted)'}}>
              üí° Tip: Print multiple copies for your truck, trailer, and business cards. The more visible, the more bookings!
            </p>
          </div>
        </div>
      );
    }

    function CustomerBookingView({ farrierId }) {
      const [step, setStep] = useState('landing');
      const [farrierInfo, setFarrierInfo] = useState(null);
      const [loading, setLoading] = useState(true);
      const [formData, setFormData] = useState({
        name: '',
        phone: '',
        email: '',
        services: [], // Multiple services
        numberOfHorses: '',
        address: '',
        city: '',
        state: '',
        zip: '',
        comments: '',
        date: '',
        time: ''
      });

      useEffect(() => {
        loadFarrierInfo();
      }, []);

      const loadFarrierInfo = async () => {
        try {
          if (db) {
            const doc = await db.collection('farriers').doc(farrierId).get();
            if (doc.exists) {
              setFarrierInfo(doc.data());
            }
          } else {
            // Demo mode
            setFarrierInfo({
              businessName: "Demo Farrier Services",
              email: "demo@farrier.com"
            });
          }
        } catch (error) {
          console.error('Error loading farrier info:', error);
        }
        setLoading(false);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        
        try {
          if (db) {
            // Save appointment request to Firestore
            await db.collection('appointments').add({
              farrierId: farrierId,
              customerName: formData.name,
              phone: formData.phone,
              email: formData.email,
              services: formData.services,
              numberOfHorses: formData.numberOfHorses,
              address: formData.address,
              city: formData.city,
              state: formData.state,
              zip: formData.zip,
              comments: formData.comments,
              requestedDate: formData.date,
              requestedTime: formData.time,
              status: 'pending',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Auto-create customer account
            try {
              // Check if customer account already exists
              const existingCustomer = await db.collection('customers')
                .where('email', '==', formData.email)
                .limit(1)
                .get();

              if (existingCustomer.empty) {
                // Create new customer profile (without Firebase Auth for now)
                // We'll let them sign up via portal or Google when they need to pay
                await db.collection('customers').add({
                  name: formData.name,
                  email: formData.email,
                  phone: formData.phone,
                  address: `${formData.address}, ${formData.city}, ${formData.state} ${formData.zip}`.trim(),
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  source: 'qr_booking'
                });
                console.log('‚úÖ Customer profile created');
              } else {
                console.log('‚úÖ Customer already exists');
              }
            } catch (error) {
              console.error('Note: Could not create customer profile:', error);
              // Don't fail the booking if customer creation fails
            }

            // If Google Calendar is connected, create event
            // (This would be done server-side in production)
          }
          
          setStep('success');
        } catch (error) {
          console.error('Error submitting booking:', error);
          alert('Error submitting booking. Please try again.');
        }
      };

      const services = [
        'Routine Trim',
        'Shoeing (All 4)',
        'Shoeing (Front Only)',
        'Corrective Shoeing',
        'Hoof Care Consultation'
      ];

      // Convert 24-hour time to 12-hour AM/PM format
      const formatTime = (time24) => {
        const [hours, minutes] = time24.split(':').map(Number);
        const period = hours >= 12 ? 'PM' : 'AM';
        const hours12 = hours % 12 || 12; // Convert 0 to 12 for midnight
        return `${hours12}:${String(minutes).padStart(2, '0')} ${period}`;
      };

      // Generate time slots based on farrier's availability for selected date
      const getAvailableSlots = () => {
        if (!formData.date) {
          return []; // No slots until date is selected
        }

        // Parse date correctly to avoid timezone issues
        // formData.date is in format "YYYY-MM-DD"
        const [year, month, day] = formData.date.split('-').map(Number);
        const selectedDate = new Date(year, month - 1, day); // Create date in local timezone
        const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
        
        console.log('Selected date:', formData.date);
        console.log('Parsed as:', selectedDate);
        console.log('Day name:', dayName);
        
        // Default availability if farrier hasn't set it up yet (Mon-Fri 9-5)
        const defaultAvailability = {
          monday: { enabled: true, start: '09:00', end: '17:00' },
          tuesday: { enabled: true, start: '09:00', end: '17:00' },
          wednesday: { enabled: true, start: '09:00', end: '17:00' },
          thursday: { enabled: true, start: '09:00', end: '17:00' },
          friday: { enabled: true, start: '09:00', end: '17:00' },
          saturday: { enabled: false, start: '09:00', end: '17:00' },
          sunday: { enabled: false, start: '09:00', end: '17:00' }
        };

        const availability = farrierInfo?.availability || defaultAvailability;
        const dayAvailability = availability[dayName];

        console.log('Day availability:', dayAvailability);

        if (!dayAvailability || !dayAvailability.enabled) {
          return []; // No slots if farrier doesn't work this day
        }

        // Generate 2-hour slots from start to end time
        const slots = [];
        const [startHour, startMin] = dayAvailability.start.split(':').map(Number);
        const [endHour, endMin] = dayAvailability.end.split(':').map(Number);
        
        let currentHour = startHour;
        let currentMin = startMin;
        
        while (currentHour < endHour || (currentHour === endHour && currentMin < endMin)) {
          const timeStr = `${String(currentHour).padStart(2, '0')}:${String(currentMin).padStart(2, '0')}`;
          slots.push(timeStr);
          
          // Add 2 hours for next slot
          currentMin += 120;
          currentHour += Math.floor(currentMin / 60);
          currentMin = currentMin % 60;
        }

        console.log('Generated slots:', slots);
        return slots;
      };

      const availableSlots = getAvailableSlots();

      if (loading) {
        return (
          <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}>
            <div className="spinner"></div>
          </div>
        );
      }

      if (!farrierInfo) {
        return (
          <div className="app-container">
            <div className="main-content">
              <div className="error-message">
                Farrier not found. Please check your QR code or booking link.
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="app-container">
          <header className="app-header">
            <div className="header-content">
              <div className="logo">
                <span className="logo-icon">üê¥</span>
                <span>{farrierInfo.businessName}</span>
              </div>
              <a 
                href={window.location.origin + '/customer-portal.html'}
                style={{
                  padding: '0.5rem 1rem',
                  background: 'var(--primary)',
                  color: 'white',
                  borderRadius: '8px',
                  textDecoration: 'none',
                  fontSize: '0.9rem',
                  fontWeight: '500',
                  display: 'inline-flex',
                  alignItems: 'center',
                  gap: '0.5rem',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => e.target.style.background = 'var(--primary-dark)'}
                onMouseOut={(e) => e.target.style.background = 'var(--primary)'}
              >
                üí≥ Pay Invoices
              </a>
            </div>
          </header>

          <main className="main-content">
            {step === 'success' ? (
              <div style={{textAlign: 'center', padding: '2rem'}}>
                <div className="success-message">
                  ‚úì Appointment Request Sent Successfully!
                </div>
                <div className="card">
                  <h2>What's Next?</h2>
                  <p style={{marginBottom: '1rem'}}>
                    Your appointment request has been sent. You'll receive an SMS confirmation once it's approved.
                  </p>
                  <div style={{marginBottom: '1rem', color: 'var(--text-muted)', textAlign: 'left'}}>
                    <strong>Booking Details:</strong><br/>
                    {formData.services.length > 0 && (
                      <>Services: {formData.services.join(', ')}<br/></>
                    )}
                    {formData.numberOfHorses && (
                      <>Number of Horses: {formData.numberOfHorses}<br/></>
                    )}
                    Date: {formData.date} at {formData.time}<br/>
                    {formData.address && (
                      <>
                        Location: {formData.address}
                        {formData.city && `, ${formData.city}`}
                        {formData.state && `, ${formData.state}`}
                        {formData.zip && ` ${formData.zip}`}
                        <br/>
                      </>
                    )}
                  </div>

                  <div style={{
                    background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)',
                    padding: '1.5rem',
                    borderRadius: '12px',
                    marginTop: '1.5rem',
                    marginBottom: '1.5rem',
                    textAlign: 'left'
                  }}>
                    <div style={{fontSize: '1.1rem', fontWeight: '600', marginBottom: '0.5rem', color: 'var(--primary)'}}>
                      üéâ Your Customer Account is Ready!
                    </div>
                    <p style={{fontSize: '0.9rem', marginBottom: '0.75rem', color: 'var(--text)'}}>
                      We've created an account for you. You can now view invoices and pay online!
                    </p>
                    <p style={{fontSize: '0.85rem', marginBottom: '0.5rem', color: 'var(--text-muted)'}}>
                      <strong>Portal:</strong> {window.location.origin}/customer-portal.html
                    </p>
                    <p style={{fontSize: '0.85rem', color: 'var(--text-muted)'}}>
                      <strong>Email:</strong> {formData.email}
                    </p>
                    <button 
                      className="btn btn-success"
                      style={{width: '100%', marginTop: '1rem'}}
                      onClick={() => {
                        window.location.href = window.location.origin + '/customer-portal.html';
                      }}
                    >
                      Go to Customer Portal
                    </button>
                  </div>

                  <button className="btn btn-primary" onClick={() => {
                    setStep('landing');
                    setFormData({
                      name: '',
                      phone: '',
                      email: '',
                      services: [],
                      numberOfHorses: '',
                      address: '',
                      city: '',
                      state: '',
                      zip: '',
                      comments: '',
                      date: '',
                      time: ''
                    });
                  }}>
                    Book Another Appointment
                  </button>
                </div>
              </div>
            ) : (
              <div style={{textAlign: 'center'}}>
                <div className="hero">
                  <h1>üê¥ {farrierInfo.businessName}</h1>
                  <p>Professional hoof care for your horses. Book your appointment below.</p>
                </div>

                <div className="card" style={{textAlign: 'left', maxWidth: '600px', margin: '0 auto'}}>
                  <h2>Book Your Appointment</h2>
                  <form onSubmit={handleSubmit}>
                    <div className="form-group">
                      <label>Name *</label>
                      <input 
                        type="text" 
                        required 
                        value={formData.name}
                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                        placeholder="Your name"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Phone Number *</label>
                      <input 
                        type="tel" 
                        required 
                        value={formData.phone}
                        onChange={(e) => setFormData({...formData, phone: e.target.value})}
                        placeholder="(555) 555-5555"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Email</label>
                      <input 
                        type="email" 
                        value={formData.email}
                        onChange={(e) => setFormData({...formData, email: e.target.value})}
                        placeholder="your@email.com"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Services Needed</label>
                      <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                        {services.map(service => (
                          <label key={service} style={{display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer'}}>
                            <input 
                              type="checkbox"
                              checked={formData.services.includes(service)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setFormData({...formData, services: [...formData.services, service]});
                                } else {
                                  setFormData({...formData, services: formData.services.filter(s => s !== service)});
                                }
                              }}
                              style={{width: 'auto', margin: 0}}
                            />
                            <span style={{fontWeight: 'normal'}}>{service}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                    
                    <div className="form-group">
                      <label>Number of Horses</label>
                      <input 
                        type="number" 
                        value={formData.numberOfHorses}
                        onChange={(e) => setFormData({...formData, numberOfHorses: e.target.value})}
                        placeholder="1"
                        min="1"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Address</label>
                      <input 
                        type="text" 
                        value={formData.address}
                        onChange={(e) => setFormData({...formData, address: e.target.value})}
                        placeholder="123 Main Street"
                      />
                    </div>
                    
                    <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem'}}>
                      <div className="form-group">
                        <label>City</label>
                        <input 
                          type="text" 
                          value={formData.city}
                          onChange={(e) => setFormData({...formData, city: e.target.value})}
                          placeholder="City"
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>State</label>
                        <input 
                          type="text" 
                          value={formData.state}
                          onChange={(e) => setFormData({...formData, state: e.target.value})}
                          placeholder="VA"
                          maxLength="2"
                          style={{textTransform: 'uppercase'}}
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>ZIP</label>
                        <input 
                          type="text" 
                          value={formData.zip}
                          onChange={(e) => setFormData({...formData, zip: e.target.value})}
                          placeholder="12345"
                          maxLength="5"
                        />
                      </div>
                    </div>
                    
                    <div className="form-group">
                      <label>Comments or Special Requests</label>
                      <textarea 
                        value={formData.comments}
                        onChange={(e) => setFormData({...formData, comments: e.target.value})}
                        placeholder="Any special notes, concerns, or requests..."
                        rows="4"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Preferred Date *</label>
                      <input 
                        type="date" 
                        required 
                        value={formData.date}
                        onChange={(e) => setFormData({...formData, date: e.target.value, time: ''})}
                        min={new Date().toISOString().split('T')[0]}
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Available Time Slots *</label>
                      {formData.date ? (
                        availableSlots.length > 0 ? (
                          <div className="time-slots">
                            {availableSlots.map(slot => (
                              <div 
                                key={slot}
                                className={`time-slot ${formData.time === slot ? 'selected' : ''}`}
                                onClick={() => setFormData({...formData, time: slot})}
                              >
                                {formatTime(slot)}
                              </div>
                            ))}
                          </div>
                        ) : (
                          <p style={{color: '#999', fontStyle: 'italic', padding: '1rem', background: '#f5f5f5', borderRadius: '4px'}}>
                            ‚ö†Ô∏è Farrier is not available on this day. Please select a different date.
                          </p>
                        )
                      ) : (
                        <p style={{color: '#999', fontStyle: 'italic', padding: '1rem', background: '#f5f5f5', borderRadius: '4px'}}>
                          üìÖ Please select a date first to see available time slots.
                        </p>
                      )}
                    </div>
                    
                    <button 
                      type="submit" 
                      className="btn btn-success" 
                      style={{width: '100%', marginTop: '1rem'}} 
                      disabled={!formData.time}
                    >
                      Request Appointment
                    </button>
                  </form>
                </div>
              </div>
            )}
          </main>
        </div>
      );
    }

    function DashboardView({ userId }) {
      const kpis = [
        { label: 'Appointments This Month', value: '24', change: '+12%', positive: true },
        { label: 'Total Revenue', value: '$4,800', change: '+18%', positive: true },
        { label: 'Outstanding Invoices', value: '$650', change: '-5%', positive: true },
        { label: 'This Week', value: '6', change: 'Upcoming', positive: true }
      ];

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Dashboard Overview</h1>
          
          <div className="dashboard-grid">
            {kpis.map((kpi, idx) => (
              <div key={idx} className="stat-card">
                <div className="stat-label">{kpi.label}</div>
                <div className="stat-value">{kpi.value}</div>
                <div className={`stat-change ${kpi.positive ? 'positive' : ''}`}>
                  {kpi.change}
                </div>
              </div>
            ))}
          </div>

          <div className="card">
            <h2>Recent Activity</h2>
            <p style={{color: 'var(--text-muted)'}}>
              Your appointments and bookings will appear here once customers start booking through your QR code!
            </p>
          </div>
        </div>
      );
    }

    function CalendarView({ userId }) {
      const [currentDate, setCurrentDate] = useState(new Date());
      
      const daysInMonth = new Date(
        currentDate.getFullYear(),
        currentDate.getMonth() + 1,
        0
      ).getDate();

      const firstDay = new Date(
        currentDate.getFullYear(),
        currentDate.getMonth(),
        1
      ).getDay();

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

      const days = [];
      for (let i = 0; i < firstDay; i++) {
        days.push(<div key={`empty-${i}`} className="calendar-day"></div>);
      }
      for (let i = 1; i <= daysInMonth; i++) {
        const isToday = i === new Date().getDate() && 
                        currentDate.getMonth() === new Date().getMonth();
        days.push(
          <div 
            key={i} 
            className={`calendar-day ${isToday ? 'today' : ''}`}
          >
            {i}
          </div>
        );
      }

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Calendar</h1>
          
          <div className="calendar">
            <div className="calendar-header">
              <h2 className="calendar-title">
                {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
              </h2>
              <div className="calendar-nav">
                <button className="btn btn-sm btn-outline" onClick={() => {
                  const newDate = new Date(currentDate);
                  newDate.setMonth(newDate.getMonth() - 1);
                  setCurrentDate(newDate);
                }}>
                  ‚Üê
                </button>
                <button className="btn btn-sm btn-outline" onClick={() => {
                  const newDate = new Date(currentDate);
                  newDate.setMonth(newDate.getMonth() + 1);
                  setCurrentDate(newDate);
                }}>
                  ‚Üí
                </button>
              </div>
            </div>

            <div className="calendar-grid">
              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                <div key={day} className="calendar-day header">{day}</div>
              ))}
              {days}
            </div>
          </div>

          <div className="card" style={{marginTop: '1.5rem'}}>
            <h2>Synced with Google Calendar</h2>
            <p style={{color: 'var(--text-muted)'}}>
              All appointments automatically sync to your Google Calendar. Updates made here or in Google Calendar will sync both ways.
            </p>
          </div>
        </div>
      );
    }

    function AppointmentsView({ userId, userProfile }) {
      const [appointments, setAppointments] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        loadAppointments();
      }, []);

      const loadAppointments = async () => {
        if (db) {
          try {
            const snapshot = await db.collection('appointments')
              .where('farrierId', '==', userId)
              .get();
            
            const appointmentData = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            
            // Sort in JavaScript instead of Firestore
            appointmentData.sort((a, b) => {
              const dateA = new Date(a.requestedDate);
              const dateB = new Date(b.requestedDate);
              return dateB - dateA; // Newest first
            });
            
            setAppointments(appointmentData);
            console.log('‚úÖ Loaded appointments:', appointmentData.length);
          } catch (error) {
            console.error('‚ùå Error loading appointments:', error);
          }
        }
        setLoading(false);
      };

      const createCalendarEvent = async (appointment, userProfile) => {
        console.log('=== CREATE CALENDAR EVENT START ===');
        console.log('UserProfile:', userProfile);
        console.log('Appointment:', appointment);
        
        if (!userProfile?.googleCalendarConnected || !userProfile?.googleAccessToken) {
          console.error('‚ùå Calendar not connected or no token');
          alert('Please connect Google Calendar first in the "My QR Code" tab');
          return false;
        }

        console.log('‚úÖ Calendar connected, token exists');

        try {
          // Use existing access token (no refresh for now)
          const accessToken = userProfile.googleAccessToken;
          console.log('üîë Using access token');
          
          // Create calendar event
          const eventStartTime = new Date(`${appointment.requestedDate}T${appointment.requestedTime}:00`);
          const eventEndTime = new Date(eventStartTime.getTime() + 2 * 60 * 60 * 1000); // 2 hours later

          console.log('üìÖ Event times:', {
            start: eventStartTime.toISOString(),
            end: eventEndTime.toISOString()
          });

          // Build services list
          let servicesList = '';
          if (appointment.services && appointment.services.length > 0) {
            servicesList = appointment.services.map(s => `   ‚Ä¢ ${s}`).join('\n');
          } else {
            servicesList = '   (No services specified)';
          }

          const event = {
            summary: `üê¥ Farrier - ${appointment.customerName}`,
            description: `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã APPOINTMENT DETAILS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üë§ CUSTOMER INFORMATION:
   Name: ${appointment.customerName}
   Phone: ${appointment.phone}
${appointment.email ? `   Email: ${appointment.email}` : ''}

üîß SERVICES REQUESTED:
${servicesList}

üê¥ HORSES:
${appointment.numberOfHorses ? `   Number of Horses: ${appointment.numberOfHorses}` : '   (Not specified)'}

üìç LOCATION:
${appointment.address ? `   ${appointment.address}\n   ${appointment.city}${appointment.state ? `, ${appointment.state}` : ''}${appointment.zip ? ` ${appointment.zip}` : ''}` : '   (No address provided)'}

üí¨ SPECIAL REQUESTS/NOTES:
${appointment.comments ? `   ${appointment.comments}` : '   (None)'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚è∞ Scheduled: ${appointment.requestedDate} at ${appointment.requestedTime}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
            location: appointment.address ? `${appointment.address}, ${appointment.city}${appointment.state ? `, ${appointment.state}` : ''}${appointment.zip ? ` ${appointment.zip}` : ''}` : '',
            start: {
              dateTime: eventStartTime.toISOString(),
              timeZone: 'America/New_York'
            },
            end: {
              dateTime: eventEndTime.toISOString(),
              timeZone: 'America/New_York'
            }
          };

          console.log('üì§ Sending event to Google Calendar:', event);

          const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(event)
          });

          console.log('üì• Response status:', response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error('‚ùå Calendar API error:', errorData);
            throw new Error(`Failed to create calendar event: ${errorData.error?.message || 'Unknown error'}`);
          }

          const data = await response.json();
          console.log('‚úÖ Calendar event created successfully!', data);
          
          // Save event ID to appointment
          if (db) {
            await db.collection('appointments').doc(appointment.id).update({
              googleEventId: data.id
            });
            console.log('‚úÖ Saved event ID to appointment');
          }

          return true;
        } catch (error) {
          console.error('‚ùå Calendar error:', error);
          alert('Could not add to calendar. Error: ' + error.message + '\n\nCheck console for details. Your connection may have expired - try reconnecting.');
          return false;
        }
      };

      const deleteCalendarEvent = async (appointment, userProfile) => {
        console.log('üóëÔ∏è DELETE CALENDAR EVENT START');
        
        if (!appointment.googleEventId) {
          console.log('‚ö†Ô∏è No Google Event ID found - event may not be in calendar');
          return true; // Not an error, just wasn't synced yet
        }
        
        if (!userProfile?.googleCalendarConnected || !userProfile?.googleAccessToken) {
          console.error('‚ùå Calendar not connected');
          return false;
        }

        try {
          // Use existing access token (no refresh for now)
          const accessToken = userProfile.googleAccessToken;
          
          console.log('üóëÔ∏è Deleting event from Google Calendar:', appointment.googleEventId);
          
          const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events/${appointment.googleEventId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });

          if (response.ok || response.status === 404) {
            console.log('‚úÖ Calendar event deleted successfully!');
            return true;
          } else {
            console.error('‚ùå Failed to delete calendar event:', response.status);
            return false;
          }
        } catch (error) {
          console.error('‚ùå Calendar deletion error:', error);
          return false;
        }
      };

      const updateStatus = async (appointmentId, newStatus) => {
        console.log('üîµ updateStatus called:', { appointmentId, newStatus });
        
        if (db) {
          await db.collection('appointments').doc(appointmentId).update({
            status: newStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          console.log('‚úÖ Status updated in Firebase');
          
          const appointment = appointments.find(apt => apt.id === appointmentId);
          
          // If confirming, add to Google Calendar
          if (newStatus === 'confirmed') {
            console.log('üü¢ Status is confirmed, attempting calendar sync...');
            console.log('üìã Found appointment:', appointment);
            console.log('üë§ UserProfile:', userProfile);
            
            if (appointment) {
              const success = await createCalendarEvent(appointment, userProfile);
              if (success) {
                alert('‚úì Appointment confirmed and added to your Google Calendar!');
              } else {
                alert('‚ö†Ô∏è Appointment confirmed, but failed to add to Google Calendar. Check console for details.');
              }
            } else {
              console.error('‚ùå Appointment not found in local state');
            }
          }
          
          // If cancelling, remove from Google Calendar
          if (newStatus === 'cancelled') {
            console.log('üî¥ Status is cancelled, removing from calendar...');
            
            if (appointment) {
              const deleted = await deleteCalendarEvent(appointment, userProfile);
              if (deleted) {
                alert('‚úì Appointment cancelled and removed from your Google Calendar!');
              } else {
                alert('‚ö†Ô∏è Appointment cancelled in app, but may still be in Google Calendar. You may need to remove it manually.');
              }
            }
          }
          
          loadAppointments();
        }
      };

      const sendReminder = (appointment) => {
        const message = `Hi ${appointment.customerName}! Reminder: Your farrier appointment is on ${appointment.requestedDate} at ${appointment.requestedTime}. ${appointment.address ? 'Location: ' + appointment.address : ''}`;
        alert(`SMS would be sent to ${appointment.phone}:\n\n${message}`);
      };

      if (loading) {
        return (
          <div style={{display: 'flex', justifyContent: 'center', padding: '3rem'}}>
            <div className="spinner"></div>
          </div>
        );
      }

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Appointments</h1>
          
          {appointments.length === 0 ? (
            <div className="card">
              <h2>No Appointments Yet</h2>
              <p style={{color: 'var(--text-muted)'}}>
                Appointments booked through your QR code will appear here. Share your QR code to start receiving bookings!
              </p>
            </div>
          ) : (
            <div className="card">
              <h2>Your Appointments ({appointments.length})</h2>
              <div className="appointments-list">
                {appointments.map(apt => (
                  <div key={apt.id} className="appointment-item">
                    <div className="appointment-info">
                      <div className="appointment-customer">{apt.customerName}</div>
                      <div className="appointment-details">
                        üìû {apt.phone} {apt.email && `‚Ä¢ ‚úâÔ∏è ${apt.email}`}<br/>
                        üìÖ {apt.requestedDate} at {apt.requestedTime}<br/>
                        {apt.services && apt.services.length > 0 && (
                          <>üîß Services: {apt.services.join(', ')}<br/></>
                        )}
                        {apt.numberOfHorses && (
                          <>üê¥ Horses: {apt.numberOfHorses}<br/></>
                        )}
                        {apt.address && (
                          <>üìç {apt.address}, {apt.city}, {apt.state} {apt.zip}<br/></>
                        )}
                        {apt.comments && (
                          <>üí¨ Notes: {apt.comments}<br/></>
                        )}
                        <small style={{color: 'var(--text-muted)'}}>
                          Requested: {apt.createdAt?.toDate().toLocaleDateString()}
                        </small>
                      </div>
                    </div>
                    <div className="appointment-actions">
                      <span className={`badge badge-${apt.status === 'confirmed' ? 'success' : apt.status === 'pending' ? 'warning' : 'pending'}`}>
                        {apt.status || 'pending'}
                      </span>
                      {apt.status !== 'confirmed' && (
                        <button 
                          className="btn btn-sm btn-success"
                          onClick={() => updateStatus(apt.id, 'confirmed')}
                        >
                          ‚úì Confirm
                        </button>
                      )}
                      <button 
                        className="btn btn-sm btn-warning"
                        onClick={() => sendReminder(apt)}
                      >
                        üì± Send Reminder
                      </button>
                      {apt.status !== 'cancelled' && (
                        <button 
                          className="btn btn-sm btn-outline"
                          onClick={() => updateStatus(apt.id, 'cancelled')}
                        >
                          ‚úï Cancel
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    function InvoicesView({ userId }) {
      const [invoices, setInvoices] = useState([]);
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showPaymentModal, setShowPaymentModal] = useState(false);
      const [selectedInvoice, setSelectedInvoice] = useState(null);
      const [loading, setLoading] = useState(false);
      const [showCancelModal, setShowCancelModal] = useState(false);
      const [cancelPassword, setCancelPassword] = useState('');

      useEffect(() => {
        loadInvoices();
      }, []);

      const loadInvoices = async () => {
        console.log('üîµ Loading invoices for userId:', userId);
        if (db) {
          const snapshot = await db.collection('invoices')
            .where('farrierId', '==', userId)
            .get();
          
          console.log('üìã Found invoices:', snapshot.docs.length);
          
          const invoiceData = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          // Sort in JavaScript instead of Firestore
          invoiceData.sort((a, b) => {
            if (!a.createdAt || !b.createdAt) return 0;
            return b.createdAt.toDate() - a.createdAt.toDate();
          });
          
          console.log('‚úÖ Loaded invoices:', invoiceData);
          setInvoices(invoiceData);
        } else {
          console.error('‚ùå Database not initialized');
        }
      };

      const handleCancelInvoice = async () => {
        // Generate today's password (MMDDYYYY format)
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const year = today.getFullYear();
        const correctPassword = `${month}${day}${year}`;

        if (cancelPassword !== correctPassword) {
          alert(`‚ùå Incorrect password. Today's password is MMDDYYYY format (e.g., ${correctPassword.slice(0,2)}${correctPassword.slice(2,4)}${correctPassword.slice(4)})`);
          return;
        }

        try {
          if (db && selectedInvoice) {
            await db.collection('invoices').doc(selectedInvoice.id).update({
              status: 'cancelled',
              cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
              cancelledBy: userId
            });

            alert('‚úÖ Invoice cancelled successfully');
            setShowCancelModal(false);
            setSelectedInvoice(null);
            setCancelPassword('');
            loadInvoices();
          }
        } catch (error) {
          console.error('Error cancelling invoice:', error);
          alert('‚ùå Error cancelling invoice');
        }
      };

      const totalCollected = invoices
        .filter(inv => inv.status === 'paid')
        .reduce((sum, inv) => sum + (inv.total || 0), 0);

      const totalOutstanding = invoices
        .filter(inv => inv.status === 'outstanding')
        .reduce((sum, inv) => sum + (inv.total || 0), 0);

      const totalCancelled = invoices
        .filter(inv => inv.status === 'cancelled')
        .reduce((sum, inv) => sum + (inv.total || 0), 0);

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Invoices & Payments</h1>
          
          <div className="dashboard-grid">
            <div className="stat-card">
              <div className="stat-label">Total Collected</div>
              <div className="stat-value" style={{color: 'var(--success)'}}>${totalCollected.toFixed(2)}</div>
            </div>
            <div className="stat-card">
              <div className="stat-label">Outstanding</div>
              <div className="stat-value" style={{color: 'var(--warning)'}}>${totalOutstanding.toFixed(2)}</div>
            </div>
            {totalCancelled > 0 && (
              <div className="stat-card">
                <div className="stat-label">Cancelled</div>
                <div className="stat-value" style={{color: '#6b7280'}}>${totalCancelled.toFixed(2)}</div>
              </div>
            )}
          </div>

          <div className="card">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem'}}>
              <h2 style={{marginBottom: 0}}>Your Invoices</h2>
              <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                + Create Invoice
              </button>
            </div>
            
            {invoices.length === 0 ? (
              <p style={{color: 'var(--text-muted)'}}>
                No invoices yet. Create your first invoice with Authorize.Net payment links!
              </p>
            ) : (
              <div className="appointments-list">
                {invoices.map(invoice => (
                  <div key={invoice.id} className="appointment-item">
                    <div className="appointment-info">
                      <div className="appointment-customer">
                        Invoice #{invoice.invoiceNumber} - {invoice.customerName}
                      </div>
                      <div className="appointment-details">
                        Amount: ${invoice.total?.toFixed(2)} ‚Ä¢ Created: {invoice.createdAt?.toDate().toLocaleDateString()}
                        {invoice.status === 'paid' && invoice.paidAt && (
                          <><br/>Paid: {invoice.paidAt?.toDate().toLocaleDateString()} 
                          {invoice.cardLast4 && <> ‚Ä¢ {invoice.cardType || 'Card'} {invoice.cardLast4}</>}
                          {invoice.transactionId && <> ‚Ä¢ Transaction: {invoice.transactionId}</>}
                          </>
                        )}
                        {invoice.paymentUrl && (
                          <><br/>Payment Link: <a href={invoice.paymentUrl} target="_blank" style={{color: 'var(--primary)'}}>View</a></>
                        )}
                      </div>
                    </div>
                    <div className="appointment-actions">
                      <span className={`badge badge-${
                        invoice.status === 'paid' ? 'success' : 
                        invoice.status === 'cancelled' ? 'secondary' : 
                        'warning'
                      }`}>
                        {invoice.status}
                      </span>
                      {invoice.status === 'outstanding' && (
                        <>
                          <button 
                            className="btn btn-sm btn-success"
                            onClick={() => {
                              setSelectedInvoice(invoice);
                              setShowPaymentModal(true);
                            }}
                          >
                            üí≥ Pay Now
                          </button>
                          <button 
                            className="btn btn-sm btn-danger"
                            onClick={() => {
                              setSelectedInvoice(invoice);
                              setShowCancelModal(true);
                            }}
                            style={{background: '#ef4444'}}
                          >
                            üö´ Cancel
                          </button>
                        </>
                      )}
                      {invoice.status === 'outstanding' && invoice.paymentUrl && (
                        <button 
                          className="btn btn-sm btn-warning"
                          onClick={() => {
                            const message = `Hi ${invoice.customerName}! Your invoice #${invoice.invoiceNumber} for $${invoice.total?.toFixed(2)} is ready. Pay here: ${invoice.paymentUrl}`;
                            alert(`SMS would be sent:\n\n${message}`);
                          }}
                        >
                          üì± Send Reminder
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {showCreateModal && (
            <InvoiceCreateModal 
              userId={userId}
              onClose={() => setShowCreateModal(false)}
              onCreated={() => {
                setShowCreateModal(false);
                loadInvoices();
              }}
            />
          )}

          {showPaymentModal && selectedInvoice && (
            <PaymentModal 
              invoice={selectedInvoice}
              onClose={() => {
                setShowPaymentModal(false);
                setSelectedInvoice(null);
              }}
              onPaymentSuccess={() => {
                setShowPaymentModal(false);
                setSelectedInvoice(null);
                loadInvoices();
              }}
            />
          )}

          {showCancelModal && selectedInvoice && (
            <div className="modal-overlay" onClick={() => setShowCancelModal(false)}>
              <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '500px'}}>
                <div className="modal-header">
                  <h2>üö´ Cancel Invoice</h2>
                  <button className="close-btn" onClick={() => setShowCancelModal(false)}>√ó</button>
                </div>

                <div style={{padding: '1.5rem'}}>
                  <div style={{
                    padding: '1rem',
                    background: '#fef2f2',
                    border: '1px solid #fecaca',
                    borderRadius: '8px',
                    marginBottom: '1.5rem'
                  }}>
                    <div style={{fontWeight: '600', marginBottom: '0.5rem'}}>
                      Invoice: {selectedInvoice.invoiceNumber}
                    </div>
                    <div style={{color: 'var(--text-muted)', fontSize: '0.9rem'}}>
                      Customer: {selectedInvoice.customerName}
                    </div>
                    <div style={{color: 'var(--text-muted)', fontSize: '0.9rem'}}>
                      Amount: ${selectedInvoice.total?.toFixed(2)}
                    </div>
                  </div>

                  <div style={{marginBottom: '1rem', color: '#991b1b', fontWeight: '500'}}>
                    ‚ö†Ô∏è This will mark the invoice as CANCELLED. It will remain in the system for records but cannot be paid.
                  </div>

                  <div className="form-group">
                    <label>Password (MMDDYYYY format) *</label>
                    <input 
                      type="password"
                      value={cancelPassword}
                      onChange={(e) => setCancelPassword(e.target.value)}
                      placeholder="Enter today's date (e.g., 01272026)"
                      autoFocus
                    />
                    <div style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                      Enter today's date in MMDDYYYY format
                    </div>
                  </div>

                  <div style={{display: 'flex', gap: '0.75rem', marginTop: '1.5rem'}}>
                    <button 
                      className="btn btn-outline"
                      onClick={() => {
                        setShowCancelModal(false);
                        setCancelPassword('');
                      }}
                      style={{flex: 1}}
                    >
                      Nevermind
                    </button>
                    <button 
                      className="btn"
                      onClick={handleCancelInvoice}
                      style={{flex: 1, background: '#ef4444', color: 'white'}}
                    >
                      Cancel Invoice
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function PaymentModal({ invoice, onClose, onPaymentSuccess }) {
      const [cardNumber, setCardNumber] = useState('');
      const [expiryMonth, setExpiryMonth] = useState('');
      const [expiryYear, setExpiryYear] = useState('');
      const [cvv, setCvv] = useState('');
      const [processing, setProcessing] = useState(false);
      const [error, setError] = useState('');

      const handlePayment = async (e) => {
        e.preventDefault();
        setProcessing(true);
        setError('');

        try {
          // Format expiration date as MMYY
          const expirationDate = `${expiryMonth.padStart(2, '0')}${expiryYear.slice(-2)}`;

          // Call Vercel function to process payment
          const response = await fetch('/api/authorize-net-payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              action: 'charge',
              paymentData: {
                cardNumber: cardNumber.replace(/\s/g, ''),
                expirationDate: expirationDate,
                cardCode: cvv,
                amount: invoice.total,
                customerEmail: invoice.customerEmail || 'customer@example.com',
                customerName: invoice.customerName,
                invoiceNumber: invoice.invoiceNumber,
                description: `Farrier Pro Invoice #${invoice.invoiceNumber}`
              },
              invoiceData: {
                invoiceId: invoice.id,
                farrierId: invoice.farrierId
              }
            })
          });

          const result = await response.json();

          if (result.success) {
            // Update invoice status in Firestore
            if (db) {
              await db.collection('invoices').doc(invoice.id).update({
                status: 'paid',
                paidAt: firebase.firestore.FieldValue.serverTimestamp(),
                transactionId: result.transactionId,
                authCode: result.authCode,
                accountNumber: result.accountNumber
              });
            }

            alert('‚úÖ Payment successful! Invoice has been marked as paid.');
            onPaymentSuccess();
          } else {
            setError(result.error || 'Payment failed. Please try again.');
          }
        } catch (err) {
          console.error('Payment error:', err);
          setError('Payment processing failed. Please try again.');
        }

        setProcessing(false);
      };

      // Format card number with spaces
      const formatCardNumber = (value) => {
        const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        const matches = v.match(/\d{4,16}/g);
        const match = (matches && matches[0]) || '';
        const parts = [];
        
        for (let i = 0, len = match.length; i < len; i += 4) {
          parts.push(match.substring(i, i + 4));
        }
        
        return parts.length ? parts.join(' ') : value;
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '500px'}}>
            <h2 style={{marginBottom: '1.5rem'}}>üí≥ Pay Invoice</h2>
            
            <div style={{background: '#f8f9fa', padding: '1rem', borderRadius: '8px', marginBottom: '1.5rem'}}>
              <div style={{fontSize: '0.875rem', color: '#666', marginBottom: '0.5rem'}}>
                Invoice #{invoice.invoiceNumber}
              </div>
              <div style={{fontSize: '2rem', fontWeight: 'bold', color: 'var(--primary)'}}>
                ${invoice.total?.toFixed(2)}
              </div>
              <div style={{fontSize: '0.875rem', color: '#666', marginTop: '0.5rem'}}>
                {invoice.customerName}
              </div>
            </div>

            {error && (
              <div className="error-message" style={{marginBottom: '1rem'}}>
                {error}
              </div>
            )}

            <form onSubmit={handlePayment}>
              <div className="form-group">
                <label>Card Number *</label>
                <input 
                  type="text"
                  required
                  value={cardNumber}
                  onChange={(e) => setCardNumber(formatCardNumber(e.target.value))}
                  placeholder="1234 5678 9012 3456"
                  maxLength="19"
                />
                <div style={{fontSize: '0.75rem', color: '#666', marginTop: '0.25rem'}}>
                  Test: 4111 1111 1111 1111
                </div>
              </div>

              <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '0.75rem'}}>
                <div className="form-group">
                  <label>Month *</label>
                  <input 
                    type="text"
                    required
                    value={expiryMonth}
                    onChange={(e) => setExpiryMonth(e.target.value.replace(/\D/g, '').slice(0, 2))}
                    placeholder="MM"
                    maxLength="2"
                  />
                </div>

                <div className="form-group">
                  <label>Year *</label>
                  <input 
                    type="text"
                    required
                    value={expiryYear}
                    onChange={(e) => setExpiryYear(e.target.value.replace(/\D/g, '').slice(0, 4))}
                    placeholder="YYYY"
                    maxLength="4"
                  />
                </div>

                <div className="form-group">
                  <label>CVV *</label>
                  <input 
                    type="text"
                    required
                    value={cvv}
                    onChange={(e) => setCvv(e.target.value.replace(/\D/g, '').slice(0, 4))}
                    placeholder="123"
                    maxLength="4"
                  />
                </div>
              </div>

              <div style={{display: 'flex', gap: '0.75rem', marginTop: '1.5rem'}}>
                <button 
                  type="button"
                  onClick={onClose}
                  className="btn btn-outline"
                  disabled={processing}
                  style={{flex: 1}}
                >
                  Cancel
                </button>
                <button 
                  type="submit"
                  className="btn btn-success"
                  disabled={processing}
                  style={{flex: 1}}
                >
                  {processing ? <span className="spinner"></span> : `Pay $${invoice.total?.toFixed(2)}`}
                </button>
              </div>
            </form>

            <div style={{marginTop: '1.5rem', padding: '1rem', background: '#f0f9ff', borderRadius: '8px', fontSize: '0.875rem'}}>
              üîí <strong>Secure Payment</strong><br/>
              Your payment is processed securely by Authorize.Net
            </div>
          </div>
        </div>
      );
    }

    function InvoiceCreateModal({ userId, onClose, onCreated }) {
      const [customerName, setCustomerName] = useState('');
      const [customerEmail, setCustomerEmail] = useState('');
      const [customerPhone, setCustomerPhone] = useState('');
      const [items, setItems] = useState([{ description: '', amount: 0 }]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [customers, setCustomers] = useState([]);
      const [loadingCustomers, setLoadingCustomers] = useState(true);
      const [phoneSearching, setPhoneSearching] = useState(false);
      const [selectedCustomerInfo, setSelectedCustomerInfo] = useState(null);

      // Load existing customers
      useEffect(() => {
        loadCustomers();
      }, []);

      const loadCustomers = async () => {
        if (db) {
          try {
            // Load from customers collection
            const customersSnapshot = await db.collection('customers').get();
            const customersList = customersSnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            // Also load from appointments (for customers who booked but might not have customer profile)
            const appointmentsSnapshot = await db.collection('appointments')
              .where('farrierId', '==', userId)
              .get();
            
            const appointmentCustomers = appointmentsSnapshot.docs.map(doc => ({
              name: doc.data().customerName,
              email: doc.data().email,
              phone: doc.data().phone
            }));

            // Combine and deduplicate by email
            const allCustomers = [...customersList, ...appointmentCustomers];
            const uniqueCustomers = Array.from(
              new Map(allCustomers.map(c => [c.email, c])).values()
            ).sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            setCustomers(uniqueCustomers);
          } catch (error) {
            console.error('Error loading customers:', error);
          }
        }
        setLoadingCustomers(false);
      };

      const loadCustomerInvoiceInfo = async (customerEmail) => {
        if (!db || !customerEmail) {
          setSelectedCustomerInfo(null);
          return;
        }

        try {
          // Get all invoices for this customer
          const invoicesSnapshot = await db.collection('invoices')
            .where('customerEmail', '==', customerEmail)
            .orderBy('createdAt', 'desc')
            .get();

          const invoices = invoicesSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));

          // Calculate balance (outstanding invoices)
          const balance = invoices
            .filter(inv => inv.status === 'outstanding')
            .reduce((sum, inv) => sum + (inv.total || 0), 0);

          // Get last invoice
          const lastInvoice = invoices.length > 0 ? invoices[0] : null;

          // Total paid
          const totalPaid = invoices
            .filter(inv => inv.status === 'paid')
            .reduce((sum, inv) => sum + (inv.total || 0), 0);

          setSelectedCustomerInfo({
            balance,
            lastInvoice,
            totalInvoices: invoices.length,
            totalPaid
          });
        } catch (error) {
          console.error('Error loading customer invoice info:', error);
          setSelectedCustomerInfo(null);
        }
      };

      const selectCustomer = async (customerData) => {
        if (customerData) {
          setCustomerName(customerData.name || '');
          setCustomerEmail(customerData.email || '');
          setCustomerPhone(customerData.phone || '');
          
          // Load invoice info for this customer
          await loadCustomerInvoiceInfo(customerData.email);
        } else {
          setSelectedCustomerInfo(null);
        }
      };

      const lookupByPhone = async (phone) => {
        if (!phone || phone.length < 10) return;
        
        setPhoneSearching(true);
        
        // Clean phone number (remove spaces, dashes, parentheses)
        const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
        
        // Search in customers
        const customer = customers.find(c => 
          c.phone && c.phone.replace(/[\s\-\(\)]/g, '').includes(cleanPhone)
        );

        if (customer) {
          setCustomerName(customer.name || '');
          setCustomerEmail(customer.email || '');
          
          // Load invoice info
          await loadCustomerInvoiceInfo(customer.email);
        }
        
        setPhoneSearching(false);
      };

      // Farrier service options for dropdown
      const serviceOptions = [
        { name: '-- Select Service --', price: 0 },
        { name: '‚îÄ‚îÄ‚îÄ TOP SERVICES ‚îÄ‚îÄ‚îÄ', price: 0, isHeader: true },
        { name: 'Hot Shoeing All Four', price: 170 },
        { name: 'Dressage Shoes All Four', price: 200 },
        { name: 'Hunter/Jumper Competition Shoes', price: 195 },
        { name: 'Reset All Four', price: 120 },
        { name: 'Trim All Four', price: 75 },
        { name: 'Front Shoes Only', price: 110 },
        { name: 'Show Prep Package', price: 50 },
        { name: 'Studs Installation', price: 40 },
        { name: 'Leather Pads', price: 40 },
        { name: 'Emergency Call Out', price: 100 },
        { name: '‚îÄ‚îÄ‚îÄ PACKAGES ‚îÄ‚îÄ‚îÄ', price: 0, isHeader: true },
        { name: 'Dressage Maintenance Package', price: 210 },
        { name: 'Hunter/Jumper Show Package', price: 250 },
        { name: 'Training Horse Package', price: 165 },
        { name: '‚îÄ‚îÄ‚îÄ OTHER ‚îÄ‚îÄ‚îÄ', price: 0, isHeader: true },
        { name: 'Custom Service (enter manually)', price: 0 }
      ];

      const addItem = () => {
        setItems([...items, { description: '', amount: 0 }]);
      };

      const updateItem = (index, field, value) => {
        const newItems = [...items];
        newItems[index][field] = value;
        setItems(newItems);
      };

      const selectService = (index, serviceName) => {
        const service = serviceOptions.find(s => s.name === serviceName);
        if (service && !service.isHeader && service.name !== '-- Select Service --') {
          const newItems = [...items];
          newItems[index].description = service.name;
          newItems[index].amount = service.price;
          setItems(newItems);
        }
      };

      const removeItem = (index) => {
        setItems(items.filter((_, i) => i !== index));
      };

      const total = items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

      const generatePaymentLink = async () => {
        if (!customerName || !customerEmail) {
          setError('Customer name and email are required');
          return;
        }

        if (total <= 0) {
          setError('Invoice total must be greater than $0');
          return;
        }

        // Clean up items - replace "Custom Service (enter manually)" with placeholder if not changed
        const cleanedItems = items.map(item => {
          if (item.description === 'Custom Service (enter manually)' || !item.description.trim()) {
            return {
              ...item,
              description: 'Farrier Service'
            };
          }
          return item;
        });

        setError('');
        setLoading(true);

        try {
          // Save invoice to Firestore (no payment link needed - using Pay Now button)
          if (db) {
            // Generate sequential 5-digit invoice number
            let invoiceNumber;
            
            // Get all invoices for this farrier to find the highest number
            const allInvoicesQuery = await db.collection('invoices')
              .where('farrierId', '==', userId)
              .get();
            
            if (!allInvoicesQuery.empty) {
              // Find the highest 5-digit invoice number (ignore old 13-digit ones)
              let highestNumber = 9999; // Start below 10000
              
              allInvoicesQuery.docs.forEach(doc => {
                const data = doc.data();
                if (data.invoiceNumber && data.invoiceNumber.startsWith('INV-')) {
                  const num = parseInt(data.invoiceNumber.replace('INV-', ''));
                  // Only count 5-digit numbers (10000-99999)
                  if (!isNaN(num) && num >= 10000 && num <= 99999 && num > highestNumber) {
                    highestNumber = num;
                  }
                }
              });
              
              const nextNumber = highestNumber + 1;
              invoiceNumber = `INV-${nextNumber}`;
            } else {
              // First invoice - start at 10000
              invoiceNumber = 'INV-10000';
            }
            console.log('üîµ Creating invoice:', {
              farrierId: userId,
              customerName,
              total,
              invoiceNumber
            });
            
            const docRef = await db.collection('invoices').add({
              farrierId: userId,
              customerName: customerName,
              customerEmail: customerEmail,
              customerPhone: customerPhone,
              items: cleanedItems,
              total: total,
              invoiceNumber: invoiceNumber,
              status: 'outstanding',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            console.log('‚úÖ Invoice created with ID:', docRef.id);
            alert('‚úÖ Invoice created successfully! Customer can now pay using the "Pay Now" button.');
            onCreated();
          } else {
            console.error('‚ùå Database not initialized');
            setError('Database not available');
          }
        } catch (err) {
          console.error('‚ùå Error creating invoice:', err);
          setError('Error creating invoice. Please try again.');
        }

        setLoading(false);
      };

      const sendInvoice = () => {
        const message = `Hi ${customerName}! Your invoice for $${total.toFixed(2)} is ready. Pay here: ${paymentUrl}`;
        alert(`SMS would be sent to ${customerPhone}:\n\n${message}`);
        onCreated();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Create Invoice</h2>
              <button className="close-btn" onClick={onClose}>√ó</button>
            </div>

            {error && <div className="error-message">{error}</div>}

            <div className="form-group">
              <label>Select Existing Customer (Optional)</label>
              {loadingCustomers ? (
                <div style={{padding: '0.75rem', color: 'var(--text-muted)'}}>Loading customers...</div>
              ) : (
                <select
                  onChange={(e) => {
                    const customer = customers.find(c => c.email === e.target.value);
                    if (customer) {
                      selectCustomer(customer);
                    } else {
                      selectCustomer(null);
                    }
                  }}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid var(--border)',
                    borderRadius: '8px',
                    fontSize: '1rem'
                  }}
                >
                  <option value="">-- Select Customer or Enter New Below --</option>
                  {customers.map((customer, i) => (
                    <option key={i} value={customer.email}>
                      {customer.name} - {customer.email}
                    </option>
                  ))}
                </select>
              )}
              <div style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                Or search by phone number below
              </div>
            </div>

            {selectedCustomerInfo && (
              <div style={{
                background: 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',
                border: '2px solid #0ea5e9',
                borderRadius: '12px',
                padding: '1rem',
                marginBottom: '1rem'
              }}>
                <div style={{
                  fontSize: '0.9rem',
                  fontWeight: '600',
                  color: '#0369a1',
                  marginBottom: '0.75rem',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}>
                  üìä Customer Account Summary
                </div>
                
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem'}}>
                  <div>
                    <div style={{fontSize: '0.75rem', color: '#64748b', marginBottom: '0.25rem'}}>
                      Current Balance
                    </div>
                    <div style={{
                      fontSize: '1.5rem',
                      fontWeight: 'bold',
                      color: selectedCustomerInfo.balance > 0 ? '#dc2626' : '#16a34a'
                    }}>
                      ${selectedCustomerInfo.balance.toFixed(2)}
                    </div>
                    {selectedCustomerInfo.balance > 0 && (
                      <div style={{fontSize: '0.7rem', color: '#dc2626', fontWeight: '500'}}>
                        OUTSTANDING
                      </div>
                    )}
                  </div>

                  <div>
                    <div style={{fontSize: '0.75rem', color: '#64748b', marginBottom: '0.25rem'}}>
                      Total Paid
                    </div>
                    <div style={{fontSize: '1.5rem', fontWeight: 'bold', color: '#16a34a'}}>
                      ${selectedCustomerInfo.totalPaid.toFixed(2)}
                    </div>
                    <div style={{fontSize: '0.7rem', color: '#64748b'}}>
                      {selectedCustomerInfo.totalInvoices} invoice{selectedCustomerInfo.totalInvoices !== 1 ? 's' : ''}
                    </div>
                  </div>
                </div>

                {selectedCustomerInfo.lastInvoice && (
                  <div style={{
                    marginTop: '0.75rem',
                    paddingTop: '0.75rem',
                    borderTop: '1px solid #bae6fd'
                  }}>
                    <div style={{fontSize: '0.75rem', color: '#64748b', marginBottom: '0.25rem'}}>
                      Last Invoice
                    </div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                      <div>
                        <div style={{fontSize: '0.85rem', fontWeight: '600', color: '#0369a1'}}>
                          {selectedCustomerInfo.lastInvoice.invoiceNumber}
                        </div>
                        <div style={{fontSize: '0.75rem', color: '#64748b'}}>
                          {selectedCustomerInfo.lastInvoice.createdAt?.toDate().toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                          })}
                        </div>
                      </div>
                      <div style={{textAlign: 'right'}}>
                        <div style={{fontSize: '1rem', fontWeight: 'bold', color: '#0369a1'}}>
                          ${selectedCustomerInfo.lastInvoice.total?.toFixed(2)}
                        </div>
                        <span style={{
                          fontSize: '0.7rem',
                          padding: '0.125rem 0.5rem',
                          borderRadius: '12px',
                          fontWeight: '600',
                          textTransform: 'uppercase',
                          background: selectedCustomerInfo.lastInvoice.status === 'paid' ? '#dcfce7' : '#fef3c7',
                          color: selectedCustomerInfo.lastInvoice.status === 'paid' ? '#166534' : '#92400e'
                        }}>
                          {selectedCustomerInfo.lastInvoice.status}
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            <div className="form-group">
              <label>Customer Phone {phoneSearching && <span style={{color: 'var(--primary)'}}>üîç Searching...</span>}</label>
              <input 
                type="tel"
                value={customerPhone}
                onChange={(e) => {
                  setCustomerPhone(e.target.value);
                  if (e.target.value.replace(/\D/g, '').length >= 10) {
                    lookupByPhone(e.target.value);
                  }
                }}
                placeholder="555-123-4567 (auto-fills customer info)"
              />
              <div style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                Enter phone to auto-fill customer details
              </div>
            </div>

            <div className="form-group">
              <label>Customer Name *</label>
              <input 
                type="text"
                value={customerName}
                onChange={(e) => setCustomerName(e.target.value)}
                placeholder="John Smith"
              />
            </div>

            <div className="form-group">
              <label>Customer Email *</label>
              <input 
                type="email"
                value={customerEmail}
                onChange={(e) => setCustomerEmail(e.target.value)}
                placeholder="customer@email.com"
              />
            </div>

            <div className="form-group">
              <label>Invoice Items</label>
              {items.map((item, idx) => (
                <div key={idx} style={{marginBottom: '1rem', padding: '1rem', background: '#f8f9fa', borderRadius: '8px'}}>
                  <div style={{display: 'flex', gap: '0.5rem', marginBottom: '0.5rem'}}>
                    <select
                      value={item.description}
                      onChange={(e) => selectService(idx, e.target.value)}
                      style={{
                        flex: 2,
                        padding: '0.75rem',
                        border: '2px solid var(--border)',
                        borderRadius: '8px',
                        fontSize: '1rem',
                        fontFamily: 'inherit'
                      }}
                    >
                      {serviceOptions.map((service, i) => (
                        <option 
                          key={i} 
                          value={service.name}
                          disabled={service.isHeader}
                          style={{
                            fontWeight: service.isHeader ? 'bold' : 'normal',
                            color: service.isHeader ? '#666' : 'inherit'
                          }}
                        >
                          {service.name}
                        </option>
                      ))}
                    </select>
                    {items.length > 1 && (
                      <button 
                        className="btn btn-sm btn-outline"
                        onClick={() => removeItem(idx)}
                        type="button"
                        style={{padding: '0.75rem 1rem'}}
                      >
                        ‚úï
                      </button>
                    )}
                  </div>
                  
                  {item.description === 'Custom Service (enter manually)' || 
                   (item.description && !serviceOptions.find(s => s.name === item.description)) ? (
                    <input 
                      type="text"
                      placeholder="Enter custom service description"
                      value={item.description === 'Custom Service (enter manually)' ? '' : item.description}
                      onChange={(e) => updateItem(idx, 'description', e.target.value)}
                      style={{
                        width: '100%',
                        padding: '0.75rem',
                        border: '2px solid var(--border)',
                        borderRadius: '8px',
                        fontSize: '1rem',
                        marginBottom: '0.5rem'
                      }}
                    />
                  ) : null}

                  <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                    <label style={{marginBottom: 0, fontSize: '0.9rem', fontWeight: '500'}}>Price:</label>
                    <span style={{fontSize: '1.5rem', fontWeight: 'bold'}}>$</span>
                    <input 
                      type="number"
                      placeholder="0.00"
                      value={item.amount || ''}
                      onChange={(e) => updateItem(idx, 'amount', e.target.value)}
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        border: '2px solid var(--border)',
                        borderRadius: '8px',
                        fontSize: '1rem'
                      }}
                      step="0.01"
                      min="0"
                    />
                  </div>
                </div>
              ))}
              <button className="btn btn-sm btn-outline" onClick={addItem} type="button">
                + Add Another Service
              </button>
            </div>

            <div style={{borderTop: '2px solid var(--border)', paddingTop: '1rem', marginTop: '1rem'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '1.5rem', fontWeight: '800', color: 'var(--primary)'}}>
                <span>Total</span>
                <span>${total.toFixed(2)}</span>
              </div>
            </div>

            <button 
              className="btn btn-primary" 
              style={{width: '100%', marginTop: '1rem'}}
              onClick={generatePaymentLink}
              disabled={loading}
            >
              {loading ? <span className="spinner"></span> : '‚úì Create Invoice'}
            </button>

            <p style={{fontSize: '0.875rem', color: '#666', marginTop: '0.5rem', textAlign: 'center'}}>
              Customer will use "Pay Now" button to pay with Authorize.Net
            </p>
          </div>
        </div>
      );
    }

    function SettingsView({ user, userProfile, setUserProfile }) {
      const [businessName, setBusinessName] = useState(userProfile?.businessName || '');
      const [phone, setPhone] = useState(userProfile?.phone || '');
      const [address, setAddress] = useState(userProfile?.address || '');
      const [city, setCity] = useState(userProfile?.city || '');
      const [state, setState] = useState(userProfile?.state || '');
      const [zip, setZip] = useState(userProfile?.zip || '');
      const [loading, setLoading] = useState(false);
      const [successMessage, setSuccessMessage] = useState('');
      const [error, setError] = useState('');
      
      // Availability settings with defaults
      const defaultAvailability = {
        monday: { enabled: true, start: '09:00', end: '17:00' },
        tuesday: { enabled: true, start: '09:00', end: '17:00' },
        wednesday: { enabled: true, start: '09:00', end: '17:00' },
        thursday: { enabled: true, start: '09:00', end: '17:00' },
        friday: { enabled: true, start: '09:00', end: '17:00' },
        saturday: { enabled: false, start: '09:00', end: '17:00' },
        sunday: { enabled: false, start: '09:00', end: '17:00' }
      };
      
      const [availability, setAvailability] = useState(
        userProfile?.availability || defaultAvailability
      );

      const updateDayAvailability = (day, field, value) => {
        setAvailability({
          ...availability,
          [day]: {
            ...availability[day],
            [field]: value
          }
        });
      };

      const handleSave = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        setSuccessMessage('');

        try {
          if (db) {
            await db.collection('farriers').doc(user.uid).update({
              businessName: businessName,
              phone: phone,
              address: address,
              city: city,
              state: state,
              zip: zip,
              availability: availability,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Update local state
            setUserProfile({
              ...userProfile,
              businessName,
              phone,
              address,
              city,
              state,
              zip,
              availability
            });

            setSuccessMessage('Profile updated successfully!');
          }
        } catch (err) {
          console.error('Error updating profile:', err);
          setError('Failed to update profile. Please try again.');
        }

        setLoading(false);
      };

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>
            Account Settings
          </h1>

          {successMessage && <div className="success-message">{successMessage}</div>}
          {error && <div className="error-message">{error}</div>}

          <div className="card">
            <h2>Business Profile</h2>
            <form onSubmit={handleSave}>
              <div className="form-group">
                <label>Business Name *</label>
                <input 
                  type="text"
                  required
                  value={businessName}
                  onChange={(e) => setBusinessName(e.target.value)}
                  placeholder="John's Farrier Services"
                />
              </div>

              <div className="form-group">
                <label>Email (Cannot be changed)</label>
                <input 
                  type="email"
                  value={userProfile?.email || user.email}
                  disabled
                  style={{background: '#f5f5f5', cursor: 'not-allowed'}}
                />
              </div>

              <div className="form-group">
                <label>Phone Number *</label>
                <input 
                  type="tel"
                  required
                  value={phone}
                  onChange={(e) => setPhone(e.target.value)}
                  placeholder="(555) 555-5555"
                />
              </div>

              <div className="form-group">
                <label>Business Address *</label>
                <input 
                  type="text"
                  required
                  value={address}
                  onChange={(e) => setAddress(e.target.value)}
                  placeholder="123 Main Street"
                />
              </div>

              <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem'}}>
                <div className="form-group">
                  <label>City *</label>
                  <input 
                    type="text"
                    required
                    value={city}
                    onChange={(e) => setCity(e.target.value)}
                    placeholder="City"
                  />
                </div>

                <div className="form-group">
                  <label>State *</label>
                  <input 
                    type="text"
                    required
                    value={state}
                    onChange={(e) => setState(e.target.value.toUpperCase())}
                    placeholder="VA"
                    maxLength="2"
                    style={{textTransform: 'uppercase'}}
                  />
                </div>

                <div className="form-group">
                  <label>ZIP *</label>
                  <input 
                    type="text"
                    required
                    value={zip}
                    onChange={(e) => setZip(e.target.value)}
                    placeholder="12345"
                    maxLength="5"
                    pattern="[0-9]{5}"
                  />
                </div>
              </div>

              <button 
                type="submit" 
                className="btn btn-primary"
                disabled={loading}
                style={{marginTop: '1rem'}}
              >
                {loading ? <span className="spinner"></span> : 'Save Changes'}
              </button>
            </form>
          </div>

          {/* Availability Settings */}
          <div className="card" style={{marginTop: '1.5rem'}}>
            <h2>üìÖ Availability Settings</h2>
            <p style={{color: 'var(--text-muted)', marginBottom: '1.5rem'}}>
              Set your working hours. Customers will only see available times when booking.
            </p>

            <form onSubmit={handleSave}>
              {['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].map(day => (
                <div 
                  key={day}
                  style={{
                    display: 'grid',
                    gridTemplateColumns: '120px 1fr 1fr 1fr',
                    gap: '0.75rem',
                    alignItems: 'center',
                    marginBottom: '1rem',
                    padding: '0.75rem',
                    background: availability[day].enabled ? '#f8f9fa' : '#fff',
                    borderRadius: '4px',
                    border: '1px solid #e0e0e0'
                  }}
                >
                  <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem', margin: 0}}>
                    <input
                      type="checkbox"
                      checked={availability[day].enabled}
                      onChange={(e) => updateDayAvailability(day, 'enabled', e.target.checked)}
                      style={{width: '18px', height: '18px'}}
                    />
                    <span style={{fontWeight: '500', textTransform: 'capitalize'}}>
                      {day}
                    </span>
                  </label>

                  {availability[day].enabled && (
                    <>
                      <div>
                        <label style={{fontSize: '0.875rem', color: '#666', display: 'block', marginBottom: '0.25rem'}}>
                          Start Time
                        </label>
                        <input
                          type="time"
                          value={availability[day].start}
                          onChange={(e) => updateDayAvailability(day, 'start', e.target.value)}
                          required
                          style={{width: '100%'}}
                        />
                      </div>

                      <div>
                        <label style={{fontSize: '0.875rem', color: '#666', display: 'block', marginBottom: '0.25rem'}}>
                          End Time
                        </label>
                        <input
                          type="time"
                          value={availability[day].end}
                          onChange={(e) => updateDayAvailability(day, 'end', e.target.value)}
                          required
                          style={{width: '100%'}}
                        />
                      </div>

                      <div style={{fontSize: '0.875rem', color: '#666', textAlign: 'center'}}>
                        {availability[day].start && availability[day].end && (
                          <>
                            {(() => {
                              const start = new Date(`1970-01-01T${availability[day].start}`);
                              const end = new Date(`1970-01-01T${availability[day].end}`);
                              const hours = (end - start) / (1000 * 60 * 60);
                              return `${hours.toFixed(1)} hours`;
                            })()}
                          </>
                        )}
                      </div>
                    </>
                  )}

                  {!availability[day].enabled && (
                    <div style={{gridColumn: '2 / 5', color: '#999', fontStyle: 'italic'}}>
                      Not available
                    </div>
                  )}
                </div>
              ))}

              <button 
                type="submit" 
                className="btn btn-primary"
                disabled={loading}
                style={{marginTop: '1rem'}}
              >
                {loading ? <span className="spinner"></span> : 'Save Availability'}
              </button>
            </form>
          </div>

          <div className="card" style={{marginTop: '1.5rem'}}>
            <h2>Account Information</h2>
            <p style={{color: 'var(--text-muted)', marginBottom: '1rem'}}>
              <strong>Account Created:</strong> {userProfile?.createdAt?.toDate().toLocaleDateString() || 'N/A'}
            </p>
            <div style={{marginBottom: '1rem'}}>
              <strong>Booking URL:</strong><br/>
              <code style={{background: '#f5f5f5', padding: '0.5rem', borderRadius: '4px', display: 'inline-block', marginTop: '0.5rem', wordBreak: 'break-all'}}>
                {`${window.location.origin}?farrier=${user.uid}`}
              </code>
              <div style={{marginTop: '0.5rem'}}>
                <button 
                  className="btn btn-sm"
                  onClick={() => {
                    const url = `${window.location.origin}?farrier=${user.uid}`;
                    navigator.clipboard.writeText(url);
                    alert('Booking URL copied to clipboard!');
                  }}
                  style={{marginRight: '0.5rem'}}
                >
                  üìã Copy URL
                </button>
                <button 
                  className="btn btn-sm"
                  onClick={async () => {
                    try {
                      if (db) {
                        await db.collection('farriers').doc(user.uid).update({
                          bookingUrl: `${window.location.origin}?farrier=${user.uid}`
                        });
                        setUserProfile({
                          ...userProfile,
                          bookingUrl: `${window.location.origin}?farrier=${user.uid}`
                        });
                        alert('Booking URL updated successfully!');
                      }
                    } catch (error) {
                      console.error('Error updating URL:', error);
                      alert('Failed to update URL');
                    }
                  }}
                >
                  üîÑ Update URL
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
