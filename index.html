<!-- Build: 2026-02-20 05:24:53 UTC -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">address
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FarriTech - Advanced Farrier Solutions</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.svg" />
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <!-- Authorize.Net integration via backend functions -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Google API for Calendar -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2683FB;
      --primary-light: #46C5FF;
      --secondary: #8F9DAF;
      --accent: #46C5FF;
      --bg: #F4F6F9;
      --surface: #FFFFFF;
      --text: #1A2332;
      --text-muted: #6B7A8D;
      --success: #2683FB;
      --warning: #f59e0b;
      --error: #ef4444;
      --border: #DDE3EC;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      max-width: 100%;
      min-height: 100vh;
    }

    /* Header */
    .app-header {
      background: var(--primary);
      color: white;
      padding: 1rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo {
      font-family: 'Space Mono', monospace;
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-icon {
      font-size: 2rem;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .user-info {
      font-size: 0.875rem;
    }

    /* Main Content */
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* Auth Forms */
    .auth-container {
      max-width: 450px;
      margin: 3rem auto;
    }

    .auth-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      border: 2px solid var(--border);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .auth-header h1 {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .auth-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: var(--bg);
      padding: 0.25rem;
      border-radius: 8px;
    }

    .auth-tab {
      flex: 1;
      padding: 0.75rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .auth-tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
      border: 2px solid var(--border);
    }

    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--primary);
    }

    .form-group {
      margin-bottom: 1.25rem;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      padding: 0.875rem 2rem;
      border: none;
      border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--secondary);
      color: var(--text);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-google {
      background: white;
      color: #444;
      border: 2px solid var(--border);
    }

    .btn-google:hover {
      background: #f8f9fa;
    }

    /* QR Code Display */
    .qr-section {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      color: white;
      margin-bottom: 2rem;
    }

    .qr-code-container {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      display: inline-block;
      margin: 1.5rem 0;
    }

    .qr-code-container canvas {
      display: block;
    }

    .booking-link {
      background: rgba(255,255,255,0.2);
      padding: 1rem;
      border-radius: 8px;
      word-break: break-all;
      margin-top: 1rem;
      font-family: 'Space Mono', monospace;
      font-size: 0.875rem;
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--surface);
      padding: 1.5rem;
      border-radius: 12px;
      border: 2px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
    }

    .stat-change {
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .stat-change.positive {
      color: var(--success);
    }

    /* Calendar */
    .calendar {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      border: 2px solid var(--border);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .calendar-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .calendar-nav {
      display: flex;
      gap: 0.5rem;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .calendar-day.header {
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      cursor: default;
    }

    .calendar-day:not(.header):hover {
      background: var(--border);
    }

    .calendar-day.today {
      background: var(--primary);
      color: white;
    }

    .calendar-day.has-appointment {
      background: var(--accent);
      color: white;
    }

    /* Appointments List */
    .appointments-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .appointment-item {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s;
    }

    .appointment-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .appointment-info {
      flex: 1;
    }

    .appointment-customer {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
      color: var(--primary);
    }

    .appointment-details {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .appointment-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-success {
      background: #E6F4EA;
      color: var(--success);
    }

    .badge-warning {
      background: #FEF3E2;
      color: var(--warning);
    }

    .badge-secondary {
      background: #fee2e2;
      color: #dc2626;
      font-weight: 600;
    }

    .badge-pending {
      background: #E8EAF6;
      color: #5E35B1;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .success-message {
      background: #E6F4EA;
      border: 2px solid var(--success);
      color: var(--success);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 600;
      text-align: center;
    }

    .error-message {
      background: #FEE;
      border: 2px solid var(--error);
      color: var(--error);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 600;
      text-align: center;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
    }

    .tab {
      padding: 0.75rem 1.5rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab:hover {
      color: var(--primary-light);
      border-bottom-color: var(--primary-light);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      text-shadow: 0 0 12px rgba(38, 131, 251, 0.4);
    }

    /* Time Slots */
    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .time-slot {
      padding: 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      font-weight: 600;
    }

    .time-slot:hover {
      border-color: var(--primary);
    }

    .time-slot.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .time-slot.booked {
      opacity: 0.4;
      cursor: not-allowed;
      background: var(--border);
    }

    /* Google Calendar Status */
    .calendar-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .status-indicator.connected {
      background: var(--success);
    }

    .status-indicator.disconnected {
      background: var(--error);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .appointment-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .appointment-actions {
        width: 100%;
      }
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hero {
      text-align: center;
      margin-bottom: 3rem;
    }

    .hero h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 1rem;
      color: var(--primary);
    }

    .hero p {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto;
    }
  
.build-badge{margin-left:10px;font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25)}

      .version-pill{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        padding:6px 10px;
        border-radius:999px;
        background: rgba(255,255,255,0.12);
        border:1px solid rgba(255,255,255,0.25);
        color:#fff;
        font-weight:700;
        font-size:12px;
        letter-spacing:0.3px;
        margin-right:10px;
      }

    /* ===== FarriTech Auth Redesign (Blue Split) ===== */
    .auth-page{
      min-height:100vh;
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      background:#060B1A;
    }

    .auth-hero{
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      padding: clamp(2.25rem, 6vw, 4.5rem);
      background-image:
        radial-gradient(900px 600px at 15% 25%, rgba(70,197,255,.22), transparent 60%),
        radial-gradient(700px 500px at 70% 70%, rgba(38,131,251,.22), transparent 62%),
        linear-gradient(135deg, rgba(6,11,26,0.92), rgba(6,11,26,0.55)),
        url("/auth-hero-bg.png");
      background-size: cover;
      background-position: center;
    }

    .auth-hero::before{
      content:"";
      position:absolute;
      inset:-20%;
      background-image: url("/favicon.svg");
      background-repeat:no-repeat;
      background-position: 55% 45%;
      background-size: min(860px, 85%);
      opacity: 0.08;
      transform: rotate(-6deg);
      pointer-events:none;
    }

    .auth-hero::after{
      content:"";
      position:absolute;
      inset:-40% -20% -40% -20%;
      background:
        radial-gradient(circle at 65% 55%, rgba(70,197,255,.18), transparent 55%),
        radial-gradient(circle at 25% 35%, rgba(38,131,251,.18), transparent 55%);
      opacity: 0.75;
      pointer-events:none;
    }

    .auth-hero-content{
      position:relative;
      max-width: 560px;
      color: #EAF2FF;
      z-index:1;
    }

    .auth-hero-content h2{
      font-family: "Outfit", sans-serif;
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: clamp(2.1rem, 4vw, 3.25rem);
      line-height: 1.08;
      margin: 0 0 1rem 0;
      text-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .auth-hero-content p{
      margin: 0;
      font-size: 1.05rem;
      line-height: 1.55;
      color: rgba(234,242,255,.82);
    }

    .auth-panel{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: clamp(1.5rem, 4vw, 3rem);
      background:
        radial-gradient(800px 520px at 40% 25%, rgba(38,131,251,.22), transparent 60%),
        radial-gradient(900px 620px at 60% 80%, rgba(70,197,255,.16), transparent 65%),
        linear-gradient(180deg, #060B1A 0%, #07102A 60%, #060B1A 100%);
      overflow:hidden;
    }

    .auth-panel::before{
      content:"";
      position:absolute;
      inset:0;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.06), transparent 35%),
        radial-gradient(circle at 75% 60%, rgba(255,255,255,.04), transparent 38%);
      opacity: 0.8;
      pointer-events:none;
    }

    /* Override legacy auth layout */
    .auth-container{
      max-width: 520px;
      margin: 0;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .auth-card{
      background: rgba(8, 18, 48, 0.55);
      border: 1px solid rgba(70,197,255,0.22);
      box-shadow: 0 20px 70px rgba(0,0,0,0.55);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      color: #EAF2FF;
    }

    .auth-header h1{ color: #EAF2FF; }
    .auth-header p{ color: rgba(234,242,255,.78); }

    .brand-lockup{
      display:flex;
      justify-content:center;
      margin-bottom: 1.25rem;
    }

    .brand-lockup img{
      width: min(360px, 90%);
      height: auto;
      filter: drop-shadow(0 10px 28px rgba(0,0,0,.45));
    }

    .auth-tabs{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .auth-tab{ color: rgba(234,242,255,.85); }

    .auth-tab.active{
      background: rgba(255,255,255,0.12);
      color: #EAF2FF;
      box-shadow: none;
    }

    .form-group label{ color: rgba(234,242,255,.86); }

    .form-group input,
    .form-group textarea,
    .form-group select{
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.14);
      color: #EAF2FF;
    }

    .form-group input::placeholder{ color: rgba(234,242,255,.55); }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus{
      outline:none;
      border-color: rgba(70,197,255,0.55);
      box-shadow: 0 0 0 4px rgba(38,131,251,0.18);
    }

    .auth-page .btn-primary{
      background: linear-gradient(90deg, #1E5CFF 0%, #35C9FF 100%);
      color: #fff;
      border: none;
      box-shadow: 0 14px 36px rgba(30,92,255,0.28);
    }

    .auth-page .btn-primary:hover{
      background: linear-gradient(90deg, #2B6BFF 0%, #4ED2FF 100%);
      transform: translateY(-2px);
    }

    .google-button{
      background: rgba(255,255,255,0.9);
      color: #111827;
      border: 1px solid rgba(255,255,255,0.28);
    }

    .divider{ color: rgba(234,242,255,.65); }

    .error-message{
      background: rgba(239, 68, 68, 0.14);
      border: 1px solid rgba(239, 68, 68, 0.28);
      color: #FFD2D2;
    }

    .success-message{
      background: rgba(34, 197, 94, 0.14);
      border: 1px solid rgba(34, 197, 94, 0.26);
      color: #D6FFE3;
    }

    @media (max-width: 980px){
      .auth-page{ grid-template-columns: 1fr; }
      .auth-hero{ min-height: 42vh; }
    }

    @media (max-width: 520px){
      .auth-card{ padding: 1.75rem; }
    }
@media (max-width: 520px){
  .auth-card{ padding: 1.75rem; }
}

/* PASTE THE NEW CINEMATIC CSS RIGHT HERE */

/* ===== CINEMATIC AUTH BACKGROUND ===== */

.ft-auth-wrap{
  min-height: 100vh;
  width: 100%;
  background:
    linear-gradient(120deg, rgba(5,11,24,0.65), rgba(5,11,24,0.45)),
    url("/auth-bg.jpg");
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  position: relative;
  overflow: hidden;
  color: white;
}

.ft-auth-wrap::after{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(800px 400px at 70% 40%, rgba(42,168,255,0.25), transparent 60%),
    radial-gradient(600px 400px at 30% 80%, rgba(11,99,255,0.25), transparent 60%);
  animation: ftGlow 6s ease-in-out infinite alternate;
  pointer-events:none;
}

@keyframes ftGlow{
  0% { opacity: 0.6; }
  100% { opacity: 1; }
}
/* Keep auth content above the animated glow overlay */
.auth-page.ft-auth-wrap > *{
  position: relative;
  z-index: 2;
}
.auth-page.ft-auth-wrap::after{
  pointer-events: none;
}
 /* ===== FORCE CINEMATIC AUTH MODE (override everything) ===== */

/* force auth-page layout to stop splitting the screen */
body .auth-page.ft-auth-wrap{
  display: block !important;
  background: none !important;
  min-height: 100vh !important;
  padding: 0 !important;
}

/* remove any grid split / columns on auth page */
body .auth-page.ft-auth-wrap{
  grid-template-columns: none !important;
  place-items: unset !important;
}

/* kill the old hero column + circle graphic */
body .auth-page.ft-auth-wrap .auth-hero,
body .auth-page.ft-auth-wrap .auth-hero *,
body .auth-page.ft-auth-wrap .auth-hero::before,
body .auth-page.ft-auth-wrap .auth-hero::after{
  display: none !important;
  content: none !important;
}

/* make your auth-card float on the right like the mock */
body .auth-page.ft-auth-wrap .auth-card{
  position: absolute !important;
  top: 50% !important;
  right: 6% !important;
  transform: translateY(-50%) !important;
  max-width: 520px !important;
  width: min(520px, 92vw) !important;
  z-index: 5 !important;
}

/* mobile: center the card */
@media (max-width: 980px){
  body .auth-page.ft-auth-wrap .auth-card{
    position: relative !important;
    top: auto !important;
    right: auto !important;
    transform: none !important;
    margin: 28px auto !important;
  }
}
/* === FIX POSITIONING + FORCE THE CINEMATIC BG TO SHOW === */
body .auth-page.ft-auth-wrap{
  position: relative !important;
  background:
    linear-gradient(120deg, rgba(5,11,24,0.65), rgba(5,11,24,0.45)),
    url("/auth-bg.jpg") !important;
  background-size: cover !important;
  background-position: center !important;
}

/* make sure the glow overlay stays behind the card */
body .auth-page.ft-auth-wrap::after{
  z-index: 1 !important;
}

/* ensure the auth card sits above everything */
body .auth-page.ft-auth-wrap .auth-card{
  z-index: 5 !important;
}
/* ===== BRIGHTEN CINEMATIC BG (keep contrast, reduce darkness) ===== */
body .auth-page.ft-auth-wrap{
  /* lighter overlay + slightly brighter image */
  background:
    linear-gradient(120deg, rgba(5,11,24,0.30), rgba(5,11,24,0.18)),
    url("/auth-bg.jpg") !important;
  background-size: cover !important;
  background-position: center !important;
  filter: brightness(1.08) contrast(1.05) saturate(1.10);
}

/* soften the glow overlay so it doesn't darken */
body .auth-page.ft-auth-wrap::after{
  opacity: 0.55 !important;
}
/* Boost the blue energy on the right side (like the screenshot) */
body .auth-page.ft-auth-wrap::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(900px 520px at 82% 45%, rgba(42,168,255,0.22), transparent 60%),
    radial-gradient(900px 520px at 70% 80%, rgba(11,99,255,0.18), transparent 62%);
  pointer-events:none;
  z-index: 1;
}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;


      const BUILD_VERSION = "Ver 3.0";
("FarriTech build:", BUILD_VERSION);

/**********************
       * INVOICE PDF / PRINT HELPERS
       * - Generates a professional PDF (jsPDF) with optional logo + payment QR
       * - Also supports opening print dialog
       **********************/

      const money_ = (n) => {
        const x = Number(n || 0);
        try { return x.toLocaleString(undefined, { style: "currency", currency: "USD" }); }
        catch { return `$${x.toFixed(2)}`; }
      };

      const formatDate_ = (tsOrDate) => {
        try {
          const d = tsOrDate?.toDate ? tsOrDate.toDate() : (tsOrDate instanceof Date ? tsOrDate : new Date(tsOrDate));
          return isNaN(d.getTime()) ? "" : d.toLocaleDateString();
        } catch { return ""; }
      };

      const safeText_ = (s) => String(s ?? "").replace(/\s+/g, " ").trim();

      // Wrap long text to fit PDF width
      const pdfWrapText_ = (doc, text, x, y, maxWidth, lineHeight) => {
        const lines = doc.splitTextToSize(String(text || ""), maxWidth);
        lines.forEach((ln, i) => doc.text(ln, x, y + (i * lineHeight)));
        return y + (lines.length * lineHeight);
      };

      const buildInvoicePayUrl_ = (invoice) => {
        // Prefer paymentUrl if it exists
        if (invoice?.paymentUrl) return String(invoice.paymentUrl);
        return "";
      };

      const qrToDataUrl_ = async (text) => {
        try {
          if (!text) return "";
          if (window.QRCode && typeof window.QRCode.toDataURL === "function") {
            return await window.QRCode.toDataURL(text, { margin: 1, width: 220 });
          }
        } catch (e) {}
        return "";
      };

      async function generateInvoicePdfBlobUrl(invoice, farrierProfile) {
        if (!window.jspdf?.jsPDF) throw new Error("jsPDF not loaded");
        const { jsPDF } = window.jspdf;

        const profile = farrierProfile || {};
        const businessName = safeText_(profile.businessName) || "FarriTech";
        const bizPhone = safeText_(profile.phone);
        const bizEmail = safeText_(profile.email || ""); // optional
        const bizAddr = [safeText_(profile.address), safeText_(profile.city), safeText_(profile.state), safeText_(profile.zip)]
          .filter(Boolean)
          .join(", ");

        const doc = new jsPDF({ unit: "pt", format: "letter" });
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();

        // Outer border
        const borderMargin = 28; // points
        doc.setDrawColor(0);
        doc.setLineWidth(1);
        doc.rect(borderMargin, borderMargin, pageW - (borderMargin * 2), pageH - (borderMargin * 2));

        // Style
        doc.setFont("helvetica", "normal");

        // Optional logo
        const logoUrl = safeText_(profile.logoUrl);
        let cursorY = 54;

        if (logoUrl) {
          try {
            // Fetch logo as dataURL (works for public URLs with CORS)
            const resp = await fetch(logoUrl, { mode: "cors" });
            const blob = await resp.blob();
            const dataUrl = await new Promise((resolve) => {
              const r = new FileReader();
              r.onload = () => resolve(r.result);
              r.readAsDataURL(blob);
            });

            // Draw logo (fit into 120x50)
            doc.addImage(dataUrl, "PNG", 48, 40, 120, 50);
          } catch (e) {
            // If logo fails, fall back to text
          }
        }

        // Header right: INVOICE
        doc.setFont("helvetica", "bold");
        doc.setFontSize(22);
        doc.text("INVOICE", pageW - 48, 56, { align: "right" });

        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");

        // Business block (left)
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text(businessName, 48, 108);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);

        let bizLine = 126;
        if (bizAddr) { doc.text(bizAddr, 48, bizLine); bizLine += 14; }
        if (bizPhone) { doc.text(`Phone: ${bizPhone}`, 48, bizLine); bizLine += 14; }
        if (bizEmail) { doc.text(`Email: ${bizEmail}`, 48, bizLine); bizLine += 14; }

        // Invoice meta (right)
        const invNo = safeText_(invoice.invoiceNumber || "");
        const invDate = formatDate_(invoice.createdAt) || formatDate_(new Date());
        // Calculate real status from payments
        const _paidSoFar = invoice.paidAmount || (invoice.payments||[]).reduce((s,p)=>s+(p.amount||0),0);
        const _balDue = Math.max(0, (invoice.total||0) - _paidSoFar);
        const invStatus = _balDue <= 0 && _paidSoFar > 0 ? 'paid' : (_paidSoFar > 0 ? 'partial' : safeText_(invoice.status || 'outstanding'));

        doc.setFont("helvetica", "bold");
        doc.text("Invoice #", pageW - 220, 108);
        doc.text("Date", pageW - 220, 126);
        doc.text("Status", pageW - 220, 144);
        doc.setFont("helvetica", "normal");
        doc.text(invNo, pageW - 48, 108, { align: "right" });
        doc.text(invDate, pageW - 48, 126, { align: "right" });
        doc.text(invStatus.toUpperCase(), pageW - 48, 144, { align: "right" });

        // Watermark - only show PAID when fully paid, CANCELLED when cancelled
        if (invStatus === "paid" || invStatus === "cancelled") {
          doc.saveGraphicsState();
          doc.setTextColor(200, 200, 200);
          doc.setFontSize(72);
          doc.setFont("helvetica", "bold");
          doc.text(invStatus.toUpperCase(), pageW / 2, pageH / 2, { align: "center", angle: 30 });
          doc.restoreGraphicsState();
          doc.setTextColor(0, 0, 0);
        }

        // Bill to
        doc.setDrawColor(220);
        doc.setLineWidth(1);
        doc.roundedRect(48, 170, pageW - 96, 78, 10, 10);

        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.text("BILL TO", 64, 192);

        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        const custName = safeText_(invoice.customerName || "");
        const custEmail = safeText_(invoice.customerEmail || "");
        const custPhone = safeText_(invoice.customerPhone || "");

        doc.text(custName, 64, 212);
        let custY = 228;
        if (custEmail) { doc.text(custEmail, 64, custY); custY += 14; }
        if (custPhone) { doc.text(custPhone, 64, custY); custY += 14; }

        // Payment QR (if paymentUrl exists)
        const payUrl = buildInvoicePayUrl_(invoice);
        if (payUrl) {
          try {
            const qr = await qrToDataUrl_(payUrl);
            if (qr) {
              doc.setFont("helvetica", "bold");
              doc.setFontSize(9);
              doc.text("PAY ONLINE", pageW - 150, 192, { align: "center" });
              doc.addImage(qr, "PNG", pageW - 190, 200, 80, 80);
              doc.setFont("helvetica", "normal");
              doc.setFontSize(8);
              doc.text("Scan to pay", pageW - 150, 290, { align: "center" });
            }
          } catch (e) {}
        }

        // Items table header
        let y = 270;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.text("DESCRIPTION", 48, y);
        doc.text("QTY", pageW - 220, y, { align: "right" });
        doc.text("RATE", pageW - 140, y, { align: "right" });
        doc.text("AMOUNT", pageW - 48, y, { align: "right" });
        y += 10;
        doc.setDrawColor(200);
        doc.line(48, y, pageW - 48, y);
        y += 18;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);

        const items = Array.isArray(invoice.items) ? invoice.items : [];
        const maxDescW = pageW - 48 - 240; // leave room for qty/rate/amount
        const lineH = 14;

        const computeTotal = () => items.reduce((sum, it) => {
          const qty = Number(it.qty || 1);
          const rate = Number(it.amount ?? it.unitPriceSnapshot ?? 0);
          return sum + (qty * rate);
        }, 0);

        for (const it of items) {
          const desc = safeText_(it.serviceNameSnapshot || it.description || "");
          const horse = safeText_(it.horseName || "");
          const qty = Number(it.qty || 1);
          const rate = Number(it.amount ?? it.unitPriceSnapshot ?? 0);
          const lineTotal = qty * rate;

          // Page break
          if (y > pageH - 140) {
            doc.addPage();
            y = 72;
          }

          // Description + optional horse/comment
          let yAfter = pdfWrapText_(doc, desc, 48, y, maxDescW, lineH);
          if (horse) {
            doc.setTextColor(90);
            yAfter = pdfWrapText_(doc, `Horse/Comment: ${horse}`, 48, yAfter, maxDescW, lineH);
            doc.setTextColor(0);
          }

          // Numbers aligned to first line y
          doc.text(String(qty), pageW - 220, y, { align: "right" });
          doc.text(money_(rate), pageW - 140, y, { align: "right" });
          doc.text(money_(lineTotal), pageW - 48, y, { align: "right" });

          y = Math.max(yAfter, y + lineH) + 10;
          doc.setDrawColor(235);
          doc.line(48, y - 6, pageW - 48, y - 6);
        }

        // Totals
        const total = money_(invoice.total || computeTotal());
        y += 10;
        if (y > pageH - 110) { doc.addPage(); y = 72; }

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("TOTAL", pageW - 140, y, { align: "right" });
        doc.text(total, pageW - 48, y, { align: "right" });

        // Payment History
        const payments = Array.isArray(invoice.payments) ? invoice.payments : [];
        const paidAmount = invoice.paidAmount || payments.reduce((s,p) => s + (p.amount||0), 0);
        const balanceDue = Math.max(0, (invoice.total || 0) - paidAmount);

        if (payments.length > 0) {
          y += 16;
          if (y > pageH - 160) { doc.addPage(); y = 72; }
          doc.setFont("helvetica", "bold");
          doc.setFontSize(10);
          doc.setTextColor(30);
          doc.text("PAYMENT HISTORY", 48, y);
          y += 8;
          doc.setDrawColor(180);
          doc.line(48, y, pageW - 48, y);
          y += 14;
          doc.setFont("helvetica", "normal");
          doc.setFontSize(9);
          const methodLabels = { cash: 'Cash', check: 'Check', credit_card: 'Credit Card', other: 'Other' };
          for (const p of payments) {
            if (y > pageH - 100) { doc.addPage(); y = 72; }
            const dateStr = p.date ? new Date(p.date).toLocaleDateString() : '';
            const methodStr = methodLabels[p.method] || p.method || '';
            const memoStr = p.memo ? ` â€” ${p.memo}` : '';
            doc.setTextColor(60);
            doc.text(`${dateStr}  ${methodStr}${memoStr}`, 48, y);
            doc.setTextColor(0);
            doc.text(money_(p.amount || 0), pageW - 48, y, { align: 'right' });
            y += 16;
          }
          y += 4;
          doc.setDrawColor(200);
          doc.line(48, y, pageW - 48, y);
          y += 14;
          doc.setFont("helvetica", "bold");
          doc.setFontSize(10);
          doc.text("AMOUNT PAID", pageW - 140, y, { align: "right" });
          doc.text(money_(paidAmount), pageW - 48, y, { align: "right" });
          y += 16;
          if (balanceDue > 0) {
            doc.setTextColor(220, 38, 38);
            doc.text("BALANCE DUE", pageW - 140, y, { align: "right" });
            doc.text(money_(balanceDue), pageW - 48, y, { align: "right" });
            doc.setTextColor(0);
            y += 16;
          } else {
            doc.setTextColor(5, 150, 105);
            doc.text("PAID IN FULL", pageW - 140, y, { align: "right" });
            doc.setTextColor(0);
            y += 16;
          }
        }

        // Footer
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(120);
        doc.text("Thank you for your business.", 48, pageH - 54);
        doc.setTextColor(0);

        const blob = doc.output("blob");
        const url = URL.createObjectURL(blob);
        return url;
      }

      async function openInvoicePdf(invoice, farrierProfile, autoPrint = true) {
        try {
          const url = await generateInvoicePdfBlobUrl(invoice, farrierProfile);
          const w = window.open(url, "_blank", "noopener,noreferrer");
          if (!w) {
            alert("Popup blocked. Please allow popups to view/print the invoice PDF.");
            return;
          }
          if (autoPrint) {
            // Give it a moment to load, then print
            setTimeout(() => {
              try { w.focus(); w.print(); } catch (e) {}
            }, 700);
          }
        } catch (e) {
          console.error("PDF generation failed:", e);
          alert("Could not generate PDF. Check console for details.");
        }
      }

      function emailInvoiceLink(invoice) {
        const payUrl = buildInvoicePayUrl_(invoice);
        const subject = encodeURIComponent(`Invoice ${safeText_(invoice.invoiceNumber || "")}`);
        const lines = [
          `Hi ${safeText_(invoice.customerName || "")},`,
          ``,
          `Here is your invoice: ${safeText_(invoice.invoiceNumber || "")}`,
          payUrl ? `Pay online: ${payUrl}` : ``,
          ``,
          `Thank you!`
        ].filter(Boolean);
        const body = encodeURIComponent(lines.join("\n"));
        const to = encodeURIComponent(safeText_(invoice.customerEmail || ""));
        window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
      }


    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAQ1LaWG9lE9j5h6X0T0YQKa_j04vJZHE4",
      authDomain: "farrier-pro.firebaseapp.com",
      projectId: "farrier-pro",
      storageBucket: "farrier-pro.firebasestorage.app",
      messagingSenderId: "1010833069179",
      appId: "1:1010833069179:web:844b6055462b55640b3ede",
      measurementId: "G-H14XM830EY"
    };

    // Initialize Firebase
    let app, auth, db;
    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(() => {});
      db = firebase.firestore();
    } catch (error) {
      ("Firebase not configured yet - using demo mode");
    }
async function seedDefaultServicesIfEmpty_(userId) {
  if (!db || !userId) return;

 const userRef = db.collection("farriers").doc(userId);
  const userSnap = await userRef.get();
  const userData = userSnap.exists ? userSnap.data() : null;

  if (userData?.servicesSeeded) return;

  const existing = await db.collection("services")
    .where("farrierId", "==", userId)
    .limit(1)
    .get();

  if (!existing.empty) {
    await userRef.set({ servicesSeeded: true }, { merge: true });
    return;
  }

  const defaults = [
    { name: "Hot Shoeing All Four", price: 170, category: "Top Services" },
    { name: "Dressage Shoes All Four", price: 200, category: "Top Services" },
    { name: "Hunter/Jumper Competition Shoes", price: 195, category: "Top Services" },
    { name: "Reset All Four", price: 120, category: "Top Services" },
    { name: "Trim All Four", price: 75, category: "Top Services" },
    { name: "Front Shoes Only", price: 110, category: "Top Services" },
    { name: "Show Prep Package", price: 50, category: "Top Services" },
    { name: "Studs Installation", price: 40, category: "Top Services" },
    { name: "Leather Pads", price: 40, category: "Top Services" },
    { name: "Emergency Call Out", price: 100, category: "Top Services" },
    { name: "Dressage Maintenance Package", price: 210, category: "Packages" },
    { name: "Hunter/Jumper Show Package", price: 250, category: "Packages" },
    { name: "Training Horse Package", price: 165, category: "Packages" },
  ];

  const batch = db.batch();
  const now = firebase.firestore.FieldValue.serverTimestamp();

  defaults.forEach(svc => {
    const ref = db.collection("services").doc();
    batch.set(ref, {
      farrierId: userId,
      name: svc.name,
      price: Number(svc.price || 0),
      category: svc.category || "",
      isActive: true,
      createdAt: now,
      updatedAt: now,
    });
  });

  batch.set(userRef, { servicesSeeded: true }, { merge: true });
  await batch.commit();
  console.log("âœ… Default services seeded");
}

// Ensures the farrier profile doc exists and surfaces permission/config errors clearly
async function ensureFarriTechfile_(uid, profile) {
  if (!db || !uid) throw new Error("Firestore is not initialized.");
  const ref = db.collection("farriers").doc(uid);
  const now = firebase.firestore.FieldValue.serverTimestamp();
  try {
    await ref.set({
      ownerUid: uid,
      farrierId: uid,
      bookingUrl: window.location.origin + "/?farrier=" + uid,
      googleCalendarConnected: false,
      autoPrintPdf: true,
      logoUrl: "",
      ...profile,
      updatedAt: now,
    }, { merge: true });
    const snap = await ref.get();
    if (!snap.exists) {
      throw new Error("Farrier profile was not created. This is usually a Firestore Rules/Permissions issue.");
    }
    return snap.data();
  } catch (e) {
    const code = e?.code || "";
    if (code === "permission-denied") {
      throw new Error("Firestore permission denied while creating your profile. Check Firestore Rules for collection 'farriers'.");
    }
    throw e;
  }
}


    // Google Calendar API Configuration
    const GOOGLE_CLIENT_ID = "458461432563-pkncm66du9pipuihdrbrhfrsuggo7loh.apps.googleusercontent.com";
    const CALENDAR_SCOPES = "https://www.googleapis.com/auth/calendar";

    function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [logoutTimerActive, setLogoutTimerActive] = useState(false);
  const [userProfile, setUserProfile] = useState(null);
  const [showInactivityWarning, setShowInactivityWarning] = useState(false);
  const [inactivityCountdown, setInactivityCountdown] = useState(60);


  const [supportSession, setSupportSession] = useState(null);
  const [effectiveFarrierId, setEffectiveFarrierId] = useState(null);
  const [isSupportMode, setIsSupportMode] = useState(false);

  // URL params (must be defined outside hooks)
  const urlParams = new URLSearchParams(window.location.search);
  const farrierIdParam = urlParams.get("farrier");
  const support = urlParams.has("support");
  const supportSessionId = urlParams.get("supportSession");
  const finishSignup = urlParams.get("finishSignup") === "1" || urlParams.has("leadId") || urlParams.has("lead") || urlParams.has("lid");


  // Support admin gate (must be outside conditional renders)
  const [isAdmin, setIsAdmin] = useState(null);

  useEffect(() => {
    // Only check admin access when support mode is enabled and a user is signed in
    if (!support || !user) {
      setIsAdmin(null);
      return;
    }
    (async () => {
      try {
        const doc = await db.collection("supportAdmins").doc(user.uid).get();
        setIsAdmin(doc.exists && (doc.data()?.active !== false));
      } catch (e) {
        console.error("Admin check failed", e);
        setIsAdmin(false);
      }
    })();
  }, [support, user?.uid]);
  const clearSupportSession = async () => {
    try {
      if (supportSessionId && db) {
        await db.collection("supportSessions").doc(supportSessionId).update({
          endedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
      }
    } catch (e) {
      console.error("Failed to end support session:", e);
    }

    const u = new URL(window.location.href);
    u.searchParams.delete("supportSession");
    window.location.href = u.toString();
  };

  useEffect(() => {
    if (!auth) {
      setLoading(false);
      return;
    }

    let logoutTimer = null;
    let hasEverSignedIn = false;
    const unsubscribe = auth.onAuthStateChanged(async (u) => {
      try {
        if (!u) {
          const delay = hasEverSignedIn ? 5000 : 0;
          console.warn("âš ï¸ onAuthStateChanged fired NULL. hasEverSignedIn:", hasEverSignedIn, "Stack:", new Error().stack.split("\n").slice(1,4).join(" | "));
          setLogoutTimerActive(true);
          logoutTimer = setTimeout(() => {
            console.error("ðŸ”´ Logout timer expired - signing out. Auth state:", auth.currentUser);
            setLogoutTimerActive(false);
            setUser(null);
            setUserProfile(null);
            setSupportSession(null);
            setEffectiveFarrierId(null);
            setIsSupportMode(false);
          }, delay);
          return;
        }
        // User is signed in - cancel any pending logout
        console.log("âœ… onAuthStateChanged fired with user:", u.uid, u.email);
        hasEverSignedIn = true;
        if (logoutTimer) { clearTimeout(logoutTimer); logoutTimer = null; setLogoutTimerActive(false); }

        setUser(u);

        // Default to the signed-in farrier
        let farrierIdToUse = u.uid;
        let supportSessionData = null;

        // If a support session is present, validate it and switch context
        if (supportSessionId && db) {
          const ssDoc = await db.collection("supportSessions").doc(supportSessionId).get();
          if (ssDoc.exists) {
            const ss = ssDoc.data();
            const now = Date.now();
            const expired = ss.expiresAt?.toDate && ss.expiresAt.toDate().getTime() < now;
            const ended = !!ss.endedAt;
            const wrongUser = ss.supportAgentUid && ss.supportAgentUid !== u.uid;

            if (!expired && !ended && !wrongUser && ss.targetFarrierId) {
              supportSessionData = ss;
              farrierIdToUse = ss.targetFarrierId;
            }
          }
        }

        setSupportSession(supportSessionData);
        setIsSupportMode(!!supportSessionData);
        setEffectiveFarrierId(farrierIdToUse);

        // Load profile for effective farrier
       if (db && !finishSignup) {
          const profileDoc = await db.collection("farriers").doc(farrierIdToUse).get();

          // If the user can authenticate but has no profile doc, create one now.
          if (!profileDoc.exists) {
            try {
              const baseProfile = {
                email: u?.email || "",
                businessName: u?.displayName || "My Farrier Business",
                ownerUid: farrierIdToUse,
                farrierId: farrierIdToUse,
                bookingUrl: window.location.origin + "/?farrier=" + farrierIdToUse,
                googleCalendarConnected: false,
                autoPrintPdf: true,
                logoUrl: "",
                status: "active",
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              };
              await ensureFarriTechfile_(farrierIdToUse, baseProfile);
              const createdSnap = await db.collection("farriers").doc(farrierIdToUse).get();
              setUserProfile(createdSnap.exists ? createdSnap.data() : baseProfile);
            } catch (e) {
              console.error("âŒ Could not auto-create missing farrier profile doc", e);
              setUserProfile(null);
            }
          } else {
            setUserProfile(profileDoc.data());
          }
} else {
          setUserProfile(null);
        }
      } catch (e) {
        console.error("Auth/profile load failed:", e);
      } finally {
        setLoading(false);
      }
    });

    return () => { unsubscribe(); if (logoutTimer) clearTimeout(logoutTimer); };
  }, [supportSessionId]);

  // â”€â”€ Inactivity timer - 30 min then warning, 60s then logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    if (!user) return;

    const INACTIVE_MS = 30 * 60 * 1000; // 30 minutes
    const COUNTDOWN_S = 60;

    let inactivityTimer = null;
    let countdownTimer = null;
    let countdownValue = COUNTDOWN_S;

    const resetTimer = () => {
      if (showInactivityWarning) return; // don't reset if warning is showing
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        setShowInactivityWarning(true);
        setInactivityCountdown(COUNTDOWN_S);
        countdownValue = COUNTDOWN_S;
        countdownTimer = setInterval(() => {
          countdownValue -= 1;
          setInactivityCountdown(countdownValue);
          if (countdownValue <= 0) {
            clearInterval(countdownTimer);
            setShowInactivityWarning(false);
            auth.signOut();
          }
        }, 1000);
      }, INACTIVE_MS);
    };

    const stayLoggedIn = () => {
      setShowInactivityWarning(false);
      clearInterval(countdownTimer);
      countdownValue = COUNTDOWN_S;
      setInactivityCountdown(COUNTDOWN_S);
      resetTimer();
    };

    // Store stayLoggedIn so we can call it from the modal
    window.__farritech_stayLoggedIn = stayLoggedIn;

    const events = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart', 'click'];
    events.forEach(e => window.addEventListener(e, resetTimer, { passive: true }));

    resetTimer();

    return () => {
      clearTimeout(inactivityTimer);
      clearInterval(countdownTimer);
      events.forEach(e => window.removeEventListener(e, resetTimer));
      delete window.__farritech_stayLoggedIn;
    };
  }, [user]);

  // Show spinner while loading OR while waiting to confirm logout (prevents flash to login)
  if (loading || (logoutTimerActive)) {
    return (
      <div style={{display: "flex", justifyContent: "center", alignItems: "center", height: "100vh"}}>
        <div className="spinner"></div>
      </div>
    );
  }

  // Customer booking view
  if (farrierIdParam) {
    return <CustomerBookingView farrierId={farrierIdParam} />;
  }

  // Support portal view
if (support) {
  if (!user) return <AuthView />;

  // Firestore-based admin gate (easy + no custom claims)
  if (isAdmin === null) {
    return (
      <div className="page">
        <div className="card">
          <h2>Checking accessâ€¦</h2>
          <p>Loading support portalâ€¦</p>
        </div>
      </div>
    );
  }

  if (!isAdmin) {
    return (
      <div className="page">
        <div className="card">
          <h2>Access denied</h2>
          <p>This account is not allowed to access the support portal.</p>
        </div>
      </div>
    );
  }

  return <SupportPortal user={user} />;
}

 // Finish signup (post-billing activation)
if (finishSignup) {
  // Only sign out a pre-existing cached session, never one just created by handleComplete
  if (user && !window.__finishSignupInProgress__) {
    auth.signOut().catch(() => {});
    return null;
  }
  return <FinishSignupView />;
}

  // Authentication view
  if (!user) {
    return <AuthView />;
  }

  // Farrier dashboard (+ support banner)
  return (
    <>
      {/* Inactivity Warning Modal */}
      {showInactivityWarning && (
        <div style={{position:'fixed', inset:0, background:'rgba(0,0,0,0.6)', zIndex:99999, display:'flex', alignItems:'center', justifyContent:'center'}}>
          <div style={{background:'white', borderRadius:'12px', padding:'2rem', maxWidth:'420px', width:'90%', textAlign:'center', boxShadow:'0 20px 60px rgba(0,0,0,0.3)'}}>
            <div style={{fontSize:'3rem', marginBottom:'1rem'}}>â±ï¸</div>
            <h2 style={{marginBottom:'0.75rem', color:'#1a1a1a'}}>Still there?</h2>
            <p style={{color:'#666', marginBottom:'1.5rem'}}>
              You've been inactive for 30 minutes. For your security, you'll be logged out in:
            </p>
            <div style={{fontSize:'3rem', fontWeight:'700', color:'#ef4444', marginBottom:'1.5rem'}}>
              {inactivityCountdown}s
            </div>
            <div style={{display:'flex', gap:'0.75rem', justifyContent:'center'}}>
              <button
                className="btn btn-outline"
                onClick={() => { auth.signOut(); setShowInactivityWarning(false); }}
                style={{flex:1}}
              >
                Log Out Now
              </button>
              <button
                className="btn btn-primary"
                onClick={() => window.__farritech_stayLoggedIn && window.__farritech_stayLoggedIn()}
                style={{flex:1}}
                autoFocus
              >
                Stay Logged In
              </button>
            </div>
          </div>
        </div>
      )}

      {isSupportMode && (
        <div style={{padding:"10px", background:"#ffefef", border:"1px solid #ffb3b3", borderRadius:"8px", margin:"12px"}}>
          <strong>SUPPORT MODE</strong>
          {supportSession?.reason ? ` â€” ${supportSession.reason}` : ""}
          <div style={{marginTop:"8px"}}>
            <button className="btn btn-secondary" onClick={clearSupportSession}>
              End Support Session
            </button>
          </div>
        </div>
      )}

      <FarrierDashboard
        user={user}
        userProfile={userProfile}
        setUserProfile={setUserProfile}
        farrierId={effectiveFarrierId || user.uid}
        isSupportMode={isSupportMode}
        supportSession={supportSession}
        clearSupportSession={clearSupportSession}
      />
    </>
  );
}

function AuthView() {
      const [mode, setMode] = useState('login'); // 'login' or 'signup'
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [businessName, setBusinessName] = useState('');
      const [phone, setPhone] = useState('');
      const [address, setAddress] = useState('');
      const [city, setCity] = useState('');
      const [state, setState] = useState('');
      const [zip, setZip] = useState('');
      const [logoUrl, setLogoUrl] = useState('');
      const [autoPrintPdf, setAutoPrintPdf] = useState(true);
      const [error, setError] = useState('');
      
      
      // (removed) userProfile sync belongs in SettingsView
const [loading, setLoading] = useState(false);
      const [successMessage, setSuccessMessage] = useState('');

      const handleForgotPassword = async () => {
        if (!email) {
          setError('Please enter your email address first');
          return;
        }
        
        setError('');
        setLoading(true);
        
        try {
          if (!auth) {
            setError('Firebase not configured. Please add your Firebase credentials.');
            setLoading(false);
            return;
          }
          await auth.sendPasswordResetEmail(email);
          setSuccessMessage('Password reset email sent! Check your inbox.');
          setError('');
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        
        try {
          if (!auth) {
            setError('Firebase not configured. Please add your Firebase credentials.');
            setLoading(false);
            return;
          }
          await auth.signInWithEmailAndPassword(email, password);
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      const handleGoogleSignIn = async () => {
        setError('');
        setLoading(true);
        
        try {
          if (!auth) {
            setError('Firebase not configured.');
            setLoading(false);
            return;
          }

          const provider = new firebase.auth.GoogleAuthProvider();
          const result = await auth.signInWithPopup(provider);
          const user = result.user;

          // Check if user profile exists
          const profileDoc = await db.collection('farriers').doc(user.uid).get();
          
          if (!profileDoc.exists) {
            // First time Google sign-in - create profile
            await ensureFarriTechfile_(user.uid, {
              businessName: user.displayName || 'My Farrier Business',
              email: user.email,
              phone: '',
              address: '',
              city: '',
              state: '',
              zip: '',
              ownerUid: user.uid,
              farrierId: user.uid,
              logoUrl: '',
              autoPrintPdf: true,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              googleCalendarConnected: false,
              bookingUrl: window.location.origin + '?farrier=' + user.uid
            });
}
          
          // User will be automatically logged in by Firebase
        } catch (err) {
          if (err.code !== 'auth/popup-closed-by-user') {
            setError(err.message);
          }
        }
        setLoading(false);
      };

    const handleSignup = async (e) => {
  e.preventDefault();
  setError('');
  setLoading(true);

  try {
    if (!auth || !db) {
      setError('Firebase not configured.');
      setLoading(false);
      return;
    }

    // 1) Create Firebase Auth user
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    const user = cred.user;

    // 2) Set display name (optional)
    try {
      await user.updateProfile({ displayName: businessName || "" });
    } catch (e) {
      console.warn("Could not set displayName", e);
    }

    // 3) Send verification email (optional)
    try { await user.sendEmailVerification(); } catch (e) {}

    // 4) Create/merge farrier profile doc
    await ensureFarriTechfile_(user.uid, {
      businessName: businessName || 'My Farrier Business',
      email: email || user.email || '',
      phone: phone || '',
      address: address || '',
      city: city || '',
      state: (state || '').toUpperCase(),
      zip: zip || '',
      ownerUid: user.uid,
      farrierId: user.uid,
      logoUrl: logoUrl || '',
      autoPrintPdf: autoPrintPdf ?? true,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      googleCalendarConnected: false,
      bookingUrl: window.location.origin + '?farrier=' + user.uid
    });

    // 5) Seed default services (if empty)
    try { await seedDefaultServicesIfEmpty_(user.uid); } catch (e) {}

    alert('Welcome! Please check your email to verify your account.');
  } catch (err) {
    setError(err?.message || String(err));
  }

  setLoading(false);
};

return (
<div className="auth-page ft-auth-wrap">    
  <section className="auth-hero">
            <div className="auth-hero-content">
              <h2>Run Your Hoof Care Business Like a Pro.</h2>
              <p>Scheduling. Payments. Clients.<br />All in one place.</p>
            </div>
          </section>

          <section className="auth-panel">
            <div className="auth-container">
            <div className="auth-card">
              <div className="brand-lockup">
                <img src="new_farritech_logo.png" alt="FarriTech" />
              </div>
              <div className="auth-header">
                <h1>Welcome Back</h1>
                <p>Manage your farrier business with ease</p>
              </div>

              <div className="auth-tabs">
                <button 
                  className={`auth-tab ${mode === 'login' ? 'active' : ''}`}
                  onClick={() => setMode('login')}
                >
                  Login
                </button>
                
<button 
  className="auth-tab"
  onClick={() => {
    const returnUrl = encodeURIComponent(`${window.location.origin}/?finishSignup=1`);
    window.location.href = `https://farrier-pro-landing-page.vercel.app/?returnUrl=${returnUrl}`;
  }}
>
  Sign Up
</button>

              </div>

              {error && <div className="error-message">{error}</div>}
              {successMessage && <div className="success-message">{successMessage}</div>}

              <form onSubmit={handleLogin}>
                {mode === 'signup' && (
                  <>
                    <div className="form-group">
                      <label>Business Name *</label>
                      <input 
                        type="text"
                        required
                        value={businessName}
                        onChange={(e) => setBusinessName(e.target.value)}
                        placeholder="John's Farrier Services"
                      />
              <label style={{marginTop:'10px'}}>Logo URL (optional)</label>
              <input
                type="text"
                value={logoUrl}
                onChange={(e)=>setLogoUrl(e.target.value)}
                placeholder="https://.../logo.png"
              />

              <div style={{display:'flex', alignItems:'center', gap:'10px', marginTop:'10px'}}>
                <input type="checkbox" checked={Boolean(autoPrintPdf)} onChange={(e)=>setAutoPrintPdf(e.target.checked)} />
                <span>Auto-open PDF after creating an invoice</span>
              </div>
              <div style={{display:'flex', alignItems:'center', gap:'10px', marginTop:'10px'}}>
                <input type="checkbox" checked={Boolean(allowManualPayments)} onChange={(e)=>setAllowManualPayments(e.target.checked)} />
                <span>Allow manual payments (Cash / Check) on invoices</span>
              </div>

                    </div>
                    
                    <div className="form-group">
                      <label>Phone Number *</label>
                      <input 
                        type="tel"
                        required
                        value={phone}
                        onChange={(e) => setPhone(e.target.value)}
                        placeholder="(555) 555-5555"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Business Address *</label>
                      <input 
                        type="text"
                        required
                        value={address}
                        onChange={(e) => setAddress(e.target.value)}
                        placeholder="123 Main Street"
                      />
                    </div>
                    
                    <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem'}}>
                      <div className="form-group">
                        <label>City *</label>
                        <input 
                          type="text"
                          required
                          value={city}
                          onChange={(e) => setCity(e.target.value)}
                          placeholder="City"
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>State *</label>
                        <input 
                          type="text"
                          required
                          value={state}
                          onChange={(e) => setState(e.target.value.toUpperCase())}
                          placeholder="VA"
                          maxLength="2"
                          style={{textTransform: 'uppercase'}}
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>ZIP *</label>
                        <input 
                          type="text"
                          required
                          value={zip}
                          onChange={(e) => setZip(e.target.value)}
                          placeholder="12345"
                          maxLength="5"
                          pattern="[0-9]{5}"
                        />
                      </div>
                    </div>
                  </>
                )}

                <div className="form-group">
                  <label>Email</label>
                  <input 
                    type="email"
                    required
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="your@email.com"
                  />
                </div>

                <div className="form-group">
                  <label>Password</label>
                  <input 
                    type="password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                    minLength={6}
                  />
                </div>

                <button 
                  type="submit" 
                  className="btn btn-primary" 
                  style={{width: '100%'}}
                  disabled={loading}
                >
                  {loading ? <span className="spinner"></span> : (mode === 'login' ? 'Login' : 'Create Account')}
                </button>

                {/* Divider */}
                <div style={{display: 'flex', alignItems: 'center', margin: '1.5rem 0', gap: '1rem'}}>
                  <div style={{flex: 1, height: '1px', background: 'rgba(234,242,255,0.18)'}}></div>
                  <span style={{color: 'rgba(234,242,255,0.65)', fontSize: '0.875rem'}}>OR</span>
                  <div style={{flex: 1, height: '1px', background: 'rgba(234,242,255,0.18)'}}></div>
                </div>

                {/* Google Sign-In Button */}
                <button 
                  type="button"
                  onClick={handleGoogleSignIn}
                  className="btn"
                  disabled={loading}
                  style={{
                    width: '100%',
                    background: 'white',
                    color: '#444',
                    border: '1px solid #ddd',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '0.75rem',
                    fontWeight: '500'
                  }}
                >
                  <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/>
                    <path d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
                    <path d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.17.282-1.709V4.958H.957C.347 6.173 0 7.548 0 9c0 1.452.348 2.827.957 4.042l3.007-2.335z" fill="#FBBC05"/>
                    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                  </svg>
                  {mode === 'login' ? 'Sign in with Google' : 'Sign up with Google'}
                </button>
                
                {mode === 'login' && (
                  <div style={{textAlign: 'center', marginTop: '1rem'}}>
                    <button 
                      type="button"
                      onClick={handleForgotPassword}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: 'var(--primary)',
                        textDecoration: 'underline',
                        cursor: 'pointer',
                        fontSize: '0.875rem'
                      }}
                    >
                      Forgot password?
                    </button>
                  </div>
                )}
              </form>
            </div>
          </div>
          </section>
        </div>
      );
    }
    function FinishSignupView() {
  const urlParams = new URLSearchParams(window.location.search);
  const leadId = urlParams.get("leadId") || urlParams.get("lead") || urlParams.get("lid");
  const subscriptionId = urlParams.get("sub") || urlParams.get("subscriptionId") || "";
  const emailFromUrl = urlParams.get("email") || "";
  const phoneFromUrl = urlParams.get("phone") || "";
  const businessNameFromUrl = urlParams.get("businessName") || "";
  const addressFromUrl = urlParams.get("address") || "";
  const cityFromUrl = urlParams.get("city") || "";
  const stateFromUrl = urlParams.get("state") || "";
  const zipFromUrl = urlParams.get("zip") || "";

  const [loading, setLoading] = useState(true);
  const [lead, setLead] = useState(null);

  const [email, setEmail] = useState(emailFromUrl);
  const [businessName, setBusinessName] = useState(businessNameFromUrl);
  const [phone, setPhone] = useState(phoneFromUrl);
  const [address, setAddress] = useState(addressFromUrl);
  const [city, setCity] = useState(cityFromUrl);
  const [state, setState] = useState(stateFromUrl);
  const [zip, setZip] = useState(zipFromUrl);

  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [error, setError] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const cleanupUrl = () => {
    const u = new URL(window.location.href);
    ["finishSignup","leadId","lead","lid","sub","subscriptionId","email","from","phone","businessName","address","city","state","zip"].forEach(k =>
      u.searchParams.delete(k)
    );
    window.history.replaceState({}, document.title, u.toString());
  };


     useEffect(() => {
    (async () => {
      try {
        if (!db || !leadId) return;

        const snap = await db.collection("leads").doc(leadId).get();
        if (!snap.exists) return;

        const d = snap.data() || {};
        const ba = d.billingAddress || {};

        setLead(d);

        if (!emailFromUrl && d.email) setEmail(d.email);
        setBusinessName(prev => prev || (d.businessName || d.company || d.name || ""));
        setPhone(prev => prev || (d.phone || ""));
        setFirstName(prev => prev || (d.firstName || ""));
        setLastName(prev => prev || (d.lastName || ""));

        setAddress(prev => prev || (ba.address || ""));
        setCity(prev => prev || (ba.city || ""));
        setState(prev => prev || (ba.state || ""));
        setZip(prev => prev || (ba.zip || ""));
      } catch (e) {
        console.error("Failed to load lead", e);
      } finally {
        setLoading(false);
      }
    })();
  }, [leadId]);

  const handleComplete = async (e) => {
    window.__finishSignupInProgress__ = true;
    e.preventDefault();
    setError("");
    setSuccessMessage("");

    if (!email) return setError("Email is required.");
    if (!password || password.length < 8) return setError("Password must be at least 8 characters.");
    if (password !== confirmPassword) return setError("Passwords do not match.");

    try {
      if (!auth || !db) throw new Error("Firebase is not initialized.");

      const cred = await auth.createUserWithEmailAndPassword(email, password);
      // Use cred.user directly â€” it is guaranteed to be the newly created user
      const newUser = cred.user;
      let uid = newUser.uid;
      console.log("âœ… Auth user created, UID:", uid);

      // Force token refresh so Firestore sees request.auth
      // Wait until Firestore's internal auth listener sees this exact UID
      await new Promise((resolve, reject) => {
        const timeout = setTimeout(() => reject(new Error("Auth state timeout")), 10000);
        const unsub = auth.onAuthStateChanged((u) => {
          if (u && u.uid === uid) {
            clearTimeout(timeout);
            unsub();
            resolve(u);
          }
        });
      });
      await newUser.getIdToken(true);
      console.log("âœ… Token refreshed, proceeding to Firestore write");

// Use the authenticated UID from the live session
// âœ… Always fetch the lead fresh right before creating farrierDoc (no reliance on React state)
let leadSnapData = null;
if (leadId && db) {
  try {
    const snap = await db.collection("leads").doc(leadId).get();
    leadSnapData = snap.exists ? (snap.data() || null) : null;
  } catch (e) {
    console.warn("Could not fetch lead during signup submit", e);
  }
}

const ba = (leadSnapData && leadSnapData.billingAddress) ? leadSnapData.billingAddress : {};

      // Build farrier profile using form first, then lead fallbacks
     const farrierDoc = {
  ownerUid: uid,
  farrierId: uid,
  status: "active",

  businessName: businessName || (leadSnapData && leadSnapData.businessName) || "My Farrier Business",
  firstName: firstName || (leadSnapData && leadSnapData.firstName) || "",
  lastName: lastName || (leadSnapData && leadSnapData.lastName) || "",
  email: email || cred.user.email || "",

  phone: phone || (leadSnapData && leadSnapData.phone) || "",

  address: address || ba.address || "",
  city: city || ba.city || "",
  state: ((state || ba.state || "") + "").toUpperCase(),
  zip: zip || ba.zip || "",

  bookingUrl: window.location.origin + "/?farrier=" + uid,
  googleCalendarConnected: false,
  autoPrintPdf: true,
  logoUrl: "",

  subscriptionId: subscriptionId || "",
  leadId: leadId || "",

  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
};

console.log("âœ… Writing farrier doc, UID:", uid, "farrierId:", farrierDoc?.farrierId);

      
      // âœ… Write the farrier profile to Firestore
      try {
        await ensureFarriTechfile_(uid, farrierDoc);
        console.log("âœ… Farrier profile written successfully");
      } catch (writeErr) {
        console.error("âŒ ensureFarriTechfile_ failed:", writeErr?.code, writeErr?.message);
        throw writeErr;
      }

      // Link the lead to the new farrier (merge so we don't overwrite lead fields)
      if (leadId) {
        try {
          await db.collection("leads").doc(leadId).set({
            farrierId: uid,
            subscriptionId: subscriptionId || "",
            activatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          }, { merge: true });
        } catch (e) {
          console.warn("Could not update lead with farrierId", e);
        }
      }

      // Seed default services
      try { await seedDefaultServicesIfEmpty_(uid); } catch (e) {}

      setSuccessMessage("Account created! Redirecting to your dashboardâ€¦");
      cleanupUrl();
      setTimeout(() => {
        window.location.href = window.location.origin + window.location.pathname;
      }, 800);

    } catch (err) {
      console.error("Finish signup error:", err);
      const code = err?.code || "";

      if (code === "auth/email-already-in-use") {
        // Auth user was created on a previous attempt but Firestore write failed.
        // Try signing in and finishing the profile write.
        try {
          const signInCred = await auth.signInWithEmailAndPassword(email, password);
          const existingUser = signInCred.user;
          await existingUser.getIdToken(true);
          const recoveryUid = existingUser.uid;
          console.log("ðŸ”„ Recovery: signed in existing user, UID:", recoveryUid);

          let recoveryLeadData = null;
          if (leadId && db) {
            try {
              const s = await db.collection("leads").doc(leadId).get();
              recoveryLeadData = s.exists ? (s.data() || null) : null;
            } catch (e) {}
          }
          const recoveryBa = (recoveryLeadData && recoveryLeadData.billingAddress) ? recoveryLeadData.billingAddress : {};

          const recoveryDoc = {
            ownerUid: recoveryUid, farrierId: recoveryUid, status: "active",
            businessName: businessName || (recoveryLeadData && recoveryLeadData.businessName) || "My Farrier Business",
            firstName: firstName || (recoveryLeadData && recoveryLeadData.firstName) || "",
            lastName: lastName || (recoveryLeadData && recoveryLeadData.lastName) || "",
            email: email,
            phone: phone || (recoveryLeadData && recoveryLeadData.phone) || "",
            address: address || recoveryBa.address || "",
            city: city || recoveryBa.city || "",
            state: ((state || recoveryBa.state || "") + "").toUpperCase(),
            zip: zip || recoveryBa.zip || "",
            bookingUrl: window.location.origin + "/?farrier=" + recoveryUid,
            googleCalendarConnected: false, autoPrintPdf: true, logoUrl: "",
            subscriptionId: subscriptionId || "", leadId: leadId || "",
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          };

          await ensureFarriTechfile_(recoveryUid, recoveryDoc);
          if (leadId) {
            try {
              await db.collection("leads").doc(leadId).set({
                farrierId: recoveryUid, subscriptionId: subscriptionId || "",
                activatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              }, { merge: true });
            } catch (e) {}
          }
          try { await seedDefaultServicesIfEmpty_(recoveryUid); } catch (e) {}
          setSuccessMessage("Account created! Redirecting to your dashboardâ€¦");
          cleanupUrl();
          setTimeout(() => { window.location.href = window.location.origin + window.location.pathname; }, 800);
          return;
        } catch (signInErr) {
          console.error("âŒ Recovery sign-in failed:", signInErr?.code, signInErr?.message);
          return setError("This email already has an account. Please log in instead.");
        }
      }
      if (code === "auth/weak-password") return setError("Password is too weak.");

      setError(err?.message || "Signup failed.");
    }
  };

  return (
    <div className="app-container">
      <header className="app-header">
        <div className="header-content">
          <div className="logo">
            <span className="logo-icon">ðŸ´</span>
            <span>FarriTech</span>
          </div>
        </div>
      </header>

      <div className="auth-container">
        <div className="auth-card">
          <div className="auth-header">
            <h1>Complete Your Account</h1>
            <p>Create your login to access the FarriTech dashboard.</p>
          </div>

          {error && <div className="error-message">{error}</div>}
          {successMessage && <div className="success-message">{successMessage}</div>}

          <form onSubmit={handleComplete}>
            <div className="form-group">
              <label>Email *</label>
              <input type="email" required value={email} onChange={(e)=>setEmail(e.target.value)} />
            </div>

            <div className="form-group">
              <label>Business Name *</label>
              <input type="text" required value={businessName} onChange={(e)=>setBusinessName(e.target.value)} placeholder="John's Farrier Services" />
            </div>

            <div className="form-group">
              <label>Phone Number *</label>
              <input type="tel" required value={phone} onChange={(e)=>setPhone(e.target.value)} placeholder="(555) 555-5555" />
            </div>

            <div className="form-group">
              <label>Business Address *</label>
              <input type="text" required value={address} onChange={(e)=>setAddress(e.target.value)} placeholder="123 Main Street" />
            </div>

            <div style={{display:'grid', gridTemplateColumns:'2fr 1fr 1fr', gap:'0.75rem'}}>
              <div className="form-group">
                <label>City *</label>
                <input type="text" required value={city} onChange={(e)=>setCity(e.target.value)} placeholder="City" />
              </div>
              <div className="form-group">
                <label>State *</label>
                <input type="text" required value={state} onChange={(e)=>setState(e.target.value.toUpperCase())} placeholder="FL" maxLength="2" style={{textTransform:'uppercase'}} />
              </div>
              <div className="form-group">
                <label>ZIP *</label>
                <input type="text" required value={zip} onChange={(e)=>setZip(e.target.value)} placeholder="12345" maxLength="5" pattern="[0-9]{5}" />
              </div>
            </div>

            <div className="form-group">
              <label>Password *</label>
              <input type="password" required value={password} onChange={(e)=>setPassword(e.target.value)} />
            </div>

            <div className="form-group">
              <label>Confirm Password *</label>
              <input type="password" required value={confirmPassword} onChange={(e)=>setConfirmPassword(e.target.value)} />
            </div>

            <button type="submit" className="btn btn-primary" style={{width:"100%", marginTop:"8px"}}>
              Create Account
            </button>
          </form>

          <div style={{marginTop:"14px", fontSize:"13px", color:"var(--text-muted)"}}>
            {subscriptionId ? <div><strong>Subscription:</strong> {subscriptionId}</div> : null}
            {leadId ? <div><strong>Lead:</strong> {leadId}</div> : null}
          </div>

          <div style={{marginTop:"16px", textAlign:"center"}}>
            <a
              href={window.location.origin}
              style={{color:"var(--primary)", textDecoration:"none", fontWeight:600}}
              onClick={(e) => { e.preventDefault(); cleanupUrl(); window.location.href = window.location.origin; }}
            >
              Back to Login
            </a>
          </div>
        </div>
      </div>
    </div>
  );
}


   function SupportPortal({ user }) {
  const [q, setQ] = useState('');
  const [farriers, setFarriers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [reason, setReason] = useState('Troubleshooting');

  useEffect(() => {
    (async () => {
      if (!db) return;
      const snap = await db.collection('farriers').get();
      setFarriers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      setLoading(false);
    })();
  }, []);

  const filtered = farriers.filter(f => {
    const s = (q || '').toLowerCase();
    return (
      (f.businessName || '').toLowerCase().includes(s) ||
      (f.email || '').toLowerCase().includes(s) ||
      (f.phone || '').toLowerCase().includes(s)
    );
  });

  const startSession = async (targetFarrierId) => {
    const expires = new Date(Date.now() + 30 * 60 * 1000); // 30 minutes

    const docRef = await db.collection('supportSessions').add({
      supportAgentUid: user.uid,
      targetFarrierId,
      reason,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      expiresAt: firebase.firestore.Timestamp.fromDate(expires),
      endedAt: null
    });

    // Redirect into the normal app in support mode
    const u = new URL(window.location.href);
    u.searchParams.delete('support');
    u.searchParams.set('supportSession', docRef.id);
    window.location.href = u.toString();
  };

  return (
    <div className="app-container">
      <header className="app-header">
        <div className="header-content">
          <div className="logo">
            <span className="logo-icon">ðŸ´</span>
            <span>Support Portal</span>
          </div>
        </div>
      </header>

      <div className="auth-container">
        <div className="card">
          <h2>Impersonate a Farrier</h2>

          <div className="form-group">
            <label>Search</label>
            <input value={q} onChange={(e)=>setQ(e.target.value)} placeholder="business, email, phone..." />
          </div>

          <div className="form-group">
            <label>Reason (required)</label>
            <input value={reason} onChange={(e)=>setReason(e.target.value)} />
          </div>

          {loading ? (
            <p>Loadingâ€¦</p>
          ) : (
            <div style={{marginTop:'12px'}}>
              {filtered.map(f => (
                <div key={f.id} className="card" style={{marginBottom:'10px'}}>
                  <div><strong>{f.businessName || '(no business name)'}</strong></div>
                  <div style={{color:'var(--text-muted)'}}>{f.email || ''} {f.phone ? `â€¢ ${f.phone}` : ''}</div>
                  <div style={{marginTop:'8px'}}>
                    <button className="btn btn-primary" onClick={()=>startSession(f.id)}>
                      Login as this Farrier
                    </button>
                  </div>
                </div>
              ))}
              {filtered.length === 0 && <p style={{color:'var(--text-muted)'}}>No matches.</p>}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}


function FarrierDashboard({ user, userProfile, setUserProfile, farrierId, isSupportMode, supportSession, clearSupportSession }) {

      const [tab, setTab] = useState('qrcode');
      const [showQRModal, setShowQRModal] = useState(false);

      const handleLogout = async () => {
        if (auth) {
          await auth.signOut();
        }
      };

      const connectGoogleCalendar = async () => {
        try {
          // TEMPORARY: Use old token client method until API is working
          // This gives 1-hour tokens but at least it works
          const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/calendar',
            callback: async (response) => {
              if (response.access_token) {
                // Save token to Firestore
                if (db) {
                  await db.collection('farriers').doc(farrierId).update({
                    googleCalendarConnected: true,
                    googleAccessToken: response.access_token,
                    googleTokenExpiry: Date.now() + (3600 * 1000) // 1 hour
                  });
                  
                  // Reload profile from Firestore
                  const profileDoc = await db.collection('farriers').doc(farrierId).get();
                  if (profileDoc.exists) {
                    setUserProfile(profileDoc.data());
                  }
                  
                  alert('âœ… Google Calendar connected! (Note: You may need to reconnect in 1 hour until refresh tokens are set up)');
                }
              }
            },
          });
          tokenClient.requestAccessToken();
        } catch (error) {
          console.error('Error connecting Google Calendar:', error);
          alert('Error connecting Google Calendar');
        }
      };

      const disconnectGoogleCalendar = async () => {
        if (confirm('Are you sure you want to disconnect Google Calendar? Future appointments will not sync to your calendar.')) {
          try {
            if (db) {
              await db.collection('farriers').doc(farrierId).update({
                googleCalendarConnected: false,
                googleAccessToken: firebase.firestore.FieldValue.delete(),
                googleRefreshToken: firebase.firestore.FieldValue.delete(),
                googleTokenExpiry: firebase.firestore.FieldValue.delete()
              });
              
              // Reload profile from Firestore
              const profileDoc = await db.collection('farriers').doc(farrierId).get();
              if (profileDoc.exists) {
                setUserProfile(profileDoc.data());
              }
              
              alert('Google Calendar disconnected successfully!');
            }
          } catch (error) {
            console.error('Error disconnecting:', error);
            alert('Error disconnecting Google Calendar');
          }
        }
      };

      const tabs = [
        { id: 'qrcode', label: 'My QR Code', icon: 'ðŸ“±' },
        { id: 'dashboard', label: 'Dashboard', icon: 'ðŸ“Š' },
        { id: 'calendar', label: 'Calendar', icon: 'ðŸ“…' },
        { id: 'appointments', label: 'Appointments', icon: 'ðŸ“‹' },
        { id: 'invoices', label: 'Invoices', icon: 'ðŸ’°' },
        { id: 'services', label: 'Services', icon: 'ðŸ§¾' },
        { id: 'reports', label: 'Reports', icon: 'ðŸ“ˆ' },
        { id: 'settings', label: 'Settings', icon: 'âš™ï¸' },
        { id: 'about', label: 'About', icon: 'â„¹ï¸' }
      ];

      return (
        <div className="app-container">
          <header className="app-header">
            <div className="header-content">
              <div className="logo">
                <span className="logo-icon">ðŸ´</span>
                <div style={{display:'flex',flexDirection:'column',lineHeight:'1.1'}}>
                  <span>FarriTech</span>
                  <span style={{fontSize:'0.7rem',color:'#ffffff',fontWeight:'400'}}>{BUILD_VERSION}</span>
                </div>
              </div>
              <div className="header-actions">
                <div className="user-info">
                  {userProfile?.businessName || user.email}
                </div>
                <button 
                  className="btn btn-sm" 
                  onClick={handleLogout}
                  style={{background: 'white', color: 'var(--primary)', fontWeight: '600'}}
                >
                  ðŸšª Logout
                </button>
              </div>
            </div>
          </header>

          <main className="main-content">
            <div className="tabs">
              {tabs.map(t => (
                <button 
                  key={t.id}
                  className={`tab ${tab === t.id ? 'active' : ''}`}
                  onClick={() => setTab(t.id)}
                >
                  {t.icon} {t.label}
                </button>
              ))}
            </div>

            {tab === 'qrcode' && (
              <QRCodeView 
                user={user} 
                userProfile={userProfile}
                connectGoogleCalendar={connectGoogleCalendar}
                disconnectGoogleCalendar={disconnectGoogleCalendar}
              />
            )}
            {tab === 'dashboard' && <DashboardView userId={farrierId} />}
            {tab === 'calendar' && <CalendarView userId={farrierId} />}
            {tab === 'appointments' && <AppointmentsView userId={farrierId} userProfile={userProfile} />}
            {tab === 'invoices' && <InvoicesView userId={farrierId} userProfile={userProfile} />}
            {tab === 'services' && <ServicesView userId={farrierId} />}
            {tab === 'reports' && <ReportsView userId={farrierId} />}
            {tab === 'settings' && <SettingsView user={user} userProfile={userProfile} setUserProfile={setUserProfile} farrierId={farrierId} />}
            {tab === 'about' && <AboutView />}
          </main>
        </div>
      );
    }

    function ReportsView({ userId }) {
      const [invoices, setInvoices] = useState([]);
      const [loading, setLoading] = useState(true);
      const [dateRange, setDateRange] = useState('thisMonth'); // thisMonth, lastMonth, thisQuarter, thisYear, custom
      const [customStartDate, setCustomStartDate] = useState('');
      const [customEndDate, setCustomEndDate] = useState('');
      const [detailView, setDetailView] = useState(null); // { type: 'month', data: {...} } or { type: 'status', data: {...} } or { type: 'customer', data: {...} } or { type: 'service', data: {...} }

      useEffect(() => {
        loadInvoices();
      }, []);

      const loadInvoices = async () => {
        if (db) {
          try {
            const snapshot = await db.collection('invoices')
              .where('farrierId', '==', userId)
              .get();

            const invoiceData = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            setInvoices(invoiceData);
          } catch (error) {
            console.error('Error loading invoices:', error);
          }
        }
        setLoading(false);
      };

      // Filter invoices by date range
      const getFilteredInvoices = () => {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();

        return invoices.filter(invoice => {
          if (!invoice.createdAt) return false;
          
          const invoiceDate = invoice.createdAt.toDate();
          const invoiceYear = invoiceDate.getFullYear();
          const invoiceMonth = invoiceDate.getMonth();

          switch (dateRange) {
            case 'thisMonth':
              return invoiceYear === currentYear && invoiceMonth === currentMonth;
            
            case 'lastMonth':
              const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
              const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
              return invoiceYear === lastMonthYear && invoiceMonth === lastMonth;
            
            case 'thisQuarter':
              const currentQuarter = Math.floor(currentMonth / 3);
              const invoiceQuarter = Math.floor(invoiceMonth / 3);
              return invoiceYear === currentYear && invoiceQuarter === currentQuarter;
            
            case 'thisYear':
              return invoiceYear === currentYear;
            
            case 'custom':
              if (!customStartDate || !customEndDate) return true;
              const start = new Date(customStartDate);
              const end = new Date(customEndDate);
              end.setHours(23, 59, 59);
              return invoiceDate >= start && invoiceDate <= end;
            
            default:
              return true;
          }
        });
      };

      const filteredInvoices = getFilteredInvoices();

      // Calculate metrics - use paidAmount to include partial payments
      const getPaidAmount = (inv) => inv.paidAmount || (inv.payments || []).reduce((s,p) => s + (p.amount||0), 0) || (inv.status === 'paid' ? (inv.total || 0) : 0);
      const totalRevenue = filteredInvoices.reduce((sum, inv) => sum + getPaidAmount(inv), 0);

      const totalOutstanding = filteredInvoices
        .filter(inv => inv.status === 'outstanding' || inv.status === 'partial')
        .reduce((sum, inv) => sum + (inv.balanceDue || Math.max(0, (inv.total||0) - getPaidAmount(inv))), 0);

      const totalInvoices = filteredInvoices.length;
      const paidInvoices = filteredInvoices.filter(inv => inv.status === 'paid').length;
      const unpaidInvoices = filteredInvoices.filter(inv => inv.status === 'outstanding' || inv.status === 'partial').length;

      const averageInvoice = totalInvoices > 0 ? totalRevenue / Math.max(1, paidInvoices) : 0;
      const collectionRate = totalInvoices > 0 ? (paidInvoices / totalInvoices * 100) : 0;

      // Top customers
      const customerTotals = {};
      filteredInvoices.forEach(inv => {
        if (inv.status === 'paid') {
          const name = inv.customerName || 'Unknown';
          customerTotals[name] = (customerTotals[name] || 0) + (inv.total || 0);
        }
      });

      const topCustomers = Object.entries(customerTotals)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      // Service breakdown
      const serviceRevenue = {};
      filteredInvoices.forEach(inv => {
        if (inv.status === 'paid' && inv.items) {
          inv.items.forEach(item => {
            const service = item.description || 'Unknown Service';
            serviceRevenue[service] = (serviceRevenue[service] || 0) + parseFloat(item.amount || 0);
          });
        }
      });

      const topServices = Object.entries(serviceRevenue)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      // Monthly trend (last 6 months)
      const monthlyData = [];
      for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const month = date.getMonth();
        const year = date.getFullYear();
        
        const monthRevenue = invoices
          .filter(inv => {
            if (!inv.createdAt || inv.status !== 'paid') return false;
            const invDate = inv.createdAt.toDate();
            return invDate.getMonth() === month && invDate.getFullYear() === year;
          })
          .reduce((sum, inv) => sum + (inv.total || 0), 0);

        monthlyData.push({
          month: date.toLocaleDateString('en-US', { month: 'short' }),
          year: date.getFullYear(),
          revenue: monthRevenue
        });
      }

      const maxRevenue = Math.max(...monthlyData.map(d => d.revenue), 1);

      // Calculate aging report (overdue invoices)
      const now = new Date();
      const aging = {
        current: { amount: 0, count: 0, invoices: [] },
        days30: { amount: 0, count: 0, invoices: [] },
        days60: { amount: 0, count: 0, invoices: [] },
        days90: { amount: 0, count: 0, invoices: [] },
        days90plus: { amount: 0, count: 0, invoices: [] }
      };

      filteredInvoices.forEach(inv => {
        if (inv.status === 'outstanding' && inv.createdAt) {
          const createdDate = inv.createdAt.toDate();
          const daysOld = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
          
          if (daysOld <= 30) {
            aging.current.amount += inv.total || 0;
            aging.current.count++;
            aging.current.invoices.push(inv);
          } else if (daysOld <= 60) {
            aging.days30.amount += inv.total || 0;
            aging.days30.count++;
            aging.days30.invoices.push(inv);
          } else if (daysOld <= 90) {
            aging.days60.amount += inv.total || 0;
            aging.days60.count++;
            aging.days60.invoices.push(inv);
          } else if (daysOld <= 120) {
            aging.days90.amount += inv.total || 0;
            aging.days90.count++;
            aging.days90.invoices.push(inv);
          } else {
            aging.days90plus.amount += inv.total || 0;
            aging.days90plus.count++;
            aging.days90plus.invoices.push(inv);
          }
        }
      });

      const maxAging = Math.max(
        aging.current.amount,
        aging.days30.amount,
        aging.days60.amount,
        aging.days90.amount,
        aging.days90plus.amount,
        1
      );

      return (
        <div>
          <div style={{marginBottom: '2rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '1rem'}}>
            <div>
              <h1 style={{fontSize: '2rem', color: 'var(--primary)', marginBottom: '0.5rem'}}>
                ðŸ“ˆ Reports & Analytics
              </h1>
              <p style={{color: 'var(--text-muted)'}}>
                Financial insights and performance metrics
              </p>
            </div>

            <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
              <button
                onClick={() => setDateRange('thisMonth')}
                className={`btn btn-sm ${dateRange === 'thisMonth' ? 'btn-primary' : 'btn-outline'}`}
              >
                This Month
              </button>
              <button
                onClick={() => setDateRange('lastMonth')}
                className={`btn btn-sm ${dateRange === 'lastMonth' ? 'btn-primary' : 'btn-outline'}`}
              >
                Last Month
              </button>
              <button
                onClick={() => setDateRange('thisQuarter')}
                className={`btn btn-sm ${dateRange === 'thisQuarter' ? 'btn-primary' : 'btn-outline'}`}
              >
                This Quarter
              </button>
              <button
                onClick={() => setDateRange('thisYear')}
                className={`btn btn-sm ${dateRange === 'thisYear' ? 'btn-primary' : 'btn-outline'}`}
              >
                This Year
              </button>
              <button
                onClick={() => setDateRange('custom')}
                className={`btn btn-sm ${dateRange === 'custom' ? 'btn-primary' : 'btn-outline'}`}
              >
                Custom Range
              </button>
            </div>
          </div>

          {dateRange === 'custom' && (
            <div style={{marginBottom: '2rem', padding: '1rem', background: '#f9fafb', borderRadius: '8px', display: 'flex', gap: '1rem', flexWrap: 'wrap'}}>
              <div>
                <label style={{display: 'block', marginBottom: '0.25rem', fontSize: '0.875rem', fontWeight: '500'}}>Start Date</label>
                <input 
                  type="date" 
                  value={customStartDate}
                  onChange={(e) => setCustomStartDate(e.target.value)}
                  style={{padding: '0.5rem', borderRadius: '4px', border: '1px solid #ddd'}}
                />
              </div>
              <div>
                <label style={{display: 'block', marginBottom: '0.25rem', fontSize: '0.875rem', fontWeight: '500'}}>End Date</label>
                <input 
                  type="date" 
                  value={customEndDate}
                  onChange={(e) => setCustomEndDate(e.target.value)}
                  style={{padding: '0.5rem', borderRadius: '4px', border: '1px solid #ddd'}}
                />
              </div>
            </div>
          )}

          {loading ? (
            <div style={{display: 'flex', justifyContent: 'center', padding: '4rem'}}>
              <div className="spinner"></div>
            </div>
          ) : (
            <>
              {/* Key Metrics */}
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem', marginBottom: '2rem'}}>
                <div className="card">
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem', fontWeight: '500'}}>
                    Total Revenue
                  </div>
                  <div style={{fontSize: '2rem', fontWeight: '700', color: '#2683FB'}}>
                    ${totalRevenue.toFixed(2)}
                  </div>
                </div>

                <div className="card">
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem', fontWeight: '500'}}>
                    Outstanding
                  </div>
                  <div style={{fontSize: '2rem', fontWeight: '700', color: '#f59e0b'}}>
                    ${totalOutstanding.toFixed(2)}
                  </div>
                </div>

                <div className="card">
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem', fontWeight: '500'}}>
                    Average Invoice
                  </div>
                  <div style={{fontSize: '2rem', fontWeight: '700', color: 'var(--primary)'}}>
                    ${averageInvoice.toFixed(2)}
                  </div>
                </div>

                <div className="card">
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '0.5rem', fontWeight: '500'}}>
                    Collection Rate
                  </div>
                  <div style={{fontSize: '2rem', fontWeight: '700', color: 'var(--primary)'}}>
                    {collectionRate.toFixed(1)}%
                  </div>
                </div>
              </div>

              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1.5rem', marginBottom: '2rem'}}>
                {/* Revenue Trend */}
                <div className="card">
                  <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                    ðŸ“Š 6-Month Revenue Trend <span style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontWeight: 'normal'}}>(click bars)</span>
                  </h3>
                  <div style={{height: '200px', display: 'flex', alignItems: 'flex-end', gap: '0.5rem', justifyContent: 'space-between'}}>
                    {monthlyData.map((data, i) => {
                      const monthInvoices = invoices.filter(inv => {
                        if (!inv.createdAt || inv.status !== 'paid') return false;
                        const invDate = inv.createdAt.toDate();
                        return invDate.toLocaleDateString('en-US', { month: 'short' }) === data.month &&
                               invDate.getFullYear() === data.year;
                      });

                      return (
                        <div 
                          key={i} 
                          style={{flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', cursor: data.revenue > 0 ? 'pointer' : 'default'}}
                          onClick={() => {
                            if (data.revenue > 0) {
                              setDetailView({
                                type: 'month',
                                data: {
                                  month: `${data.month} ${data.year}`,
                                  invoices: monthInvoices,
                                  total: data.revenue
                                }
                              });
                            }
                          }}
                        >
                          <div style={{
                            width: '100%',
                            height: `${(data.revenue / maxRevenue) * 180}px`,
                            minHeight: data.revenue > 0 ? '10px' : '0',
                            background: 'linear-gradient(to top, #16a34a, #22c55e)',
                            borderRadius: '4px 4px 0 0',
                            transition: 'all 0.3s',
                            marginBottom: '0.5rem',
                            transform: 'scale(1)',
                          }}
                          onMouseEnter={(e) => {
                            if (data.revenue > 0) {
                              e.target.style.transform = 'scale(1.05)';
                              e.target.style.filter = 'brightness(1.1)';
                            }
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.transform = 'scale(1)';
                            e.target.style.filter = 'brightness(1)';
                          }}
                          title={`${data.month}: $${data.revenue.toFixed(2)} (click to see invoices)`}></div>
                          <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', fontWeight: '500'}}>
                            {data.month}
                          </div>
                          <div style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>
                            ${(data.revenue / 1000).toFixed(1)}k
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Invoice Status */}
                <div className="card">
                  <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                    ðŸ“‹ Invoice Breakdown <span style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontWeight: 'normal'}}>(click to view)</span>
                  </h3>
                  <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                      <span style={{color: 'var(--text-muted)'}}>Total Invoices</span>
                      <span style={{fontSize: '1.5rem', fontWeight: '700', color: 'var(--primary)'}}>{totalInvoices}</span>
                    </div>
                    <div 
                      style={{
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        padding: '0.5rem',
                        borderRadius: '8px',
                        cursor: paidInvoices > 0 ? 'pointer' : 'default',
                        transition: 'background 0.2s'
                      }}
                      onMouseEnter={(e) => { if (paidInvoices > 0) e.currentTarget.style.background = '#f0fdf4'; }}
                      onMouseLeave={(e) => { e.currentTarget.style.background = 'transparent'; }}
                      onClick={() => {
                        if (paidInvoices > 0) {
                          const paidInvs = filteredInvoices.filter(inv => inv.status === 'paid');
                          setDetailView({
                            type: 'status',
                            data: {
                              status: 'paid',
                              invoices: paidInvs,
                              total: paidInvs.reduce((sum, inv) => sum + (inv.total || 0), 0)
                            }
                          });
                        }
                      }}
                    >
                      <span style={{color: 'var(--text-muted)'}}>âœ… Paid</span>
                      <span style={{fontSize: '1.25rem', fontWeight: '600', color: '#2683FB'}}>{paidInvoices}</span>
                    </div>
                    <div 
                      style={{
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        padding: '0.5rem',
                        borderRadius: '8px',
                        cursor: unpaidInvoices > 0 ? 'pointer' : 'default',
                        transition: 'background 0.2s'
                      }}
                      onMouseEnter={(e) => { if (unpaidInvoices > 0) e.currentTarget.style.background = '#fef3c7'; }}
                      onMouseLeave={(e) => { e.currentTarget.style.background = 'transparent'; }}
                      onClick={() => {
                        if (unpaidInvoices > 0) {
                          const unpaidInvs = filteredInvoices.filter(inv => inv.status === 'outstanding');
                          setDetailView({
                            type: 'status',
                            data: {
                              status: 'outstanding',
                              invoices: unpaidInvs,
                              total: unpaidInvs.reduce((sum, inv) => sum + (inv.total || 0), 0)
                            }
                          });
                        }
                      }}
                    >
                      <span style={{color: 'var(--text-muted)'}}>â³ Unpaid</span>
                      <span style={{fontSize: '1.25rem', fontWeight: '600', color: '#f59e0b'}}>{unpaidInvoices}</span>
                    </div>
                    <div style={{marginTop: '1rem', height: '30px', display: 'flex', borderRadius: '8px', overflow: 'hidden', cursor: 'pointer'}}>
                      {paidInvoices > 0 && (
                        <div 
                          style={{
                            width: `${(paidInvoices / totalInvoices) * 100}%`,
                            background: '#2683FB',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '0.75rem',
                            fontWeight: '600',
                            transition: 'filter 0.2s'
                          }}
                          onMouseEnter={(e) => { e.target.style.filter = 'brightness(1.1)'; }}
                          onMouseLeave={(e) => { e.target.style.filter = 'brightness(1)'; }}
                          onClick={() => {
                            const paidInvs = filteredInvoices.filter(inv => inv.status === 'paid');
                            setDetailView({
                              type: 'status',
                              data: {
                                status: 'paid',
                                invoices: paidInvs,
                                total: paidInvs.reduce((sum, inv) => sum + (inv.total || 0), 0)
                              }
                            });
                          }}
                        >
                          {((paidInvoices / totalInvoices) * 100).toFixed(0)}%
                        </div>
                      )}
                      {unpaidInvoices > 0 && (
                        <div 
                          style={{
                            width: `${(unpaidInvoices / totalInvoices) * 100}%`,
                            background: '#f59e0b',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: '0.75rem',
                            fontWeight: '600',
                            transition: 'filter 0.2s'
                          }}
                          onMouseEnter={(e) => { e.target.style.filter = 'brightness(1.1)'; }}
                          onMouseLeave={(e) => { e.target.style.filter = 'brightness(1)'; }}
                          onClick={() => {
                            const unpaidInvs = filteredInvoices.filter(inv => inv.status === 'outstanding');
                            setDetailView({
                              type: 'status',
                              data: {
                                status: 'outstanding',
                                invoices: unpaidInvs,
                                total: unpaidInvs.reduce((sum, inv) => sum + (inv.total || 0), 0)
                              }
                            });
                          }}
                        >
                          {((unpaidInvoices / totalInvoices) * 100).toFixed(0)}%
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              {/* Aging Report */}
              <div style={{marginBottom: '2rem'}}>
                <div className="card">
                  <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                    ðŸ“… Accounts Receivable Aging <span style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontWeight: 'normal'}}>(click bars)</span>
                  </h3>
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '1.5rem'}}>
                    Outstanding invoices by age
                  </div>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '1rem'}}>
                    {[
                      { label: 'Current', sublabel: '0-30 days', data: aging.current, color: '#46C5FF' },
                      { label: '30 Days', sublabel: '31-60 days', data: aging.days30, color: '#eab308' },
                      { label: '60 Days', sublabel: '61-90 days', data: aging.days60, color: '#f97316' },
                      { label: '90 Days', sublabel: '91-120 days', data: aging.days90, color: '#ef4444' },
                      { label: '120+ Days', sublabel: 'over 120', data: aging.days90plus, color: '#991b1b' }
                    ].map((bucket, i) => (
                      <div 
                        key={i}
                        style={{
                          display: 'flex',
                          flexDirection: 'column',
                          alignItems: 'center',
                          cursor: bucket.data.count > 0 ? 'pointer' : 'default',
                          padding: '1rem',
                          borderRadius: '8px',
                          transition: 'all 0.3s'
                        }}
                        onMouseEnter={(e) => {
                          if (bucket.data.count > 0) {
                            e.currentTarget.style.background = '#f9fafb';
                            e.currentTarget.style.transform = 'translateY(-4px)';
                          }
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = 'transparent';
                          e.currentTarget.style.transform = 'translateY(0)';
                        }}
                        onClick={() => {
                          if (bucket.data.count > 0) {
                            setDetailView({
                              type: 'status',
                              data: {
                                status: `${bucket.label} (${bucket.sublabel})`,
                                invoices: bucket.data.invoices,
                                total: bucket.data.amount
                              }
                            });
                          }
                        }}
                      >
                        <div style={{
                          width: '100%',
                          height: '120px',
                          display: 'flex',
                          alignItems: 'flex-end',
                          marginBottom: '0.75rem'
                        }}>
                          <div style={{
                            width: '100%',
                            height: `${bucket.data.amount > 0 ? Math.max((bucket.data.amount / maxAging) * 100, 10) : 0}%`,
                            background: bucket.data.count > 0 ? `linear-gradient(to top, ${bucket.color}, ${bucket.color}dd)` : '#e5e7eb',
                            borderRadius: '8px 8px 0 0',
                            transition: 'all 0.3s',
                            position: 'relative'
                          }}
                          onMouseEnter={(e) => {
                            if (bucket.data.count > 0) {
                              e.target.style.filter = 'brightness(1.1)';
                              e.target.style.transform = 'scaleY(1.05)';
                            }
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.filter = 'brightness(1)';
                            e.target.style.transform = 'scaleY(1)';
                          }}
                          title={`${bucket.label}: $${bucket.data.amount.toFixed(2)} (${bucket.data.count} invoice${bucket.data.count !== 1 ? 's' : ''})`}
                          ></div>
                        </div>
                        <div style={{textAlign: 'center'}}>
                          <div style={{fontSize: '0.75rem', fontWeight: '600', color: 'var(--text)', marginBottom: '0.25rem'}}>
                            {bucket.label}
                          </div>
                          <div style={{fontSize: '0.65rem', color: 'var(--text-muted)', marginBottom: '0.5rem'}}>
                            {bucket.sublabel}
                          </div>
                          <div style={{fontSize: '1rem', fontWeight: '700', color: bucket.color}}>
                            ${bucket.data.amount.toFixed(0)}
                          </div>
                          <div style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>
                            {bucket.data.count} invoice{bucket.data.count !== 1 ? 's' : ''}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  {totalOutstanding > 0 && (
                    <div style={{
                      marginTop: '1.5rem',
                      padding: '1rem',
                      background: totalOutstanding > 500 ? '#fef2f2' : '#f0fdf4',
                      borderRadius: '8px',
                      borderLeft: `4px solid ${totalOutstanding > 500 ? '#ef4444' : '#46C5FF'}`
                    }}>
                      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <span style={{fontWeight: '600', color: 'var(--text)'}}>Total Outstanding:</span>
                        <span style={{fontSize: '1.5rem', fontWeight: '700', color: totalOutstanding > 500 ? '#ef4444' : '#46C5FF'}}>
                          ${totalOutstanding.toFixed(2)}
                        </span>
                      </div>
                    </div>
                  )}
                </div>
              </div>

              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1.5rem'}}>
                {/* Top Customers */}
                <div className="card">
                  <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                    ðŸ‘¥ Top 5 Customers <span style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontWeight: 'normal'}}>(click to view)</span>
                  </h3>
                  {topCustomers.length > 0 ? (
                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                      {topCustomers.map(([name, total], i) => {
                        const customerInvoices = filteredInvoices.filter(inv => inv.customerName === name && inv.status === 'paid');
                        return (
                          <div 
                            key={i} 
                            style={{
                              display: 'flex', 
                              justifyContent: 'space-between', 
                              alignItems: 'center', 
                              padding: '0.75rem', 
                              background: '#f9fafb', 
                              borderRadius: '8px',
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.background = '#dcfce7';
                              e.currentTarget.style.transform = 'translateX(4px)';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.background = '#f9fafb';
                              e.currentTarget.style.transform = 'translateX(0)';
                            }}
                            onClick={() => {
                              setDetailView({
                                type: 'customer',
                                data: {
                                  name,
                                  invoices: customerInvoices,
                                  total
                                }
                              });
                            }}
                          >
                            <div>
                              <div style={{fontWeight: '600'}}>{name}</div>
                              <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Rank #{i + 1} â€¢ {customerInvoices.length} invoice{customerInvoices.length !== 1 ? 's' : ''}</div>
                            </div>
                            <div style={{fontSize: '1.25rem', fontWeight: '700', color: '#2683FB'}}>
                              ${total.toFixed(2)}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <p style={{color: 'var(--text-muted)', textAlign: 'center', padding: '2rem'}}>
                      No customer data yet
                    </p>
                  )}
                </div>

                {/* Top Services */}
                <div className="card">
                  <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                    ðŸ”§ Top 5 Services <span style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontWeight: 'normal'}}>(click to view)</span>
                  </h3>
                  {topServices.length > 0 ? (
                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                      {topServices.map(([service, revenue], i) => {
                        const serviceInvoices = filteredInvoices.filter(inv => 
                          inv.status === 'paid' && 
                          inv.items && 
                          inv.items.some(item => item.description === service)
                        );
                        return (
                          <div 
                            key={i} 
                            style={{
                              display: 'flex', 
                              justifyContent: 'space-between', 
                              alignItems: 'center', 
                              padding: '0.75rem', 
                              background: '#f9fafb', 
                              borderRadius: '8px',
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.background = '#dcfce7';
                              e.currentTarget.style.transform = 'translateX(4px)';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.background = '#f9fafb';
                              e.currentTarget.style.transform = 'translateX(0)';
                            }}
                            onClick={() => {
                              setDetailView({
                                type: 'service',
                                data: {
                                  service,
                                  invoices: serviceInvoices,
                                  total: revenue
                                }
                              });
                            }}
                          >
                            <div style={{flex: 1}}>
                              <div style={{fontWeight: '600', fontSize: '0.9rem'}}>{service}</div>
                              <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Rank #{i + 1} â€¢ {serviceInvoices.length} invoice{serviceInvoices.length !== 1 ? 's' : ''}</div>
                            </div>
                            <div style={{fontSize: '1.25rem', fontWeight: '700', color: '#2683FB'}}>
                              ${revenue.toFixed(2)}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <p style={{color: 'var(--text-muted)', textAlign: 'center', padding: '2rem'}}>
                      No service data yet
                    </p>
                  )}
                </div>
              </div>
            </>
          )}

          {/* Payment Methods Report */}
          {(() => {
            const methodLabels = { cash: 'ðŸ’µ Cash', check: 'ðŸ“ Check', credit_card: 'ðŸ’³ Credit Card', other: 'ðŸ”„ Other' };
            const methodColors = { cash: '#059669', check: '#2683FB', credit_card: '#7c3aed', other: '#d97706' };
            const methodTotals = {};
            const methodCounts = {};
            filteredInvoices.forEach(inv => {
              (inv.payments || []).forEach(p => {
                const m = p.method || 'other';
                methodTotals[m] = (methodTotals[m] || 0) + (p.amount || 0);
                methodCounts[m] = (methodCounts[m] || 0) + 1;
              });
              // Legacy: fully paid invoice with no payments array
              if ((!inv.payments || inv.payments.length === 0) && inv.status === 'paid') {
                const m = inv.cardLast4 ? 'credit_card' : 'cash';
                methodTotals[m] = (methodTotals[m] || 0) + (inv.total || 0);
                methodCounts[m] = (methodCounts[m] || 0) + 1;
              }
            });
            const totalPaid = Object.values(methodTotals).reduce((s,v) => s+v, 0);
            const methods = Object.keys(methodTotals).sort((a,b) => methodTotals[b] - methodTotals[a]);
            return (
              <div className="card" style={{marginTop: '1.5rem'}}>
                <h3 style={{fontSize: '1.25rem', marginBottom: '1.5rem', color: 'var(--primary)'}}>
                  ðŸ’° Payment Methods Breakdown
                </h3>
                {methods.length === 0 ? (
                  <p style={{color: 'var(--text-muted)', textAlign: 'center', padding: '2rem'}}>
                    No payment data yet
                  </p>
                ) : (
                  <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                    {methods.map(m => {
                      const pct = totalPaid > 0 ? (methodTotals[m] / totalPaid * 100) : 0;
                      const color = methodColors[m] || '#888';
                      return (
                        <div key={m}>
                          <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'0.4rem'}}>
                            <div style={{fontWeight:'600'}}>{methodLabels[m] || m}</div>
                            <div style={{display:'flex', gap:'1.5rem', alignItems:'center'}}>
                              <span style={{fontSize:'0.85rem', color:'var(--text-muted)'}}>{methodCounts[m]} payment{methodCounts[m]!==1?'s':''}</span>
                              <span style={{fontWeight:'700', color, fontSize:'1.1rem'}}>${methodTotals[m].toFixed(2)}</span>
                              <span style={{fontSize:'0.85rem', color:'var(--text-muted)', minWidth:'40px', textAlign:'right'}}>{pct.toFixed(1)}%</span>
                            </div>
                          </div>
                          <div style={{background:'#f3f4f6', borderRadius:'99px', height:'10px', overflow:'hidden'}}>
                            <div style={{width:`${pct}%`, background:color, height:'100%', borderRadius:'99px', transition:'width 0.5s ease'}}></div>
                          </div>
                        </div>
                      );
                    })}
                    <div style={{borderTop:'1px solid #e5e7eb', paddingTop:'1rem', display:'flex', justifyContent:'space-between', fontWeight:'700'}}>
                      <span>Total Collected</span>
                      <span style={{color:'var(--primary)', fontSize:'1.1rem'}}>${totalPaid.toFixed(2)}</span>
                    </div>
                  </div>
                )}
              </div>
            );
          })()}

          {/* Detail Modal */}
          {detailView && (
            <div className="modal-overlay" onClick={() => setDetailView(null)}>
              <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '800px'}}>
                <div className="modal-header">
                  <h2>
                    {detailView.type === 'month' && `ðŸ“… ${detailView.data.month} Invoices`}
                    {detailView.type === 'status' && `${detailView.data.status === 'paid' ? 'âœ…' : 'â³'} ${detailView.data.status === 'paid' ? 'Paid' : 'Unpaid'} Invoices`}
                    {detailView.type === 'customer' && `ðŸ‘¤ ${detailView.data.name}`}
                    {detailView.type === 'service' && `ðŸ”§ ${detailView.data.service}`}
                  </h2>
                  <button className="close-btn" onClick={() => setDetailView(null)}>Ã—</button>
                </div>

                <div style={{padding: '1.5rem'}}>
                  {detailView.data.invoices.length === 0 ? (
                    <p style={{color: 'var(--text-muted)', textAlign: 'center', padding: '2rem'}}>
                      No invoices found
                    </p>
                  ) : (
                    <>
                      <div style={{marginBottom: '1rem', fontSize: '0.9rem', color: 'var(--text-muted)'}}>
                        {detailView.data.invoices.length} invoice{detailView.data.invoices.length !== 1 ? 's' : ''} â€¢ 
                        Total: <strong style={{color: 'var(--primary)'}}>${detailView.data.total.toFixed(2)}</strong>
                      </div>
                      <div style={{maxHeight: '400px', overflowY: 'auto'}}>
                        {detailView.data.invoices.map(inv => (
                          <div key={inv.id} style={{
                            padding: '1rem',
                            marginBottom: '0.75rem',
                            background: '#f9fafb',
                            borderRadius: '8px',
                            border: '1px solid #e5e7eb'
                          }}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '0.5rem'}}>
                              <div>
                                <div style={{fontWeight: '600', fontSize: '1rem'}}>{inv.invoiceNumber}</div>
                                <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>{inv.customerName}</div>
                              </div>
                              <div style={{textAlign: 'right'}}>
                                <div style={{fontSize: '1.25rem', fontWeight: '700', color: '#2683FB'}}>
                                  ${inv.total?.toFixed(2)}
                                </div>
                                <span className={`badge badge-${inv.status === 'paid' ? 'success' : 'warning'}`}>
                                  {inv.status}
                                </span>
                              </div>
                            </div>
                            <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>
                              {inv.createdAt?.toDate().toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric'
                              })}
                              {inv.paidAt && inv.status === 'paid' && (
                                <> â€¢ Paid: {inv.paidAt.toDate().toLocaleDateString('en-US', {
                                  month: 'short',
                                  day: 'numeric'
                                })}</>
                              )}
                            </div>
                            {inv.items && inv.items.length > 0 && (
                              <div style={{marginTop: '0.5rem', paddingTop: '0.5rem', borderTop: '1px solid #e5e7eb'}}>
                                {inv.items.map((item, idx) => (
                                  <div key={idx} style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                                    â€¢ {item.description}{item.horseName ? ` (${item.horseName})` : ''} - ${parseFloat(item.amount || 0).toFixed(2)}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }
function ServicesView({ userId }) {
  const [services, setServices] = useState([]);
  const [loading, setLoading] = useState(true);

  const [name, setName] = useState("");
  const [price, setPrice] = useState("");
  const [category, setCategory] = useState("");
  const [isActive, setIsActive] = useState(true);

  const [editingId, setEditingId] = useState(null);

  const loadServices = async () => {
    if (!db) return;
    setLoading(true);
    const snap = await db.collection("services")
      .where("farrierId", "==", userId)
      .get();

    const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    rows.sort((a,b) => (a.category || "").localeCompare(b.category || "") || (a.name || "").localeCompare(b.name || ""));
    setServices(rows);
    setLoading(false);
  };

  useEffect(() => { loadServices(); }, [userId]);

  const resetForm = () => {
    setName(""); setPrice(""); setCategory(""); setIsActive(true); setEditingId(null);
  };

  const startEdit = (svc) => {
    setEditingId(svc.id);
    setName(svc.name || "");
    setPrice(String(svc.price ?? ""));
    setCategory(svc.category || "");
    setIsActive(Boolean(svc.isActive));
  };

  const saveService = async () => {
    if (!db) return;
    const n = name.trim();
    if (!n) return alert("Service name is required.");

    const p = Number(price);
    if (!isFinite(p) || p < 0) return alert("Price must be a valid number.");

    const payload = {
      farrierId: userId,
      name: n,
      price: p,
      category: category.trim(),
      isActive: Boolean(isActive),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    };

    if (editingId) {
      await db.collection("services").doc(editingId).update(payload);
    } else {
      await db.collection("services").add({
        ...payload,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
    }

    resetForm();
    await loadServices();
  };

  const toggleActive = async (svc) => {
    await db.collection("services").doc(svc.id).update({
      isActive: !svc.isActive,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
    await loadServices();
  };

  return (
    <div className="card">
      <h2 style={{ marginBottom: "1rem" }}>Services</h2>

      <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1fr 1fr", gap: "0.75rem", alignItems: "end" }}>
        <div>
          <label style={{ fontWeight: 600 }}>Service Name</label>
          <input value={name} onChange={(e) => setName(e.target.value)} style={{ width: "100%", padding: "0.75rem", borderRadius: 8, border: "2px solid var(--border)" }} />
        </div>

        <div>
          <label style={{ fontWeight: 600 }}>Default Price</label>
          <input value={price} onChange={(e) => setPrice(e.target.value)} inputMode="decimal"
            style={{ width: "100%", padding: "0.75rem", borderRadius: 8, border: "2px solid var(--border)" }} />
        </div>

        <div>
          <label style={{ fontWeight: 600 }}>Category (optional)</label>
          <input value={category} onChange={(e) => setCategory(e.target.value)}
            style={{ width: "100%", padding: "0.75rem", borderRadius: 8, border: "2px solid var(--border)" }} />
        </div>

        <div>
          <label style={{ fontWeight: 600 }}>Active</label>
          <select value={isActive ? "yes" : "no"} onChange={(e) => setIsActive(e.target.value === "yes")}
            style={{ width: "100%", padding: "0.75rem", borderRadius: 8, border: "2px solid var(--border)" }}>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div style={{ gridColumn: "1 / -1", display: "flex", gap: "0.5rem" }}>
          <button className="btn btn-primary" onClick={saveService}>
            {editingId ? "Update Service" : "Add Service"}
          </button>
          {editingId && <button className="btn btn-outline" onClick={resetForm}>Cancel</button>}
        </div>
      </div>

      <div style={{ marginTop: "1.5rem" }}>
        {loading ? (
          <div>Loading...</div>
        ) : (
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead>
              <tr style={{ textAlign: "left" }}>
                <th style={{ padding: "0.5rem" }}>Name</th>
                <th style={{ padding: "0.5rem" }}>Category</th>
                <th style={{ padding: "0.5rem" }}>Price</th>
                <th style={{ padding: "0.5rem" }}>Active</th>
                <th style={{ padding: "0.5rem" }}></th>
              </tr>
            </thead>
            <tbody>
              {services.map(svc => (
                <tr key={svc.id} style={{ borderTop: "1px solid var(--border)" }}>
                  <td style={{ padding: "0.5rem" }}>{svc.name}</td>
                  <td style={{ padding: "0.5rem" }}>{svc.category || ""}</td>
                  <td style={{ padding: "0.5rem" }}>${Number(svc.price || 0).toFixed(2)}</td>
                  <td style={{ padding: "0.5rem" }}>{svc.isActive ? "Yes" : "No"}</td>
                  <td style={{ padding: "0.5rem", display: "flex", gap: "0.5rem" }}>
                    <button className="btn btn-sm btn-outline" onClick={() => startEdit(svc)}>Edit</button>
                    <button className="btn btn-sm btn-outline" onClick={() => toggleActive(svc)}>
                      {svc.isActive ? "Disable" : "Enable"}
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}

    function AboutView() {
      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>
            About FarriTech
          </h1>

          <div className="card">
            <div style={{textAlign: 'center', padding: '2rem'}}>
              <img src="data:image/png;base64,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" alt="FarriTech Logo" style={{width: '300px', height: '300px', objectFit: 'contain', borderRadius: '20px', marginBottom: '1.5rem'}} />
              <h2 style={{fontSize: '2rem', marginBottom: '0.5rem', color: 'var(--primary)'}}>
                FarriTech
              </h2>
              <p style={{fontSize: '1.25rem', color: 'var(--text-muted)', marginBottom: '2rem'}}>
                Advanced Farrier Solutions
              </p>
              
              <div style={{
                background: 'linear-gradient(135deg, #2683FB 0%, #46C5FF 100%)',
                color: 'white',
                padding: '1.5rem',
                borderRadius: '8px',
                marginBottom: '2rem'
              }}>
                <div style={{fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem'}}>
                  Version 3.0
                </div>
                <div style={{fontSize: '0.875rem', opacity: 0.9}}>
                  Released January 2026
                </div>
              </div>

              <div style={{
                background: '#f8f9fa',
                padding: '2rem',
                borderRadius: '8px',
                marginBottom: '2rem'
              }}>
                <h3 style={{fontSize: '1.25rem', marginBottom: '1rem', color: 'var(--primary)'}}>
                  ðŸ“ž Support
                </h3>
                <p style={{fontSize: '1.125rem', color: 'var(--text)', marginBottom: '0.5rem'}}>
                  Need help? We're here for you!
                </p>
                <a 
                  href="tel:954-673-3041"
                  style={{
                    fontSize: '1.5rem',
                    fontWeight: 'bold',
                    color: 'var(--primary)',
                    textDecoration: 'none',
                    display: 'inline-block',
                    padding: '0.75rem 1.5rem',
                    background: 'white',
                    borderRadius: '8px',
                    border: '2px solid var(--primary)',
                    marginTop: '0.5rem'
                  }}
                >
                  ðŸ“± (954) 673-3041
                </a>
                <p style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginTop: '1rem'}}>
                  Monday - Friday: 9:00 AM - 5:00 PM EST
                </p>
              </div>

              <div style={{
                borderTop: '1px solid #e0e0e0',
                paddingTop: '2rem',
                marginTop: '2rem'
              }}>
                <h3 style={{fontSize: '1.25rem', marginBottom: '1rem', color: 'var(--primary)'}}>
                  âœ¨ Features
                </h3>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                  gap: '1rem',
                  textAlign: 'left'
                }}>
                  <div>
                    <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>ðŸ“±</div>
                    <div style={{fontWeight: '500', marginBottom: '0.25rem'}}>QR Code Booking</div>
                    <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Easy customer bookings</div>
                  </div>
                  <div>
                    <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>ðŸ“…</div>
                    <div style={{fontWeight: '500', marginBottom: '0.25rem'}}>Calendar Sync</div>
                    <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Google Calendar integration</div>
                  </div>
                  <div>
                    <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>ðŸ’°</div>
                    <div style={{fontWeight: '500', marginBottom: '0.25rem'}}>Invoicing</div>
                    <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Professional invoices</div>
                  </div>
                  <div>
                    <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>â°</div>
                    <div style={{fontWeight: '500', marginBottom: '0.25rem'}}>Availability</div>
                    <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Smart scheduling</div>
                  </div>
                </div>
              </div>

              <div style={{
                borderTop: '1px solid #e0e0e0',
                paddingTop: '2rem',
                marginTop: '2rem',
                color: 'var(--text-muted)',
                fontSize: '0.875rem'
              }}>
                <p style={{marginBottom: '0.5rem'}}>
                  Â© 2026 FarriTech. All rights reserved.
                </p>
                <p style={{fontSize: '0.75rem'}}>
                  Built with â¤ï¸ for professional farriers
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function QRCodeView({ user, userProfile, connectGoogleCalendar, disconnectGoogleCalendar }) {
  const safeFarrierId = (typeof farrierId !== 'undefined' && farrierId) || (userProfile && (userProfile.farrierId || userProfile.ownerUid || userProfile.uid)) || (user && user.uid) || '';
      // Resolve farrierId safely (stored on the user profile; fallback to auth uid)
      const farrierId = (userProfile && (userProfile.farrierId || userProfile.id || userProfile.uid)) || (user && user.uid) || '';
      const bookingUrl = window.location.origin + window.location.pathname + '?farrier=' + encodeURIComponent(safeFarrierId);
      
      // Use Google Charts API for QR code as backup
      const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(bookingUrl)}&color=2D5016&bgcolor=FFFFFF`;

      const downloadQR = () => {
        const link = document.createElement('a');
        link.download = 'farrier-booking-qr.png';
        link.href = qrImageUrl;
        link.click();
      };

      const copyLink = () => {
        navigator.clipboard.writeText(bookingUrl);
        alert('Booking link copied to clipboard!');
      };

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>
            Your Personal QR Code & Booking Link
          </h1>

          {/* Google Calendar Status */}
          <div className="calendar-status">
            <div className={`status-indicator ${userProfile?.googleCalendarConnected ? 'connected' : 'disconnected'}`}></div>
            <span>
              Google Calendar: {userProfile?.googleCalendarConnected ? 'Connected âœ“' : 'Not Connected'}
            </span>
            {!userProfile?.googleCalendarConnected ? (
              <button 
                className="btn btn-sm btn-google" 
                onClick={connectGoogleCalendar}
                style={{marginLeft: 'auto'}}
              >
                Connect Google Calendar
              </button>
            ) : (
              <button 
                className="btn btn-sm btn-outline" 
                onClick={disconnectGoogleCalendar}
                style={{marginLeft: 'auto'}}
              >
                ðŸ”Œ Disconnect
              </button>
            )}
          </div>

          <div className="qr-section">
            <h2 style={{fontSize: '1.75rem', marginBottom: '1rem'}}>
              ðŸš— Put This QR Code on Your Vehicle
            </h2>
            <p style={{opacity: 0.9, marginBottom: '1rem'}}>
              Customers can scan this code to book appointments instantly
            </p>

            <div className="qr-code-container">
              <img src={qrImageUrl} alt="QR Code" style={{display: 'block', maxWidth: '100%'}} />
            </div>

            <div style={{display: 'flex', gap: '1rem', justifyContent: 'center', flexWrap: 'wrap'}}>
              <button className="btn btn-success" onClick={downloadQR}>
                ðŸ“¥ Download QR Code
              </button>
              <button className="btn btn-secondary" onClick={copyLink}>
                ðŸ“‹ Copy Booking Link
              </button>
            </div>

            <div className="booking-link">
              {bookingUrl}
            </div>
          </div>

          <div className="card">
            <h2>How to Use Your QR Code</h2>
            <ol style={{paddingLeft: '1.5rem', lineHeight: '2'}}>
              <li><strong>Download</strong> the QR code image above</li>
              <li><strong>Print</strong> it on a sticker or magnetic sign</li>
              <li><strong>Place</strong> it on your vehicle, business cards, or flyers</li>
              <li><strong>Customers scan</strong> with their phone camera</li>
              <li><strong>They book</strong> appointments directly!</li>
            </ol>
            <p style={{marginTop: '1rem', color: 'var(--text-muted)'}}>
              ðŸ’¡ Tip: Print multiple copies for your truck, trailer, and business cards. The more visible, the more bookings!
            </p>
          </div>
        </div>
      );
    }

    function CustomerBookingView({ farrierId }) {
      const [step, setStep] = useState('landing');
      const [farrierInfo, setFarrierInfo] = useState(null);
      const [loading, setLoading] = useState(true);
      const [formData, setFormData] = useState({
        name: '',
        phone: '',
        email: '',
        services: [], // Multiple services
        numberOfHorses: '',
        address: '',
        city: '',
        state: '',
        zip: '',
        comments: '',
        date: '',
        time: ''
      });

      useEffect(() => {
        loadFarrierInfo();
      }, []);

      const loadFarrierInfo = async () => {
        try {
          if (db) {
            const doc = await db.collection('farriers').doc(farrierId).get();
            if (doc.exists) {
              setFarrierInfo(doc.data());
            }
          } else {
            // Demo mode
            setFarrierInfo({
              businessName: "Demo Farrier Services",
              email: "demo@farrier.com"
            });
          }
        } catch (error) {
          console.error('Error loading farrier info:', error);
        }
        setLoading(false);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        
        try {
          if (db) {
            // Save appointment request to Firestore
            await db.collection('appointments').add({
              farrierId: farrierId,
              customerName: formData.name,
              phone: formData.phone,
              email: formData.email,
              services: formData.services,
              numberOfHorses: formData.numberOfHorses,
              address: formData.address,
              city: formData.city,
              state: formData.state,
              zip: formData.zip,
              comments: formData.comments,
              requestedDate: formData.date,
              requestedTime: formData.time,
              status: 'pending',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Auto-create customer account
            try {
              // Check if customer account already exists
              const existingCustomer = await db.collection('customers')
                .where('email', '==', formData.email)
                .limit(1)
                .get();

              if (existingCustomer.empty) {
                // Create new customer profile (without Firebase Auth for now)
                // We'll let them sign up via portal or Google when they need to pay
                await db.collection('customers').add({
                  name: formData.name,
                  email: formData.email,
                  phone: formData.phone,
                  address: `${formData.address}, ${formData.city}, ${formData.state} ${formData.zip}`.trim(),
                  farrierId: farrierId,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  source: 'qr_booking'
                });
                console.log('âœ… Customer profile created');
              } else {
                console.log('âœ… Customer already exists');
              }
            } catch (error) {
              console.error('Note: Could not create customer profile:', error);
              // Don't fail the booking if customer creation fails
            }

            // If Google Calendar is connected, create event
            // (This would be done server-side in production)
          }
          
          setStep('success');
        } catch (error) {
          console.error('Error submitting booking:', error);
          alert('Error submitting booking. Please try again.');
        }
      };

      const services = [
        'Routine Trim',
        'Shoeing (All 4)',
        'Shoeing (Front Only)',
        'Corrective Shoeing',
        'Hoof Care Consultation'
      ];

      // Convert 24-hour time to 12-hour AM/PM format
      const formatTime = (time24) => {
        const [hours, minutes] = time24.split(':').map(Number);
        const period = hours >= 12 ? 'PM' : 'AM';
        const hours12 = hours % 12 || 12; // Convert 0 to 12 for midnight
        return `${hours12}:${String(minutes).padStart(2, '0')} ${period}`;
      };

      // Generate time slots based on farrier's availability for selected date
      const getAvailableSlots = () => {
        if (!formData.date) {
          return []; // No slots until date is selected
        }

        // Parse date correctly to avoid timezone issues
        // formData.date is in format "YYYY-MM-DD"
        const [year, month, day] = formData.date.split('-').map(Number);
        const selectedDate = new Date(year, month - 1, day); // Create date in local timezone
        const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
        
        console.log('Selected date:', formData.date);
        console.log('Parsed as:', selectedDate);
        console.log('Day name:', dayName);
        
        // Default availability if farrier hasn't set it up yet (Mon-Fri 9-5)
        const defaultAvailability = {
          monday: { enabled: true, start: '09:00', end: '17:00' },
          tuesday: { enabled: true, start: '09:00', end: '17:00' },
          wednesday: { enabled: true, start: '09:00', end: '17:00' },
          thursday: { enabled: true, start: '09:00', end: '17:00' },
          friday: { enabled: true, start: '09:00', end: '17:00' },
          saturday: { enabled: false, start: '09:00', end: '17:00' },
          sunday: { enabled: false, start: '09:00', end: '17:00' }
        };

        const availability = farrierInfo?.availability || defaultAvailability;
        const dayAvailability = availability[dayName];

        console.log('Day availability:', dayAvailability);

        if (!dayAvailability || !dayAvailability.enabled) {
          return []; // No slots if farrier doesn't work this day
        }

        // Generate 2-hour slots from start to end time
        const slots = [];
        const [startHour, startMin] = dayAvailability.start.split(':').map(Number);
        const [endHour, endMin] = dayAvailability.end.split(':').map(Number);
        
        let currentHour = startHour;
        let currentMin = startMin;
        
        while (currentHour < endHour || (currentHour === endHour && currentMin < endMin)) {
          const timeStr = `${String(currentHour).padStart(2, '0')}:${String(currentMin).padStart(2, '0')}`;
          slots.push(timeStr);
          
          // Add 2 hours for next slot
          currentMin += 120;
          currentHour += Math.floor(currentMin / 60);
          currentMin = currentMin % 60;
        }

        console.log('Generated slots:', slots);
        return slots;
      };

      const availableSlots = getAvailableSlots();

      if (loading) {
        return (
          <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}>
            <div className="spinner"></div>
          </div>
        );
      }

      if (!farrierInfo) {
        return (
          <div className="app-container">
            <div className="main-content">
              <div className="error-message">
                Farrier not found. Please check your QR code or booking link.
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="app-container">
          <header className="app-header">
            <div className="header-content">
              <div className="logo">
                <span className="logo-icon">ðŸ´</span>
                <span>{farrierInfo.businessName}</span>
              </div>
              <a 
                href={window.location.origin + '/customer-portal.html'}
                style={{
                  padding: '0.5rem 1rem',
                  background: 'var(--primary)',
                  color: 'white',
                  borderRadius: '8px',
                  textDecoration: 'none',
                  fontSize: '0.9rem',
                  fontWeight: '500',
                  display: 'inline-flex',
                  alignItems: 'center',
                  gap: '0.5rem',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => e.target.style.background = 'var(--primary-dark)'}
                onMouseOut={(e) => e.target.style.background = 'var(--primary)'}
              >
                ðŸ’³ Pay Invoices
              </a>
            </div>
          </header>

          <main className="main-content">
            {step === 'success' ? (
              <div style={{textAlign: 'center', padding: '2rem'}}>
                <div className="success-message">
                  âœ“ Appointment Request Sent Successfully!
                </div>
                <div className="card">
                  <h2>What's Next?</h2>
                  <p style={{marginBottom: '1rem'}}>
                    Your appointment request has been sent. You'll receive an SMS confirmation once it's approved.
                  </p>
                  <div style={{marginBottom: '1rem', color: 'var(--text-muted)', textAlign: 'left'}}>
                    <strong>Booking Details:</strong><br/>
                    {formData.services.length > 0 && (
                      <>Services: {formData.services.join(', ')}<br/></>
                    )}
                    {formData.numberOfHorses && (
                      <>Number of Horses: {formData.numberOfHorses}<br/></>
                    )}
                    Date: {formData.date} at {formData.time}<br/>
                    {formData.address && (
                      <>
                        Location: {formData.address}
                        {formData.city && `, ${formData.city}`}
                        {formData.state && `, ${formData.state}`}
                        {formData.zip && ` ${formData.zip}`}
                        <br/>
                      </>
                    )}
                  </div>

                  <div style={{
                    background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)',
                    padding: '1.5rem',
                    borderRadius: '12px',
                    marginTop: '1.5rem',
                    marginBottom: '1.5rem',
                    textAlign: 'left'
                  }}>
                    <div style={{fontSize: '1.1rem', fontWeight: '600', marginBottom: '0.5rem', color: 'var(--primary)'}}>
                      ðŸŽ‰ Your Customer Account is Ready!
                    </div>
                    <p style={{fontSize: '0.9rem', marginBottom: '0.75rem', color: 'var(--text)'}}>
                      We've created an account for you. You can now view invoices and pay online!
                    </p>
                    <p style={{fontSize: '0.85rem', marginBottom: '0.5rem', color: 'var(--text-muted)'}}>
                      <strong>Portal:</strong> {window.location.origin}/customer-portal.html
                    </p>
                    <p style={{fontSize: '0.85rem', color: 'var(--text-muted)'}}>
                      <strong>Email:</strong> {formData.email}
                    </p>
                    <button 
                      className="btn btn-success"
                      style={{width: '100%', marginTop: '1rem'}}
                      onClick={() => {
                        window.location.href = window.location.origin + '/customer-portal.html';
                      }}
                    >
                      Go to Customer Portal
                    </button>
                  </div>

                  <button className="btn btn-primary" onClick={() => {
                    setStep('landing');
                    setFormData({
                      name: '',
                      phone: '',
                      email: '',
                      services: [],
                      numberOfHorses: '',
                      address: '',
                      city: '',
                      state: '',
                      zip: '',
                      comments: '',
                      date: '',
                      time: ''
                    });
                  }}>
                    Book Another Appointment
                  </button>
                </div>
              </div>
            ) : (
              <div style={{textAlign: 'center'}}>
                <div className="hero">
                  <h1>ðŸ´ {farrierInfo.businessName}</h1>
                  <p>Professional hoof care for your horses. Book your appointment below.</p>
                </div>

                <div className="card" style={{textAlign: 'left', maxWidth: '600px', margin: '0 auto'}}>
                  <h2>Book Your Appointment</h2>
                  <form onSubmit={handleSubmit}>
                    <div className="form-group">
                      <label>Name *</label>
                      <input 
                        type="text" 
                        required 
                        value={formData.name}
                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                        placeholder="Your name"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Phone Number *</label>
                      <input 
                        type="tel" 
                        required 
                        value={formData.phone}
                        onChange={(e) => setFormData({...formData, phone: e.target.value})}
                        placeholder="(555) 555-5555"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Email</label>
                      <input 
                        type="email" 
                        value={formData.email}
                        onChange={(e) => setFormData({...formData, email: e.target.value})}
                        placeholder="your@email.com"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Services Needed</label>
                      <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                        {services.map(service => (
                          <label key={service} style={{display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer'}}>
                            <input 
                              type="checkbox"
                              checked={formData.services.includes(service)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setFormData({...formData, services: [...formData.services, service]});
                                } else {
                                  setFormData({...formData, services: formData.services.filter(s => s !== service)});
                                }
                              }}
                              style={{width: 'auto', margin: 0}}
                            />
                            <span style={{fontWeight: 'normal'}}>{service}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                    
                    <div className="form-group">
                      <label>Number of Horses</label>
                      <input 
                        type="number" 
                        value={formData.numberOfHorses}
                        onChange={(e) => setFormData({...formData, numberOfHorses: e.target.value})}
                        placeholder="1"
                        min="1"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Address</label>
                      <input 
                        type="text" 
                        value={formData.address}
                        onChange={(e) => setFormData({...formData, address: e.target.value})}
                        placeholder="123 Main Street"
                      />
                    </div>
                    
                    <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem'}}>
                      <div className="form-group">
                        <label>City</label>
                        <input 
                          type="text" 
                          value={formData.city}
                          onChange={(e) => setFormData({...formData, city: e.target.value})}
                          placeholder="City"
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>State</label>
                        <input 
                          type="text" 
                          value={formData.state}
                          onChange={(e) => setFormData({...formData, state: e.target.value})}
                          placeholder="VA"
                          maxLength="2"
                          style={{textTransform: 'uppercase'}}
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>ZIP</label>
                        <input 
                          type="text" 
                          value={formData.zip}
                          onChange={(e) => setFormData({...formData, zip: e.target.value})}
                          placeholder="12345"
                          maxLength="5"
                        />
                      </div>
                    </div>
                    
                    <div className="form-group">
                      <label>Comments or Special Requests</label>
                      <textarea 
                        value={formData.comments}
                        onChange={(e) => setFormData({...formData, comments: e.target.value})}
                        placeholder="Any special notes, concerns, or requests..."
                        rows="4"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Preferred Date *</label>
                      <input 
                        type="date" 
                        required 
                        value={formData.date}
                        onChange={(e) => setFormData({...formData, date: e.target.value, time: ''})}
                        min={new Date().toISOString().split('T')[0]}
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Available Time Slots *</label>
                      {formData.date ? (
                        availableSlots.length > 0 ? (
                          <div className="time-slots">
                            {availableSlots.map(slot => (
                              <div 
                                key={slot}
                                className={`time-slot ${formData.time === slot ? 'selected' : ''}`}
                                onClick={() => setFormData({...formData, time: slot})}
                              >
                                {formatTime(slot)}
                              </div>
                            ))}
                          </div>
                        ) : (
                          <p style={{color: '#999', fontStyle: 'italic', padding: '1rem', background: '#f5f5f5', borderRadius: '4px'}}>
                            âš ï¸ Farrier is not available on this day. Please select a different date.
                          </p>
                        )
                      ) : (
                        <p style={{color: '#999', fontStyle: 'italic', padding: '1rem', background: '#f5f5f5', borderRadius: '4px'}}>
                          ðŸ“… Please select a date first to see available time slots.
                        </p>
                      )}
                    </div>
                    
                    <button 
                      type="submit" 
                      className="btn btn-success" 
                      style={{width: '100%', marginTop: '1rem'}} 
                      disabled={!formData.time}
                    >
                      Request Appointment
                    </button>
                  </form>
                </div>
              </div>
            )}
          </main>
        </div>
      );
    }

    function DashboardView({ userId }) {
  const [stats, setStats] = useState({
    monthAppointments: 0,
    totalRevenue: 0,
    outstandingInvoices: 0,
    upcomingWeek: 0,
  });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadStats();
  }, [userId]);

  const loadStats = async () => {
    try {
      if (!db || !userId) {
        setStats({ monthAppointments: 0, totalRevenue: 0, outstandingInvoices: 0, upcomingWeek: 0 });
        setLoading(false);
        return;
      }

      // ---- Appointments ----
      let monthAppointments = 0;
      let upcomingWeek = 0;

      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      const weekEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7);

      const apptSnap = await db.collection('appointments')
        .where('farrierId', '==', userId)
        .get();

      apptSnap.forEach(doc => {
        const a = doc.data() || {};
        const dStr = a.requestedDate || a.date || "";
        if (!dStr) return;

        // expected "YYYY-MM-DD"
        const parts = String(dStr).split('-').map(Number);
        if (parts.length !== 3 || !parts[0] || !parts[1] || !parts[2]) return;
        const d = new Date(parts[0], parts[1] - 1, parts[2]);

        if (d >= monthStart && d <= monthEnd) monthAppointments++;
        if (d >= new Date(now.getFullYear(), now.getMonth(), now.getDate()) && d < weekEnd) upcomingWeek++;
      });

      // ---- Invoices / Revenue (optional) ----
      // If you haven't built invoices yet, these will remain 0.
      let totalRevenue = 0;
      let outstandingInvoices = 0;
      try {
        const invSnap = await db.collection('invoices')
          .where('farrierId', '==', userId)
          .get();

        invSnap.forEach(doc => {
          const inv = doc.data() || {};
          const amount = Number(inv.amount || inv.total || inv.totalAmount || 0) || 0;
          const status = String(inv.status || '').toLowerCase();

          const paidAmt = Number(inv.paidAmount || 0) || (Array.isArray(inv.payments) ? inv.payments.reduce((s,p) => s+(p.amount||0), 0) : 0) || (status === 'paid' || status === 'settled' ? amount : 0);
          totalRevenue += paidAmt;
          if (status === 'outstanding' || status === 'partial') outstandingInvoices += Math.max(0, amount - paidAmt);
        });
      } catch (e) {
        // invoices collection may not exist yet - that's fine
      }

      setStats({
        monthAppointments,
        totalRevenue,
        outstandingInvoices,
        upcomingWeek,
      });
    } catch (err) {
      console.error('âŒ Error loading dashboard stats:', err);
      setStats({ monthAppointments: 0, totalRevenue: 0, outstandingInvoices: 0, upcomingWeek: 0 });
    }
    setLoading(false);
  };

  const kpis = [
    { label: 'Appointments This Month', value: loading ? 'â€¦' : String(stats.monthAppointments), change: 'Live', positive: true },
    { label: 'Total Revenue', value: loading ? 'â€¦' : `$${stats.totalRevenue.toFixed(2)}`, change: 'Paid invoices', positive: true },
    { label: 'Outstanding Invoices', value: loading ? 'â€¦' : `$${stats.outstandingInvoices.toFixed(2)}`, change: 'Unpaid', positive: true },
    { label: 'This Week', value: loading ? 'â€¦' : String(stats.upcomingWeek), change: 'Upcoming', positive: true },
  ];

  return (
    <div>
      <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Dashboard Overview</h1>

      <div className="dashboard-grid">
        {kpis.map((kpi, idx) => (
          <div key={idx} className="stat-card">
            <div className="stat-label">{kpi.label}</div>
            <div className="stat-value">{kpi.value}</div>
            <div className={`stat-change ${kpi.positive ? 'positive' : ''}`}>
              {kpi.change}
            </div>
          </div>
        ))}
      </div>

      <div className="card">
        <h2>Recent Activity</h2>
        <p style={{color: 'var(--text-muted)'}}>
          Your real appointments are pulled from Firestore (appointments where farrierId = your userId).
        </p>
      </div>
    </div>
  );
}

function CalendarView({ userId }) {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [appointments, setAppointments] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        loadAppointments();
      }, []);

      const loadAppointments = async () => {
        if (db) {
          try {
            const snapshot = await db.collection('appointments')
              .where('farrierId', '==', userId)
              .get();
            
            const appointmentData = snapshot.docs.map(doc => {
              const data = doc.data();
              
              // Clean up time format: convert "HH:MM:SS" to "HH:MM"
              if (data.requestedTime && data.requestedTime.includes(':')) {
                const timeParts = data.requestedTime.split(':');
                if (timeParts.length === 3) {
                  data.requestedTime = `${timeParts[0]}:${timeParts[1]}`;
                }
              }
          
              return {
                id: doc.id,
                ...data
              };
            });
            
            setAppointments(appointmentData);
            console.log('âœ… Loaded appointments for calendar:', appointmentData.length);
          } catch (error) {
            console.error('âŒ Error loading appointments:', error);
          }
        }
        setLoading(false);
      };

      // Count appointments by date
      const getAppointmentCounts = () => {
        const counts = {};
        appointments.forEach(apt => {
          if (apt.requestedDate) {
            const date = apt.requestedDate; // Format: "2026-02-15"
            if (!counts[date]) {
              counts[date] = { confirmed: 0, pending: 0, total: 0 };
            }
            counts[date].total++;
            // Handle status - if not set or 'pending', treat as pending
            const status = apt.status || 'pending';
            
            if (status === 'confirmed') {
              counts[date].confirmed++;
            } else {
              // Treat everything else (pending, undefined, null) as pending
              counts[date].pending++;
            }
            
            console.log(`ðŸ“… Date: ${date}, Status: ${status}, Counts:`, counts[date]);
          }
        });
        console.log('ðŸ“Š Final appointment counts:', counts);
        return counts;
      };

      const appointmentCounts = getAppointmentCounts();
      
      const daysInMonth = new Date(
        currentDate.getFullYear(),
        currentDate.getMonth() + 1,
        0
      ).getDate();

      const firstDay = new Date(
        currentDate.getFullYear(),
        currentDate.getMonth(),
        1
      ).getDay();

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

      const days = [];
      for (let i = 0; i < firstDay; i++) {
        days.push(<div key={`empty-${i}`} className="calendar-day"></div>);
      }
      for (let i = 1; i <= daysInMonth; i++) {
        const isToday = i === new Date().getDate() && 
                        currentDate.getMonth() === new Date().getMonth() &&
                        currentDate.getFullYear() === new Date().getFullYear();
        
        // Format date to match appointment requestedDate format (YYYY-MM-DD)
        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        const counts = appointmentCounts[dateStr];
        
        days.push(
          <div 
            key={i} 
            className={`calendar-day ${isToday ? 'today' : ''}`}
            style={{
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'flex-start',
              padding: '0.5rem',
              minHeight: '80px',
              position: 'relative'
            }}
          >
            <div style={{fontWeight: '600', marginBottom: '0.25rem'}}>{i}</div>
            {counts && counts.total > 0 && (
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                gap: '0.25rem',
                fontSize: '0.75rem',
                width: '100%',
                alignItems: 'center'
              }}>
                {counts.confirmed > 0 && (
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.25rem',
                    padding: '0.25rem 0.5rem',
                    background: '#dcfce7',
                    color: '#166534',
                    borderRadius: '6px',
                    fontWeight: '700',
                    fontSize: '0.75rem'
                  }}>
                    âœ“ {counts.confirmed}
                  </div>
                )}
                {counts.pending > 0 && (
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.25rem',
                    padding: '0.25rem 0.5rem',
                    background: '#fef3c7',
                    color: '#92400e',
                    borderRadius: '6px',
                    fontWeight: '700',
                    fontSize: '0.75rem'
                  }}>
                    â³ {counts.pending}
                  </div>
                )}
              </div>
            )}
          </div>
        );
      }

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Calendar</h1>
          
          <div className="calendar">
            <div className="calendar-header">
              <h2 className="calendar-title">
                {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
              </h2>
              <div className="calendar-nav">
                <button className="btn btn-sm btn-outline" onClick={() => {
                  const newDate = new Date(currentDate);
                  newDate.setMonth(newDate.getMonth() - 1);
                  setCurrentDate(newDate);
                }}>
                  â†
                </button>
                <button className="btn btn-sm btn-outline" onClick={() => {
                  const newDate = new Date(currentDate);
                  newDate.setMonth(newDate.getMonth() + 1);
                  setCurrentDate(newDate);
                }}>
                  â†’
                </button>
              </div>
            </div>

            <div className="calendar-grid">
              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                <div key={day} className="calendar-day header">{day}</div>
              ))}
              {days}
            </div>
          </div>

          {/* Legend */}
          <div style={{
            marginTop: '1rem',
            padding: '1rem',
            background: '#f9fafb',
            borderRadius: '8px',
            display: 'flex',
            gap: '1.5rem',
            alignItems: 'center',
            justifyContent: 'center',
            flexWrap: 'wrap'
          }}>
            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
              <div style={{
                padding: '0.25rem 0.5rem',
                background: '#dcfce7',
                color: '#166534',
                borderRadius: '4px',
                fontSize: '0.75rem',
                fontWeight: '600'
              }}>
                âœ“ {appointments.filter(a => (a.status || 'pending').toLowerCase() === 'confirmed').length}
              </div>
              <span style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Confirmed</span>
            </div>

            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
              <div style={{
                padding: '0.25rem 0.5rem',
                background: '#fef3c7',
                color: '#92400e',
                borderRadius: '4px',
                fontSize: '0.75rem',
                fontWeight: '600'
              }}>
                â³ {appointments.filter(a => (a.status || 'pending').toLowerCase() !== 'confirmed').length}
              </div>
              <span style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Pending</span>
            </div>

            <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>
              {appointments.length} total appointment{appointments.length !== 1 ? 's' : ''}
            </div>
          </div>
        </div>
      );
    }

    function AppointmentsView({ userId, userProfile }) {
      const [appointments, setAppointments] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showInvoiceModal, setShowInvoiceModal] = useState(false);
      const [selectedAppointment, setSelectedAppointment] = useState(null);
      const [sortOrder, setSortOrder] = useState('newest'); // 'newest' or 'oldest'
      const [appointmentFilter, setAppointmentFilter] = useState('all'); // all, pending, confirmed, cancelled, invoiced, thisMonth, lastMonth
      const [showEditModal, setShowEditModal] = useState(false);
      const [editingAppointment, setEditingAppointment] = useState(null);

      useEffect(() => {
        loadAppointments();
      }, []);

      const loadAppointments = async () => {
        if (db) {
          try {
            const snapshot = await db.collection('appointments')
              .where('farrierId', '==', userId)
              .get();
            
            const appointmentData = snapshot.docs.map(doc => {
              const data = doc.data();
              
              // Clean up time format: convert "HH:MM:SS" to "HH:MM"
              if (data.requestedTime && data.requestedTime.includes(':')) {
                const timeParts = data.requestedTime.split(':');
                if (timeParts.length === 3) {
                  // Has seconds, remove them
                  data.requestedTime = `${timeParts[0]}:${timeParts[1]}`;
                  console.log(`ðŸ• Fixed time format: ${doc.data().requestedTime} â†’ ${data.requestedTime}`);
                }
              }
              
              return {
                id: doc.id,
                ...data
              };
            });
            
            // One-time cleanup: Fix time formats in database
            appointmentData.forEach(async (apt) => {
              if (apt.requestedTime && apt.requestedTime.split(':').length === 3) {
                // This appointment has HH:MM:SS format, fix it in the database
                const timeParts = apt.requestedTime.split(':');
                const cleanTime = `${timeParts[0]}:${timeParts[1]}`;
                try {
                  await db.collection('appointments').doc(apt.id).update({
                    requestedTime: cleanTime
                  });
                  console.log(`âœ… Fixed time in database for ${apt.id}: ${apt.requestedTime} â†’ ${cleanTime}`);
                } catch (error) {
                  console.error(`âŒ Error fixing time for ${apt.id}:`, error);
                }
              }
            });
            
            setAppointments(appointmentData);
            console.log('âœ… Loaded appointments:', appointmentData.length);
          } catch (error) {
            console.error('âŒ Error loading appointments:', error);
          }
        }
        setLoading(false);
      };

      // Filter appointments
      const getFilteredAppointments = () => {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();

        return appointments.filter(apt => {
          // Status filters
          if (appointmentFilter === 'pending' && apt.status !== 'pending') return false;
          if (appointmentFilter === 'confirmed' && apt.status !== 'confirmed' && apt.status !== 'confirmed_by_customer') return false;
          if (appointmentFilter === 'cancelled' && apt.status === 'cancelled') return true;
          if (appointmentFilter === 'invoiced' && !apt.invoiced) return false;

          // Date filters - use requestedDate (appointment date)
          if (!apt.requestedDate) return true;
          const aptDate = new Date(apt.requestedDate);
          const aptYear = aptDate.getFullYear();
          const aptMonth = aptDate.getMonth();

          if (appointmentFilter === 'thisMonth') {
            return aptYear === currentYear && aptMonth === currentMonth;
          }
          if (appointmentFilter === 'lastMonth') {
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            return aptYear === lastMonthYear && aptMonth === lastMonth;
          }

          return true;
        });
      };

      // Get sorted appointments based on sortOrder
      const getSortedAppointments = () => {
        const filtered = getFilteredAppointments();
        return [...filtered].sort((a, b) => {
          if (!a.createdAt || !b.createdAt) return 0;
          const dateA = a.createdAt.toDate();
          const dateB = b.createdAt.toDate();
          return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
        });
      };

      const sortedAppointments = getSortedAppointments();

      const createCalendarEvent = async (appointment, userProfile) => {
        console.log('=== CREATE CALENDAR EVENT START ===');
        console.log('UserProfile:', userProfile);
        console.log('Appointment:', appointment);
        
        if (!userProfile?.googleCalendarConnected || !userProfile?.googleAccessToken) {
          console.error('âŒ Calendar not connected or no token');
          alert('Please connect Google Calendar first in the "My QR Code" tab');
          return false;
        }

        console.log('âœ… Calendar connected, token exists');

        try {
          // Use existing access token (no refresh for now)
          const accessToken = userProfile.googleAccessToken;
          console.log('ðŸ”‘ Using access token');
          
          // Create calendar event
          const eventStartTime = new Date(`${appointment.requestedDate}T${appointment.requestedTime}:00`);
          const eventEndTime = new Date(eventStartTime.getTime() + 2 * 60 * 60 * 1000); // 2 hours later

          console.log('ðŸ“… Event times:', {
            start: eventStartTime.toISOString(),
            end: eventEndTime.toISOString()
          });

          // Build services list
          let servicesList = '';
          if (appointment.services && appointment.services.length > 0) {
            servicesList = appointment.services.map(s => `   â€¢ ${s}`).join('\n');
          } else {
            servicesList = '   (No services specified)';
          }

          const event = {
            summary: `ðŸ´ Farrier - ${appointment.customerName}`,
            description: `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ“‹ APPOINTMENT DETAILS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ‘¤ CUSTOMER INFORMATION:
   Name: ${appointment.customerName}
   Phone: ${appointment.phone}
${appointment.email ? `   Email: ${appointment.email}` : ''}

ðŸ”§ SERVICES REQUESTED:
${servicesList}

ðŸ´ HORSES:
${appointment.numberOfHorses ? `   Number of Horses: ${appointment.numberOfHorses}` : '   (Not specified)'}

ðŸ“ LOCATION:
${appointment.address ? `   ${appointment.address}\n   ${appointment.city}${appointment.state ? `, ${appointment.state}` : ''}${appointment.zip ? ` ${appointment.zip}` : ''}` : '   (No address provided)'}

ðŸ’¬ SPECIAL REQUESTS/NOTES:
${appointment.comments ? `   ${appointment.comments}` : '   (None)'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â° Scheduled: ${appointment.requestedDate} at ${appointment.requestedTime}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
            location: appointment.address ? `${appointment.address}, ${appointment.city}${appointment.state ? `, ${appointment.state}` : ''}${appointment.zip ? ` ${appointment.zip}` : ''}` : '',
            start: {
              dateTime: eventStartTime.toISOString(),
              timeZone: 'America/New_York'
            },
            end: {
              dateTime: eventEndTime.toISOString(),
              timeZone: 'America/New_York'
            }
          };

          console.log('ðŸ“¤ Sending event to Google Calendar:', event);

          const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(event)
          });

          console.log('ðŸ“¥ Response status:', response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ Calendar API error:', errorData);
            throw new Error(`Failed to create calendar event: ${errorData.error?.message || 'Unknown error'}`);
          }

          const data = await response.json();
          console.log('âœ… Calendar event created successfully!', data);
          
          // Save event ID to appointment
          if (db) {
            await db.collection('appointments').doc(appointment.id).update({
              googleEventId: data.id
            });
            console.log('âœ… Saved event ID to appointment');
          }

          return true;
        } catch (error) {
          console.error('âŒ Calendar error:', error);
          alert('Could not add to calendar. Error: ' + error.message + '\n\nCheck console for details. Your connection may have expired - try reconnecting.');
          return false;
        }
      };

      const deleteCalendarEvent = async (appointment, userProfile) => {
        console.log('ðŸ—‘ï¸ DELETE CALENDAR EVENT START');
        
        if (!appointment.googleEventId) {
          console.log('âš ï¸ No Google Event ID found - event may not be in calendar');
          return true; // Not an error, just wasn't synced yet
        }
        
        if (!userProfile?.googleCalendarConnected || !userProfile?.googleAccessToken) {
          console.error('âŒ Calendar not connected');
          return false;
        }

        try {
          // Use existing access token (no refresh for now)
          const accessToken = userProfile.googleAccessToken;
          
          console.log('ðŸ—‘ï¸ Deleting event from Google Calendar:', appointment.googleEventId);
          
          const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events/${appointment.googleEventId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });

          if (response.ok || response.status === 404) {
            console.log('âœ… Calendar event deleted successfully!');
            return true;
          } else {
            console.error('âŒ Failed to delete calendar event:', response.status);
            return false;
          }
        } catch (error) {
          console.error('âŒ Calendar deletion error:', error);
          return false;
        }
      };

      const updateStatus = async (appointmentId, newStatus) => {
        console.log('ðŸ”µ updateStatus called:', { appointmentId, newStatus });
        
        if (db) {
          await db.collection('appointments').doc(appointmentId).update({
            status: newStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log('âœ… Status updated in Firebase');
          
          const appointment = appointments.find(apt => apt.id === appointmentId);
          
          // If confirming, add to Google Calendar
          if (newStatus === 'confirmed') {
            console.log('ðŸŸ¢ Status is confirmed, attempting calendar sync...');
            
            if (appointment) {
              const success = await createCalendarEvent(appointment, userProfile);
              if (success) {
                alert('âœ“ Appointment confirmed and added to your Google Calendar!');
              } else {
                alert('âš ï¸ Appointment confirmed, but failed to add to Google Calendar.');
              }
              // Send SMS confirmation if enabled
              if (userProfile?.smsEnabled && appointment.phone) {
                const bizName = userProfile?.businessName || 'Your Farrier';
                const msg = `Hi ${appointment.customerName}, your appointment with ${bizName} is confirmed for ${appointment.requestedDate} at ${appointment.requestedTime}. Reply CONFIRM to confirm or STOP to opt out.`;
                await sendSms(appointment.phone, msg);
              }
            } else {
              console.error('âŒ Appointment not found in local state');
            }
          }
          
          // If cancelling, remove from Google Calendar
          if (newStatus === 'cancelled') {
            console.log('ðŸ”´ Status is cancelled, removing from calendar...');
            
            if (appointment) {
              const deleted = await deleteCalendarEvent(appointment, userProfile);
              if (deleted) {
                alert('âœ“ Appointment cancelled and removed from your Google Calendar!');
              } else {
                alert('âš ï¸ Appointment cancelled in app, but may still be in Google Calendar. You may need to remove it manually.');
              }
            }
          }
          
          loadAppointments();
        }
      };

      // â”€â”€ SMS helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const sendSms = async (phone, message) => {
        try {
          const res = await fetch('/api/send-sms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to: phone, body: message })
          });
          const data = await res.json();
          return data.success === true;
        } catch (e) {
          console.error('SMS error:', e);
          return false;
        }
      };

      const isSmsEnabled = (customerPhone, customers) => {
        if (!userProfile?.smsEnabled) return false;
        if (!customerPhone) return false;
        // Check if customer has opted out
        const phone = customerPhone.replace(/\D/g, '');
        const customer = customers?.find(c => c.phone?.replace(/\D/g, '') === phone);
        if (customer?.smsOptOut) return false;
        return true;
      };

      const sendReminder = async (appointment) => {
        if (!userProfile?.smsEnabled || !appointment.phone) {
          alert('SMS not enabled. Enable it in Settings â†’ SMS & Messaging.');
          return;
        }
        const bizName = userProfile?.businessName || 'Your Farrier';
        const message = `Hi ${appointment.customerName}, reminder: your appointment with ${bizName} is on ${appointment.requestedDate} at ${appointment.requestedTime}. Reply CONFIRM to confirm or STOP to opt out.`;
        const sent = await sendSms(appointment.phone, message);
        if (sent) {
          alert(`âœ… Reminder sent to ${appointment.customerName}`);
        } else {
          alert('âŒ Failed to send reminder. Check SMS settings.');
        }
      };

      const handleCreateInvoiceFromAppointment = (appointment) => {
        console.log('ðŸŽ¯ Creating invoice from appointment:', appointment);
        console.log('Customer Name:', appointment.customerName);
        console.log('Customer Email:', appointment.email);
        console.log('Customer Phone:', appointment.phone);
        setSelectedAppointment(appointment);
        setShowInvoiceModal(true);
      };

      const handleInvoiceCreated = async () => {
        // Mark appointment as invoiced
        if (selectedAppointment && db) {
          try {
            await db.collection('appointments').doc(selectedAppointment.id).update({
              invoiced: true,
              invoicedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log('âœ… Appointment marked as invoiced');
            loadAppointments();
          } catch (error) {
            console.error('Error marking appointment as invoiced:', error);
          }
        }
        setShowInvoiceModal(false);
        setSelectedAppointment(null);
      };

      if (loading) {
        return (
          <div style={{display: 'flex', justifyContent: 'center', padding: '3rem'}}>
            <div className="spinner"></div>
          </div>
        );
      }

      return (
        <div>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem'}}>
            <h1 style={{marginBottom: 0, fontSize: '2rem', color: 'var(--primary)'}}>Appointments</h1>
            {appointments.length > 0 && (
              <button
                onClick={() => setSortOrder(sortOrder === 'newest' ? 'oldest' : 'newest')}
                className="btn btn-sm btn-outline"
                style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}
              >
                {sortOrder === 'newest' ? 'ðŸ“… Newest First' : 'ðŸ“… Oldest First'}
              </button>
            )}
          </div>
          
          {appointments.length === 0 ? (
            <div className="card">
              <h2>No Appointments Yet</h2>
              <p style={{color: 'var(--text-muted)'}}>
                Appointments booked through your QR code will appear here. Share your QR code to start receiving bookings!
              </p>
            </div>
          ) : (
            <div className="card">
              <h2>Your Appointments ({appointments.length})</h2>
              
              {/* Filter Buttons */}
              <div style={{
                display: 'flex',
                gap: '0.5rem',
                marginBottom: '1.5rem',
                flexWrap: 'wrap',
                paddingBottom: '1rem',
                borderBottom: '1px solid var(--border)'
              }}>
                <button
                  onClick={() => setAppointmentFilter('all')}
                  className={`btn btn-sm ${appointmentFilter === 'all' ? 'btn-primary' : 'btn-outline'}`}
                >
                  All
                </button>
                <button
                  onClick={() => setAppointmentFilter('pending')}
                  className={`btn btn-sm ${appointmentFilter === 'pending' ? 'btn-primary' : 'btn-outline'}`}
                >
                  â³ Pending
                </button>
                <button
                  onClick={() => setAppointmentFilter('confirmed')}
                  className={`btn btn-sm ${appointmentFilter === 'confirmed' ? 'btn-primary' : 'btn-outline'}`}
                >
                  âœ“ Confirmed
                </button>
                <button
                  onClick={() => setAppointmentFilter('cancelled')}
                  className={`btn btn-sm ${appointmentFilter === 'cancelled' ? 'btn-primary' : 'btn-outline'}`}
                >
                  âœ• Cancelled
                </button>
                <button
                  onClick={() => setAppointmentFilter('invoiced')}
                  className={`btn btn-sm ${appointmentFilter === 'invoiced' ? 'btn-primary' : 'btn-outline'}`}
                >
                  ðŸ’° Invoiced
                </button>
                <button
                  onClick={() => setAppointmentFilter('thisMonth')}
                  className={`btn btn-sm ${appointmentFilter === 'thisMonth' ? 'btn-primary' : 'btn-outline'}`}
                >
                  This Month
                </button>
                <button
                  onClick={() => setAppointmentFilter('lastMonth')}
                  className={`btn btn-sm ${appointmentFilter === 'lastMonth' ? 'btn-primary' : 'btn-outline'}`}
                >
                  Last Month
                </button>
              </div>

              <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '1rem'}}>
                Showing {sortedAppointments.length} of {appointments.length} appointment{appointments.length !== 1 ? 's' : ''}
              </div>

              <div className="appointments-list">
                {sortedAppointments.map(apt => (
                  <div key={apt.id} className="appointment-item">
                    <div className="appointment-info">
                      <div className="appointment-customer">{apt.customerName}</div>
                      <div className="appointment-details">
                        ðŸ“ž {apt.phone} {apt.email && `â€¢ âœ‰ï¸ ${apt.email}`}
                        {userProfile?.smsEnabled && apt.phone && (() => {
                          const ph = apt.phone.replace(/\D/g,'');
                          const cust = appointments.find ? null : null; // will use Firestore
                          return null; // handled via button below
                        })()}
                        <br/>
                        ðŸ“… {apt.requestedDate} at {apt.requestedTime}<br/>
                        {apt.services && apt.services.length > 0 && (
                          <>ðŸ”§ Services: {apt.services.join(', ')}<br/></>
                        )}
                        {apt.numberOfHorses && (
                          <>ðŸ´ Horses: {apt.numberOfHorses}<br/></>
                        )}
                        {apt.address && (
                          <>ðŸ“ {apt.address}, {apt.city}, {apt.state} {apt.zip}<br/></>
                        )}
                        {apt.comments && (
                          <>ðŸ’¬ Notes: {apt.comments}<br/></>
                        )}
                        <small style={{color: 'var(--text-muted)'}}>
                          Requested: {apt.createdAt?.toDate().toLocaleDateString()}
                        </small>
                      </div>
                    </div>
                    <div className="appointment-actions">
                      <span className={`badge badge-${
                        apt.status === 'confirmed' ? 'success' :
                        apt.status === 'confirmed_by_customer' ? 'success' :
                        apt.status === 'pending' ? 'warning' : 'pending'
                      }`}>
                        {apt.status === 'confirmed_by_customer' ? 'âœ… Confirmed by Customer' : (apt.status || 'pending')}
                      </span>
                      {apt.invoiced && (
                        <span className="badge" style={{background: '#dcfce7', color: '#166534'}}>
                          âœ“ Invoiced
                        </span>
                      )}
                      {apt.status !== 'confirmed' && (
                        <button 
                          className="btn btn-sm btn-success"
                          onClick={() => updateStatus(apt.id, 'confirmed')}
                        >
                          âœ“ Confirm
                        </button>
                      )}
                      <button 
                        className="btn btn-sm btn-outline"
                        onClick={() => {
                          setEditingAppointment(apt);
                          setShowEditModal(true);
                        }}
                      >
                        âœï¸ Edit
                      </button>
                      {!apt.invoiced && (
                        <button 
                          className="btn btn-sm"
                          style={{background: '#2683FB', color: 'white'}}
                          onClick={() => handleCreateInvoiceFromAppointment(apt)}
                        >
                          ðŸ’° Create Invoice
                        </button>
                      )}
                      {userProfile?.smsEnabled && (
                        <button 
                          className="btn btn-sm btn-warning"
                          onClick={() => sendReminder(apt)}
                        >
                          ðŸ“± Send Reminder
                        </button>
                      )}
                      {userProfile?.smsEnabled && apt.phone && (
                        <button
                          className="btn btn-sm btn-outline"
                          style={{fontSize:'0.75rem'}}
                          onClick={async () => {
                            if (!db) return;
                            const phone = apt.phone.replace(/\D/g,'');
                            const snap = await db.collection('customers').where('phone','==',phone).where('farrierId','==',userId).get();
                            if (snap.empty) {
                              alert('Customer record not found.');
                              return;
                            }
                            const doc = snap.docs[0];
                            const current = doc.data().smsOptOut || false;
                            await doc.ref.update({ smsOptOut: !current });
                            alert(!current ? `ðŸš« SMS disabled for ${apt.customerName}` : `âœ… SMS re-enabled for ${apt.customerName}`);
                          }}
                        >
                          {apt.smsOptOut ? 'âœ… SMS On' : 'ðŸš« SMS Off'}
                        </button>
                      )}
                      {apt.status !== 'cancelled' && (
                        <button 
                          className="btn btn-sm btn-outline"
                          onClick={() => updateStatus(apt.id, 'cancelled')}
                        >
                          âœ• Cancel
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {showInvoiceModal && selectedAppointment && (
            <InvoiceCreateModal 
              userId={userId}
              onClose={() => {
                setShowInvoiceModal(false);
                setSelectedAppointment(null);
              }}
              onCreated={handleInvoiceCreated}
              prefillData={{
                customerName: selectedAppointment.customerName || '',
                customerEmail: selectedAppointment.email || '',
                customerPhone: selectedAppointment.phone || ''
              }}
            />
          )}

          {showEditModal && editingAppointment && (
            <EditAppointmentModal 
              appointment={editingAppointment}
              userProfile={userProfile}
              onClose={() => {
                setShowEditModal(false);
                setEditingAppointment(null);
              }}
              onSaved={() => {
                setShowEditModal(false);
                setEditingAppointment(null);
                loadAppointments();
              }}
            />
          )}
        </div>
      );
    }

    function EditAppointmentModal({ appointment, userProfile, onClose, onSaved }) {
      const [phone, setPhone] = useState(appointment.phone || '');
      const [date, setDate] = useState(appointment.requestedDate || '');
      const [time, setTime] = useState(appointment.requestedTime || '');
      const [numberOfHorses, setNumberOfHorses] = useState(appointment.numberOfHorses || '');
      const [services, setServices] = useState(appointment.services || []);
      const [address, setAddress] = useState(appointment.address || '');
      const [city, setCity] = useState(appointment.city || '');
      const [state, setState] = useState(appointment.state || '');
      const [zip, setZip] = useState(appointment.zip || '');
      const [comments, setComments] = useState(appointment.comments || '');
      const [saving, setSaving] = useState(false);

      const availableServices = [
        'Trim All Four',
        'Reset All Four',
        'Hot Shoeing All Four',
        'Dressage Shoes',
        'Corrective Shoeing',
        'Studs Installation',
        'Show Prep',
        'Emergency Call'
      ];

      const handleServiceToggle = (service) => {
        if (services.includes(service)) {
          setServices(services.filter(s => s !== service));
        } else {
          setServices([...services, service]);
        }
      };

      const updateGoogleCalendarEvent = async (updatedAppointment) => {
        if (!userProfile?.googleCalendarConnected || !userProfile?.googleAccessToken) {
          console.log('âš ï¸ Google Calendar not connected, skipping calendar update');
          return true;
        }

        if (!appointment.googleCalendarEventId) {
          console.log('âš ï¸ No Google Calendar event ID, cannot update');
          return true;
        }

        try {
          console.log('ðŸ”„ Updating Google Calendar event...');
          
          const startDateTime = `${date}T${time}:00`;
          const endDateTime = new Date(new Date(startDateTime).getTime() + 60 * 60 * 1000).toISOString();

          const event = {
            summary: `Farrier - ${updatedAppointment.customerName}`,
            description: `Services: ${services.join(', ')}\nHorses: ${numberOfHorses || 'Not specified'}\nPhone: ${phone}`,
            location: `${address}, ${city}, ${state} ${zip}`,
            start: {
              dateTime: new Date(startDateTime).toISOString(),
              timeZone: 'America/New_York'
            },
            end: {
              dateTime: endDateTime,
              timeZone: 'America/New_York'
            }
          };

          const response = await fetch(
            `https://www.googleapis.com/calendar/v3/calendars/primary/events/${appointment.googleCalendarEventId}`,
            {
              method: 'PATCH',
              headers: {
                'Authorization': `Bearer ${userProfile.googleAccessToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(event)
            }
          );

          if (!response.ok) {
            console.error('âŒ Failed to update Google Calendar event:', await response.text());
            return false;
          }

          console.log('âœ… Google Calendar event updated successfully');
          return true;
        } catch (error) {
          console.error('âŒ Error updating Google Calendar:', error);
          return false;
        }
      };

      const handleSave = async () => {
        if (!phone || !date || !time) {
          alert('Please fill in Phone, Date, and Time');
          return;
        }

        setSaving(true);

        try {
          const updatedData = {
            phone,
            requestedDate: date,
            requestedTime: time,
            numberOfHorses: numberOfHorses || '',
            services,
            address: address || '',
            city: city || '',
            state: state || '',
            zip: zip || '',
            comments: comments || '',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          // Update Firestore
          await db.collection('appointments').doc(appointment.id).update(updatedData);
          console.log('âœ… Appointment updated in Firestore');

          // Update Google Calendar
          const calendarUpdated = await updateGoogleCalendarEvent({
            ...appointment,
            ...updatedData,
            customerName: appointment.customerName
          });

          if (calendarUpdated) {
            alert('âœ… Appointment updated successfully and synced to Google Calendar!');
          } else {
            alert('âš ï¸ Appointment updated but failed to sync to Google Calendar. You may need to update it manually.');
          }

          onSaved();
        } catch (error) {
          console.error('Error updating appointment:', error);
          alert('âŒ Error updating appointment');
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '600px'}}>
            <div className="modal-header">
              <h2>âœï¸ Edit Appointment</h2>
              <button className="close-btn" onClick={onClose}>Ã—</button>
            </div>

            <div style={{padding: '1.5rem', maxHeight: '70vh', overflowY: 'auto'}}>
              <div style={{marginBottom: '1rem', padding: '1rem', background: '#f0f9ff', borderRadius: '8px'}}>
                <div style={{fontWeight: '600', color: '#46C5FF'}}>Customer: {appointment.customerName}</div>
                <div style={{fontSize: '0.875rem', color: '#64748b'}}>Email: {appointment.email || 'Not provided'}</div>
              </div>

              <div className="form-group">
                <label>Phone Number *</label>
                <input 
                  type="tel"
                  value={phone}
                  onChange={(e) => setPhone(e.target.value)}
                  placeholder="561-555-0123"
                />
              </div>

              <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem'}}>
                <div className="form-group">
                  <label>Date *</label>
                  <input 
                    type="date"
                    value={date}
                    onChange={(e) => setDate(e.target.value)}
                  />
                </div>
                <div className="form-group">
                  <label>Time *</label>
                  <input 
                    type="time"
                    value={time}
                    onChange={(e) => setTime(e.target.value)}
                  />
                </div>
              </div>

              <div className="form-group">
                <label>Number of Horses</label>
                <input 
                  type="number"
                  value={numberOfHorses}
                  onChange={(e) => setNumberOfHorses(e.target.value)}
                  placeholder="4"
                  min="1"
                />
              </div>

              <div className="form-group">
                <label>Services</label>
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem'}}>
                  {availableServices.map(service => (
                    <label key={service} style={{
                      display: 'flex',
                      alignItems: 'center',
                      padding: '0.5rem',
                      border: '1px solid var(--border)',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      background: services.includes(service) ? '#dcfce7' : 'white'
                    }}>
                      <input 
                        type="checkbox"
                        checked={services.includes(service)}
                        onChange={() => handleServiceToggle(service)}
                        style={{marginRight: '0.5rem'}}
                      />
                      {service}
                    </label>
                  ))}
                </div>
              </div>

              <div className="form-group">
                <label>Address</label>
                <input 
                  type="text"
                  value={address}
                  onChange={(e) => setAddress(e.target.value)}
                  placeholder="123 Main Street"
                />
              </div>

              <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '1rem'}}>
                <div className="form-group">
                  <label>City</label>
                  <input 
                    type="text"
                    value={city}
                    onChange={(e) => setCity(e.target.value)}
                    placeholder="Royal Palm Beach"
                  />
                </div>
                <div className="form-group">
                  <label>State</label>
                  <input 
                    type="text"
                    value={state}
                    onChange={(e) => setState(e.target.value)}
                    placeholder="FL"
                    maxLength="2"
                  />
                </div>
                <div className="form-group">
                  <label>ZIP</label>
                  <input 
                    type="text"
                    value={zip}
                    onChange={(e) => setZip(e.target.value)}
                    placeholder="33411"
                    maxLength="5"
                  />
                </div>
              </div>

              <div className="form-group">
                <label>Notes / Comments</label>
                <textarea 
                  value={comments}
                  onChange={(e) => setComments(e.target.value)}
                  placeholder="Special instructions, gate codes, specific requests..."
                  rows="4"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: '2px solid var(--border)',
                    borderRadius: '8px',
                    fontSize: '1rem',
                    fontFamily: 'inherit',
                    resize: 'vertical'
                  }}
                />
              </div>

              <div style={{display: 'flex', gap: '1rem', marginTop: '2rem'}}>
                <button 
                  className="btn btn-outline"
                  onClick={onClose}
                  style={{flex: 1}}
                  disabled={saving}
                >
                  Cancel
                </button>
                <button 
                  className="btn btn-primary"
                  onClick={handleSave}
                  style={{flex: 1}}
                  disabled={saving}
                >
                  {saving ? 'Saving...' : 'ðŸ’¾ Save Changes'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function InvoicesView({ userId, userProfile }) {
      const [invoices, setInvoices] = useState([]);
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showPaymentModal, setShowPaymentModal] = useState(false);
      const [showManualPaymentModal, setShowManualPaymentModal] = useState(false);
      const [selectedInvoice, setSelectedInvoice] = useState(null);
      const [loading, setLoading] = useState(false);
      const [showCancelModal, setShowCancelModal] = useState(false);
      const [cancelPassword, setCancelPassword] = useState('');
      const [invoiceFilter, setInvoiceFilter] = useState('all'); // all, thisMonth, lastMonth, lastQuarter, ytd, paidOnly, openOnly, cancelledOnly, customRange
      const [customStartDate, setCustomStartDate] = useState('');
      const [customEndDate, setCustomEndDate] = useState('');

      useEffect(() => {
        loadInvoices();
      }, []);

      const loadInvoices = async () => {
        console.log('ðŸ”µ Loading invoices for userId:', userId);
        if (db) {
          const snapshot = await db.collection('invoices')
            .where('farrierId', '==', userId)
            .get();
          
          console.log('ðŸ“‹ Found invoices:', snapshot.docs.length);
          
          const invoiceData = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          // Sort in JavaScript instead of Firestore
          invoiceData.sort((a, b) => {
            if (!a.createdAt || !b.createdAt) return 0;
            return b.createdAt.toDate() - a.createdAt.toDate();
          });
          
          console.log('âœ… Loaded invoices:', invoiceData);
          setInvoices(invoiceData);
        } else {
          console.error('âŒ Database not initialized');
        }
      };

      const handleCancelInvoice = async () => {
        // Generate today's password (MMDDYYYY format)
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const year = today.getFullYear();
        const correctPassword = `${month}${day}${year}`;

        if (cancelPassword !== correctPassword) {
          alert(`âŒ Incorrect password. Today's password is MMDDYYYY format (e.g., ${correctPassword.slice(0,2)}${correctPassword.slice(2,4)}${correctPassword.slice(4)})`);
          return;
        }

        try {
          if (db && selectedInvoice) {
            await db.collection('invoices').doc(selectedInvoice.id).update({
              status: 'cancelled',
              cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
              cancelledBy: userId
            });

            alert('âœ… Invoice cancelled successfully');
            setShowCancelModal(false);
            setSelectedInvoice(null);
            setCancelPassword('');
            loadInvoices();
          }
        } catch (error) {
          console.error('Error cancelling invoice:', error);
          alert('âŒ Error cancelling invoice');
        }
      };

      // Export to Excel
      const exportToExcel = () => {
        const exportData = filteredInvoices.map(invoice => ({
          'Invoice Number': invoice.invoiceNumber || '',
          'Date': invoice.createdAt ? invoice.createdAt.toDate().toLocaleDateString('en-US') : '',
          'Customer': invoice.customerName || '',
          'Status': invoice.status || '',
          'Amount': invoice.total || 0,
          'Paid Date': invoice.paidAt ? invoice.paidAt.toDate().toLocaleDateString('en-US') : '',
          'Payment Method': invoice.cardLast4 ? `${invoice.cardType || 'Card'} ${invoice.cardLast4}` : '',
          'Transaction ID': invoice.transactionId || '',
          'Cancelled Date': invoice.cancelledAt ? invoice.cancelledAt.toDate().toLocaleDateString('en-US') : ''
        }));

        // Create worksheet
        const ws = window.XLSX.utils.json_to_sheet(exportData);

        // Set column widths
        ws['!cols'] = [
          { wch: 20 }, // Invoice Number
          { wch: 12 }, // Date
          { wch: 20 }, // Customer
          { wch: 12 }, // Status
          { wch: 12 }, // Amount
          { wch: 12 }, // Paid Date
          { wch: 20 }, // Payment Method
          { wch: 15 }, // Transaction ID
          { wch: 15 }  // Cancelled Date
        ];

        // Format amounts as currency
        const range = window.XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r + 1; R <= range.e.r; ++R) {
          const cellAddress = window.XLSX.utils.encode_cell({ r: R, c: 4 }); // Column E (Amount)
          if (ws[cellAddress]) {
            ws[cellAddress].z = '$#,##0.00';
          }
        }

        // Create workbook
        const wb = window.XLSX.utils.book_new();
        window.XLSX.utils.book_append_sheet(wb, ws, 'Invoices');

        // Generate filename with filter info
        const filterText = 
          invoiceFilter === 'thisMonth' ? 'This_Month' :
          invoiceFilter === 'lastMonth' ? 'Last_Month' :
          invoiceFilter === 'lastQuarter' ? 'Last_Quarter' :
          invoiceFilter === 'ytd' ? 'YTD' :
          invoiceFilter === 'paidOnly' ? 'Paid_Only' :
          invoiceFilter === 'openOnly' ? 'Open_Only' :
          invoiceFilter === 'cancelledOnly' ? 'Cancelled_Only' :
          invoiceFilter === 'customRange' ? 'Custom_Range' :
          'All_Invoices';
        
        const filename = `Farrier_Invoices_${filterText}_${new Date().toISOString().split('T')[0]}.xlsx`;

        // Download
        window.XLSX.writeFile(wb, filename);
      };

      // Filter invoices based on selected filter
      const getFilteredInvoices = () => {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();

        return invoices.filter(invoice => {
          // Apply status filter first
          if (invoiceFilter === 'paidOnly' && invoice.status !== 'paid') return false;
          if (invoiceFilter === 'openOnly' && invoice.status !== 'outstanding') return false;
          if (invoiceFilter === 'cancelledOnly' && invoice.status !== 'cancelled') return false;

          // Apply date filters
          if (!invoice.createdAt) return true; // Include invoices without dates
          
          const invoiceDate = invoice.createdAt.toDate();
          const invoiceYear = invoiceDate.getFullYear();
          const invoiceMonth = invoiceDate.getMonth();

          switch (invoiceFilter) {
            case 'thisMonth':
              return invoiceYear === currentYear && invoiceMonth === currentMonth;
            
            case 'lastMonth':
              const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
              const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
              return invoiceYear === lastMonthYear && invoiceMonth === lastMonth;
            
            case 'lastQuarter':
              const currentQuarter = Math.floor(currentMonth / 3);
              const lastQuarter = currentQuarter === 0 ? 3 : currentQuarter - 1;
              const lastQuarterYear = currentQuarter === 0 ? currentYear - 1 : currentYear;
              const invoiceQuarter = Math.floor(invoiceMonth / 3);
              return invoiceYear === lastQuarterYear && invoiceQuarter === lastQuarter;
            
            case 'ytd':
              return invoiceYear === currentYear;
            
            case 'customRange':
              if (!customStartDate || !customEndDate) return true;
              const start = new Date(customStartDate);
              const end = new Date(customEndDate);
              end.setHours(23, 59, 59);
              return invoiceDate >= start && invoiceDate <= end;
            
            default:
              return true;
          }
        });
      };

      const filteredInvoices = getFilteredInvoices();

      const getInvPaidAmount = (inv) => inv.paidAmount || (inv.payments||[]).reduce((s,p)=>s+(p.amount||0),0) || (inv.status==='paid'?(inv.total||0):0);
      const totalCollected = filteredInvoices.reduce((sum, inv) => sum + getInvPaidAmount(inv), 0);

      const totalOutstanding = filteredInvoices
        .filter(inv => inv.status === 'outstanding' || inv.status === 'partial')
        .reduce((sum, inv) => sum + Math.max(0, (inv.total||0) - getInvPaidAmount(inv)), 0);

      const totalCancelled = filteredInvoices
        .filter(inv => inv.status === 'cancelled')
        .reduce((sum, inv) => sum + (inv.total || 0), 0);

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Invoices & Payments</h1>
          
          <div className="dashboard-grid">
            <div className="stat-card">
              <div className="stat-label">Total Collected</div>
              <div className="stat-value" style={{color: 'var(--success)'}}>${totalCollected.toFixed(2)}</div>
            </div>
            <div className="stat-card">
              <div className="stat-label">Outstanding</div>
              <div className="stat-value" style={{color: 'var(--warning)'}}>${totalOutstanding.toFixed(2)}</div>
            </div>
            {totalCancelled > 0 && (
              <div className="stat-card">
                <div className="stat-label">Cancelled</div>
                <div className="stat-value" style={{color: '#6b7280'}}>${totalCancelled.toFixed(2)}</div>
              </div>
            )}
          </div>

          <div className="card">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem'}}>
              <h2 style={{marginBottom: 0}}>Your Invoices</h2>
              <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                + Create Invoice
              </button>
            </div>

            {/* Filter Buttons */}
            <div style={{
              display: 'flex',
              gap: '0.5rem',
              marginBottom: '1.5rem',
              flexWrap: 'wrap',
              paddingBottom: '1rem',
              borderBottom: '1px solid var(--border)'
            }}>
              <button
                onClick={() => setInvoiceFilter('all')}
                className={`btn btn-sm ${invoiceFilter === 'all' ? 'btn-primary' : 'btn-outline'}`}
              >
                All Invoices
              </button>
              <button
                onClick={() => setInvoiceFilter('thisMonth')}
                className={`btn btn-sm ${invoiceFilter === 'thisMonth' ? 'btn-primary' : 'btn-outline'}`}
              >
                This Month
              </button>
              <button
                onClick={() => setInvoiceFilter('lastMonth')}
                className={`btn btn-sm ${invoiceFilter === 'lastMonth' ? 'btn-primary' : 'btn-outline'}`}
              >
                Last Month
              </button>
              <button
                onClick={() => setInvoiceFilter('lastQuarter')}
                className={`btn btn-sm ${invoiceFilter === 'lastQuarter' ? 'btn-primary' : 'btn-outline'}`}
              >
                Last Quarter
              </button>
              <button
                onClick={() => setInvoiceFilter('ytd')}
                className={`btn btn-sm ${invoiceFilter === 'ytd' ? 'btn-primary' : 'btn-outline'}`}
              >
                Year to Date
              </button>
              <button
                onClick={() => setInvoiceFilter('paidOnly')}
                className={`btn btn-sm ${invoiceFilter === 'paidOnly' ? 'btn-primary' : 'btn-outline'}`}
              >
                âœ… Paid Only
              </button>
              <button
                onClick={() => setInvoiceFilter('openOnly')}
                className={`btn btn-sm ${invoiceFilter === 'openOnly' ? 'btn-primary' : 'btn-outline'}`}
              >
                â³ Open Only
              </button>
              <button
                onClick={() => setInvoiceFilter('cancelledOnly')}
                className={`btn btn-sm ${invoiceFilter === 'cancelledOnly' ? 'btn-primary' : 'btn-outline'}`}
              >
                ðŸš« Cancelled Only
              </button>
              <button
                onClick={() => setInvoiceFilter('customRange')}
                className={`btn btn-sm ${invoiceFilter === 'customRange' ? 'btn-primary' : 'btn-outline'}`}
              >
                ðŸ“… Custom Range
              </button>
              {filteredInvoices.length > 0 && (
                <button
                  onClick={exportToExcel}
                  className="btn btn-sm"
                  style={{
                    background: '#2683FB',
                    color: 'white',
                    fontWeight: '600',
                    marginLeft: 'auto'
                  }}
                  onMouseOver={(e) => e.target.style.background = '#15803d'}
                  onMouseOut={(e) => e.target.style.background = '#2683FB'}
                >
                  ðŸ“Š Export to Excel
                </button>
              )}
            </div>

            {/* Custom Date Range Picker */}
            {invoiceFilter === 'customRange' && (
              <div style={{
                marginBottom: '1.5rem',
                padding: '1rem',
                background: '#f9fafb',
                borderRadius: '8px',
                display: 'flex',
                gap: '1rem',
                alignItems: 'end',
                flexWrap: 'wrap'
              }}>
                <div style={{flex: 1, minWidth: '200px'}}>
                  <label style={{display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500'}}>
                    Start Date
                  </label>
                  <input 
                    type="date"
                    value={customStartDate}
                    onChange={(e) => setCustomStartDate(e.target.value)}
                    style={{
                      width: '100%',
                      padding: '0.5rem',
                      borderRadius: '4px',
                      border: '1px solid var(--border)',
                      fontSize: '0.875rem'
                    }}
                  />
                </div>
                <div style={{flex: 1, minWidth: '200px'}}>
                  <label style={{display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: '500'}}>
                    End Date
                  </label>
                  <input 
                    type="date"
                    value={customEndDate}
                    onChange={(e) => setCustomEndDate(e.target.value)}
                    style={{
                      width: '100%',
                      padding: '0.5rem',
                      borderRadius: '4px',
                      border: '1px solid var(--border)',
                      fontSize: '0.875rem'
                    }}
                  />
                </div>
                {customStartDate && customEndDate && (
                  <div style={{
                    padding: '0.5rem 1rem',
                    background: 'white',
                    border: '1px solid var(--border)',
                    borderRadius: '4px',
                    fontSize: '0.875rem',
                    color: 'var(--text-muted)'
                  }}>
                    ðŸ“† {new Date(customStartDate).toLocaleDateString()} - {new Date(customEndDate).toLocaleDateString()}
                  </div>
                )}
              </div>
            )}

            {filteredInvoices.length === 0 ? (
              <p style={{color: 'var(--text-muted)'}}>
                No invoices found for selected filter.
              </p>
            ) : (
              <>
                <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginBottom: '1rem'}}>
                  Showing {filteredInvoices.length} of {invoices.length} invoice{invoices.length !== 1 ? 's' : ''}
                </div>
                <div className="appointments-list">
                  {filteredInvoices.map(invoice => (
                  <div key={invoice.id} className="appointment-item">
                    <div className="appointment-info">
                      <div className="appointment-customer">
                        Invoice #{invoice.invoiceNumber} - {invoice.customerName}
                      </div>
                      <div className="appointment-details">
                        Amount: ${invoice.total?.toFixed(2)} â€¢ Created: {invoice.createdAt?.toDate().toLocaleDateString()}
                        {invoice.status === 'partial' && (() => { const paid = invoice.paidAmount || (invoice.payments||[]).reduce((s,p)=>s+(p.amount||0),0); const bal = Math.max(0,(invoice.total||0)-paid); return <> â€¢ <strong style={{color:'#d97706'}}>Balance Due: ${bal.toFixed(2)}</strong></>; })()}
                        {invoice.status === 'paid' && invoice.paidAt && (
                          <><br/>Paid: {invoice.paidAt?.toDate().toLocaleDateString()} 
                          {invoice.cardLast4 && <> â€¢ {invoice.cardType || 'Card'} {invoice.cardLast4}</>}
                          {invoice.transactionId && <> â€¢ Transaction: {invoice.transactionId}</>}
                          </>
                        )}
                        {invoice.paymentUrl && (
                          <><br/>Payment Link: <a href={invoice.paymentUrl} target="_blank" style={{color: 'var(--primary)'}}>View</a></>
                        )}
                      </div>
                    </div>
                    <div className="appointment-actions">
                      <span className={`badge badge-${
                        invoice.status === 'paid' ? 'success' : 
                        invoice.status === 'cancelled' ? 'secondary' :
                        invoice.status === 'partial' ? 'warning' :
                        'warning'
                      }`}>
                        {invoice.status === 'partial' ? `partial ($${((invoice.payments || []).reduce((s,p) => s + (p.amount||0), 0)).toFixed(2)} paid)` : invoice.status}
                      </span>
                      <button
                        className="btn btn-sm btn-outline"
                        onClick={() => openInvoicePdf(invoice, userProfile, userProfile?.autoPrintPdf ?? true)}
                        title="Open a professional PDF invoice (then print or save as PDF)"
                      >
                        ðŸ–¨ï¸ Print / PDF
                      </button>
                      <button
                        className="btn btn-sm btn-outline"
                        onClick={() => emailInvoiceLink(invoice)}
                        title="Email the invoice link"
                      >
                        âœ‰ï¸ Email
                      </button>
                      {invoice.paymentUrl && (
                        <button
                          className="btn btn-sm btn-outline"
                          onClick={() => { navigator.clipboard?.writeText(String(invoice.paymentUrl)); alert("Payment link copied."); }}
                          title="Copy payment link"
                        >
                          ðŸ”— Copy Link
                        </button>
                      )}
                      {(invoice.status === 'outstanding' || invoice.status === 'partial') && (
                        <>
                          <button 
                            className="btn btn-sm btn-success"
                            onClick={() => {
                              setSelectedInvoice(invoice);
                              setShowPaymentModal(true);
                            }}
                          >
                            ðŸ’³ Pay Now
                          </button>
                          {userProfile?.allowManualPayments !== false && (
                            <button
                              className="btn btn-sm"
                              style={{background: '#059669', color: 'white'}}
                              onClick={() => {
                                setSelectedInvoice(invoice);
                                setShowManualPaymentModal(true);
                              }}
                            >
                              ðŸ’µ Record Payment
                            </button>
                          )}
                          <button 
                            className="btn btn-sm btn-danger"
                            onClick={() => {
                              setSelectedInvoice(invoice);
                              setShowCancelModal(true);
                            }}
                            style={{background: '#ef4444'}}
                          >
                            ðŸš« Cancel
                          </button>
                        </>
                      )}
                      {invoice.status === 'outstanding' && invoice.paymentUrl && (
                        <button 
                          className="btn btn-sm btn-warning"
                          onClick={() => {
                            const message = `Hi ${invoice.customerName}! Your invoice #${invoice.invoiceNumber} for $${invoice.total?.toFixed(2)} is ready. Pay here: ${invoice.paymentUrl}`;
                            alert(`SMS would be sent:\n\n${message}`);
                          }}
                        >
                          ðŸ“± Send Reminder
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
              </>
            )}
          </div>

          {showCreateModal && (
            <InvoiceCreateModal 
              userId={userId}
              userProfile={userProfile}
              onClose={() => setShowCreateModal(false)}
              onCreated={async (createdInvoice) => {
                setShowCreateModal(false);
                loadInvoices();
                if (createdInvoice) {
                  // Auto-open PDF after create (toggle in Settings)
                  openInvoicePdf(createdInvoice, userProfile, userProfile?.autoPrintPdf ?? true);
                  // Send SMS invoice notification if enabled
                  if (userProfile?.smsEnabled && createdInvoice.customerPhone) {
                    const bizName = userProfile?.businessName || 'Your Farrier';
                    const payLink = createdInvoice.paymentUrl || '';
                    const msg = `Hi ${createdInvoice.customerName}, you have a new invoice #${createdInvoice.invoiceNumber} for $${createdInvoice.total?.toFixed(2)} from ${bizName}.${payLink ? ` Pay here: ${payLink}` : ''} Reply STOP to opt out.`;
                    try {
                      await fetch('/api/send-sms', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ to: createdInvoice.customerPhone, body: msg })
                      });
                    } catch(e) { console.error('Invoice SMS error:', e); }
                  }
                }
              }}
            />
          )}

          {showPaymentModal && selectedInvoice && (
            <PaymentModal 
              invoice={selectedInvoice}
              onClose={() => {
                setShowPaymentModal(false);
                setSelectedInvoice(null);
              }}
              onPaymentSuccess={() => {
                setShowPaymentModal(false);
                setSelectedInvoice(null);
                loadInvoices();
              }}
            />
          )}

          {showManualPaymentModal && selectedInvoice && (
            <ManualPaymentModal
              invoice={selectedInvoice}
              onClose={() => {
                setShowManualPaymentModal(false);
                setSelectedInvoice(null);
              }}
              onPaymentRecorded={() => {
                setShowManualPaymentModal(false);
                setSelectedInvoice(null);
                loadInvoices();
              }}
            />
          )}

          {showCancelModal && selectedInvoice && (
            <div className="modal-overlay" onClick={() => setShowCancelModal(false)}>
              <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '500px'}}>
                <div className="modal-header">
                  <h2>ðŸš« Cancel Invoice</h2>
                  <button className="close-btn" onClick={() => setShowCancelModal(false)}>Ã—</button>
                </div>

                <div style={{padding: '1.5rem'}}>
                  <div style={{
                    padding: '1rem',
                    background: '#fef2f2',
                    border: '1px solid #fecaca',
                    borderRadius: '8px',
                    marginBottom: '1.5rem'
                  }}>
                    <div style={{fontWeight: '600', marginBottom: '0.5rem'}}>
                      Invoice: {selectedInvoice.invoiceNumber}
                    </div>
                    <div style={{color: 'var(--text-muted)', fontSize: '0.9rem'}}>
                      Customer: {selectedInvoice.customerName}
                    </div>
                    <div style={{color: 'var(--text-muted)', fontSize: '0.9rem'}}>
                      Amount: ${selectedInvoice.total?.toFixed(2)}
                    </div>
                  </div>

                  <div style={{marginBottom: '1rem', color: '#991b1b', fontWeight: '500'}}>
                    âš ï¸ This will mark the invoice as CANCELLED. It will remain in the system for records but cannot be paid.
                  </div>

                  <div className="form-group">
                    <label>Password (MMDDYYYY format) *</label>
                    <input 
                      type="password"
                      value={cancelPassword}
                      onChange={(e) => setCancelPassword(e.target.value)}
                      placeholder="Enter today's date (e.g., 01272026)"
                      autoFocus
                    />
                    <div style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                      Enter today's date in MMDDYYYY format
                    </div>
                  </div>

                  <div style={{display: 'flex', gap: '0.75rem', marginTop: '1.5rem'}}>
                    <button 
                      className="btn btn-outline"
                      onClick={() => {
                        setShowCancelModal(false);
                        setCancelPassword('');
                      }}
                      style={{flex: 1}}
                    >
                      Nevermind
                    </button>
                    <button 
                      className="btn"
                      onClick={handleCancelInvoice}
                      style={{flex: 1, background: '#ef4444', color: 'white'}}
                    >
                      Cancel Invoice
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function PaymentModal({ invoice, onClose, onPaymentSuccess }) {
      const paidSoFar = (invoice.payments || []).reduce((s,p) => s + (p.amount||0), 0);
      const remaining = Math.max(0, (invoice.total || 0) - paidSoFar);
      const [cardNumber, setCardNumber] = useState('');
      const [expiryMonth, setExpiryMonth] = useState('');
      const [expiryYear, setExpiryYear] = useState('');
      const [cvv, setCvv] = useState('');
      const [chargeAmount, setChargeAmount] = useState(remaining.toFixed(2));
      const [processing, setProcessing] = useState(false);
      const [error, setError] = useState('');

      const handlePayment = async (e) => {
        e.preventDefault();
        setProcessing(true);
        setError('');

        try {
          // Format expiration date as MMYY
          const expirationDate = `${expiryMonth.padStart(2, '0')}${expiryYear.slice(-2)}`;

          // Call Vercel function to process payment
          const response = await fetch('/api/authorize-net-payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              action: 'charge',
              paymentData: {
                cardNumber: cardNumber.replace(/\s/g, ''),
                expirationDate: expirationDate,
                cardCode: cvv,
                amount: parseFloat(chargeAmount) || invoice.total,
                customerEmail: invoice.customerEmail || 'customer@example.com',
                customerName: invoice.customerName,
                invoiceNumber: invoice.invoiceNumber,
                description: `FarriTech Invoice #${invoice.invoiceNumber}`
              },
              invoiceData: {
                invoiceId: invoice.id,
                farrierId: invoice.farrierId
              }
            })
          });

          const result = await response.json();

          if (result.success) {
            if (db) {
              const amt = parseFloat(chargeAmount) || invoice.total;
              // Fetch fresh from Firestore to avoid stale payments array
              const freshDoc = await db.collection('invoices').doc(invoice.id).get();
              const freshData = freshDoc.exists ? freshDoc.data() : {};
              const existingPayments = freshData.payments || [];
              const newPayment = {
                amount: amt,
                method: 'credit_card',
                memo: result.accountNumber ? `Card ending ${result.accountNumber}` : 'Credit card',
                date: new Date().toISOString(),
                transactionId: result.transactionId,
                authCode: result.authCode
              };
              const allPayments = [...existingPayments, newPayment];
              const totalPaid = allPayments.reduce((s,p) => s + (p.amount||0), 0);
              const newStatus = totalPaid >= invoice.total ? 'paid' : 'partial';
              await db.collection('invoices').doc(invoice.id).update({
                status: newStatus,
                payments: allPayments,
                paidAmount: totalPaid,
                balanceDue: Math.max(0, invoice.total - totalPaid),
                paidAt: newStatus === 'paid' ? firebase.firestore.FieldValue.serverTimestamp() : (freshData.paidAt || null),
                transactionId: result.transactionId,
                authCode: result.authCode,
                accountNumber: result.accountNumber
              });
            }
            alert('âœ… Payment successful!');
            onPaymentSuccess();
          } else {
            setError(result.error || 'Payment failed. Please try again.');
          }
        } catch (err) {
          console.error('Payment error:', err);
          setError('Payment processing failed. Please try again.');
        }

        setProcessing(false);
      };

      // Format card number with spaces
      const formatCardNumber = (value) => {
        const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        const matches = v.match(/\d{4,16}/g);
        const match = (matches && matches[0]) || '';
        const parts = [];
        
        for (let i = 0, len = match.length; i < len; i += 4) {
          parts.push(match.substring(i, i + 4));
        }
        
        return parts.length ? parts.join(' ') : value;
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '500px'}}>
            <h2 style={{marginBottom: '1.5rem'}}>ðŸ’³ Pay Invoice</h2>
            
            <div style={{background: '#f8f9fa', padding: '1rem', borderRadius: '8px', marginBottom: '1.5rem'}}>
              <div style={{fontSize: '0.875rem', color: 'rgba(234,242,255,0.65)', marginBottom: '0.5rem'}}>
                Invoice #{invoice.invoiceNumber} â€¢ {invoice.customerName}
              </div>
              <div style={{fontSize: '0.875rem', color: 'rgba(234,242,255,0.65)'}}>
                Invoice Total: ${invoice.total?.toFixed(2)}
                {paidSoFar > 0 && <> â€¢ Already Paid: ${paidSoFar.toFixed(2)} â€¢ <strong>Balance: ${remaining.toFixed(2)}</strong></>}
              </div>
            </div>
            <div className="form-group">
              <label>Amount to Charge *</label>
              <input
                type="number"
                step="0.01"
                min="0.01"
                max={invoice.total}
                required
                value={chargeAmount}
                onChange={(e) => setChargeAmount(e.target.value)}
              />
            </div>

            {error && (
              <div className="error-message" style={{marginBottom: '1rem'}}>
                {error}
              </div>
            )}

            <form onSubmit={handlePayment}>
              <div className="form-group">
                <label>Card Number *</label>
                <input 
                  type="text"
                  required
                  value={cardNumber}
                  onChange={(e) => setCardNumber(formatCardNumber(e.target.value))}
                  placeholder="1234 5678 9012 3456"
                  maxLength="19"
                />
                <div style={{fontSize: '0.75rem', color: 'rgba(234,242,255,0.65)', marginTop: '0.25rem'}}>
                  Test: 4111 1111 1111 1111
                </div>
              </div>

              <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '0.75rem'}}>
                <div className="form-group">
                  <label>Month *</label>
                  <input 
                    type="text"
                    required
                    value={expiryMonth}
                    onChange={(e) => setExpiryMonth(e.target.value.replace(/\D/g, '').slice(0, 2))}
                    placeholder="MM"
                    maxLength="2"
                  />
                </div>

                <div className="form-group">
                  <label>Year *</label>
                  <input 
                    type="text"
                    required
                    value={expiryYear}
                    onChange={(e) => setExpiryYear(e.target.value.replace(/\D/g, '').slice(0, 4))}
                    placeholder="YYYY"
                    maxLength="4"
                  />
                </div>

                <div className="form-group">
                  <label>CVV *</label>
                  <input 
                    type="text"
                    required
                    value={cvv}
                    onChange={(e) => setCvv(e.target.value.replace(/\D/g, '').slice(0, 4))}
                    placeholder="123"
                    maxLength="4"
                  />
                </div>
              </div>

              <div style={{display: 'flex', gap: '0.75rem', marginTop: '1.5rem'}}>
                <button 
                  type="button"
                  onClick={onClose}
                  className="btn btn-outline"
                  disabled={processing}
                  style={{flex: 1}}
                >
                  Cancel
                </button>
                <button 
                  type="submit"
                  className="btn btn-success"
                  disabled={processing}
                  style={{flex: 1}}
                >
                  {processing ? <span className="spinner"></span> : `Pay $${parseFloat(chargeAmount || 0).toFixed(2)}`}
                </button>
              </div>
            </form>

            <div style={{marginTop: '1.5rem', padding: '1rem', background: '#f0f9ff', borderRadius: '8px', fontSize: '0.875rem'}}>
              ðŸ”’ <strong>Secure Payment</strong><br/>
              Your payment is processed securely by Authorize.Net
            </div>
          </div>
        </div>
      );
    }


    function ManualPaymentModal({ invoice, onClose, onPaymentRecorded }) {
      const paidSoFar = (invoice.payments || []).reduce((s,p) => s + (p.amount||0), 0);
      const remaining = Math.max(0, (invoice.total || 0) - paidSoFar);
      const [amount, setAmount] = useState(remaining.toFixed(2));
      const [method, setMethod] = useState('cash');
      const [memo, setMemo] = useState('');
      const [datePaid, setDatePaid] = useState(new Date().toISOString().split('T')[0]);
      const [processing, setProcessing] = useState(false);
      const [error, setError] = useState('');

      const handleRecord = async (e) => {
        e.preventDefault();
        const amt = parseFloat(amount);
        if (!amt || amt <= 0) { setError('Please enter a valid amount.'); return; }
        setProcessing(true);
        setError('');
        try {
          if (db) {
            // Fetch fresh from Firestore to avoid stale payments array
            const freshDoc = await db.collection('invoices').doc(invoice.id).get();
            const freshData = freshDoc.exists ? freshDoc.data() : {};
            const existingPayments = freshData.payments || [];
            const newPayment = {
              amount: amt,
              method: method,
              memo: memo,
              date: new Date(datePaid).toISOString()
            };
            const allPayments = [...existingPayments, newPayment];
            const totalPaid = allPayments.reduce((s,p) => s + (p.amount||0), 0);
            const newStatus = totalPaid >= invoice.total ? 'paid' : 'partial';
            await db.collection('invoices').doc(invoice.id).update({
              status: newStatus,
              payments: allPayments,
              paidAmount: totalPaid,
              balanceDue: Math.max(0, invoice.total - totalPaid),
              paidAt: newStatus === 'paid' ? firebase.firestore.FieldValue.serverTimestamp() : (freshData.paidAt || null)
            });
            onPaymentRecorded();
          }
        } catch (err) {
          console.error('Error recording payment:', err);
          setError('Failed to record payment. Please try again.');
        }
        setProcessing(false);
      };

      const methodLabels = { cash: 'ðŸ’µ Cash', check: 'ðŸ“ Check', other: 'ðŸ”„ Other' };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '480px'}}>
            <h2 style={{marginBottom: '1.5rem'}}>ðŸ’µ Record Manual Payment</h2>

            <div style={{background: '#f8f9fa', padding: '1rem', borderRadius: '8px', marginBottom: '1.5rem'}}>
              <div style={{fontSize: '0.875rem', color: 'rgba(234,242,255,0.65)', marginBottom: '0.25rem'}}>
                Invoice #{invoice.invoiceNumber} â€¢ {invoice.customerName}
              </div>
              <div style={{fontSize: '0.875rem', color: 'rgba(234,242,255,0.65)'}}>
                Invoice Total: ${invoice.total?.toFixed(2)}
                {paidSoFar > 0 && <> â€¢ Already Paid: ${paidSoFar.toFixed(2)} â€¢ <strong>Balance: ${remaining.toFixed(2)}</strong></>}
              </div>
            </div>

            {error && <div className="error-message" style={{marginBottom:'1rem'}}>{error}</div>}

            <form onSubmit={handleRecord}>
              <div className="form-group">
                <label>Amount Received *</label>
                <input
                  type="number"
                  step="0.01"
                  min="0.01"
                  required
                  value={amount}
                  onChange={(e) => setAmount(e.target.value)}
                />
              </div>

              <div className="form-group">
                <label>Payment Method *</label>
                <select value={method} onChange={(e) => setMethod(e.target.value)}>
                  <option value="cash">ðŸ’µ Cash</option>
                  <option value="check">ðŸ“ Check</option>
                  <option value="other">ðŸ”„ Other</option>
                </select>
              </div>

              <div className="form-group">
                <label>Memo / Note (optional)</label>
                <input
                  type="text"
                  value={memo}
                  onChange={(e) => setMemo(e.target.value)}
                  placeholder={method === 'check' ? 'e.g. Check #1042' : 'Optional note'}
                />
              </div>

              <div className="form-group">
                <label>Date Paid *</label>
                <input
                  type="date"
                  required
                  value={datePaid}
                  onChange={(e) => setDatePaid(e.target.value)}
                />
              </div>

              <div style={{display:'flex', gap:'0.75rem', marginTop:'1.5rem'}}>
                <button type="button" onClick={onClose} className="btn btn-outline" disabled={processing} style={{flex:1}}>
                  Cancel
                </button>
                <button type="submit" className="btn" disabled={processing} style={{flex:1, background:'#059669', color:'white'}}>
                  {processing ? <span className="spinner"></span> : `Record $${parseFloat(amount||0).toFixed(2)} Payment`}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function InvoiceCreateModal({ userId, userProfile, onClose, onCreated, prefillData }) {
      const [customerName, setCustomerName] = useState(prefillData?.customerName || '');
      const [customerEmail, setCustomerEmail] = useState(prefillData?.customerEmail || '');
      const [customerPhone, setCustomerPhone] = useState(prefillData?.customerPhone || '');
      const [items, setItems] = useState([{ description: '', amount: 0, horseName: '' }]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [customers, setCustomers] = useState([]);
      const [loadingCustomers, setLoadingCustomers] = useState(true);
      const [phoneSearching, setPhoneSearching] = useState(false);
      const [selectedCustomerInfo, setSelectedCustomerInfo] = useState(null);

      // Handle prefill data
      useEffect(() => {
        if (prefillData) {
          console.log('ðŸ“ Prefilling invoice with data:', prefillData);
          if (prefillData.customerName) setCustomerName(prefillData.customerName);
          if (prefillData.customerEmail) setCustomerEmail(prefillData.customerEmail);
          if (prefillData.customerPhone) setCustomerPhone(prefillData.customerPhone);
        }
      }, [prefillData]);

      // Load existing customers
      useEffect(() => {
        loadCustomers();
      }, []);

      const loadCustomers = async () => {
        if (db) {
          try {
            // Load from customers collection - filter by farrierId
            const customersSnapshot = await db.collection('customers').where('farrierId', '==', userId).get();
            const customersList = customersSnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            // Also load from appointments (for customers who booked but might not have customer profile)
            const appointmentsSnapshot = await db.collection('appointments')
              .where('farrierId', '==', userId)
              .get();
            
            const appointmentCustomers = appointmentsSnapshot.docs.map(doc => ({
              name: doc.data().customerName,
              email: doc.data().email,
              phone: doc.data().phone
            }));

            // Combine and deduplicate by email
            const allCustomers = [...customersList, ...appointmentCustomers];
            const uniqueCustomers = Array.from(
              new Map(allCustomers.map(c => [c.email, c])).values()
            ).sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            setCustomers(uniqueCustomers);
          } catch (error) {
            console.error('Error loading customers:', error);
          }
        }
        setLoadingCustomers(false);
      };

      const loadCustomerInvoiceInfo = async (customerEmail) => {
        if (!db || !customerEmail) {
          setSelectedCustomerInfo(null);
          return;
        }

        try {
          // Get all invoices for this customer
          const invoicesSnapshot = await db.collection('invoices')
            .where('customerEmail', '==', customerEmail)
            .orderBy('createdAt', 'desc')
            .get();

          const invoices = invoicesSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));

          // Calculate balance (outstanding invoices)
          const balance = invoices
            .filter(inv => inv.status === 'outstanding')
            .reduce((sum, inv) => sum + (inv.total || 0), 0);

          // Get last invoice
          const lastInvoice = invoices.length > 0 ? invoices[0] : null;

          // Total paid
          const totalPaid = invoices
            .filter(inv => inv.status === 'paid')
            .reduce((sum, inv) => sum + (inv.total || 0), 0);

          setSelectedCustomerInfo({
            balance,
            lastInvoice,
            totalInvoices: invoices.length,
            totalPaid
          });
        } catch (error) {
          console.error('Error loading customer invoice info:', error);
          setSelectedCustomerInfo(null);
        }
      };

      const selectCustomer = async (customerData) => {
        if (customerData) {
          setCustomerName(customerData.name || '');
          setCustomerEmail(customerData.email || '');
          setCustomerPhone(customerData.phone || '');
          
          // Load invoice info for this customer
          await loadCustomerInvoiceInfo(customerData.email);
        } else {
          setSelectedCustomerInfo(null);
        }
      };

      const lookupByPhone = async (phone) => {
        if (!phone || phone.length < 10) return;
        
        setPhoneSearching(true);
        
        // Clean phone number (remove spaces, dashes, parentheses)
        const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
        
        // Search in customers
        const customer = customers.find(c => 
          c.phone && c.phone.replace(/[\s\-\(\)]/g, '').includes(cleanPhone)
        );

        if (customer) {
          setCustomerName(customer.name || '');
          setCustomerEmail(customer.email || '');
          
          // Load invoice info
          await loadCustomerInvoiceInfo(customer.email);
        }
        
        setPhoneSearching(false);
      };

     // Services loaded from Firestore (plus a couple of UI-only rows)
const [serviceOptions, setServiceOptions] = useState([
  { id: "", name: "-- Select Service --", price: 0 },
  { id: "__custom__", name: "Custom Service (enter manually)", price: 0 }
]);

useEffect(() => {
  const loadServices = async () => {
    if (!db || !userId) return;

    const snap = await db.collection("services")
      .where("farrierId", "==", userId)
      .where("isActive", "==", true)
      .get();

    const list = snap.docs.map(d => ({
      id: d.id,
      ...d.data()
    }));

    // Sort by category then name (optional)
    list.sort((a,b) =>
      String(a.category || "").localeCompare(String(b.category || "")) ||
      String(a.name || "").localeCompare(String(b.name || ""))
    );

    // Optional: insert category headers like your old list
    const rows = [{ id: "", name: "-- Select Service --", price: 0 }];
    let lastCat = null;

    list.forEach(svc => {
      const cat = (svc.category || "").trim();
      if (cat && cat !== lastCat) {
        rows.push({ id: `__header__${cat}`, name: `â”€â”€â”€ ${cat.toUpperCase()} â”€â”€â”€`, price: 0, isHeader: true });
        lastCat = cat;
      }
      rows.push({
        id: svc.id,
        name: svc.name || "",
        price: Number(svc.price || svc.defaultPrice || 0),
        isHeader: false
      });
    });

    rows.push({ id: "__custom__", name: "Custom Service (enter manually)", price: 0 });

    setServiceOptions(rows);
  };

  loadServices();
}, [userId]);

      const addItem = () => {
        setItems([...items, { description: '', amount: 0, horseName: '' }]);
      };

      const updateItem = (index, field, value) => {
        const newItems = [...items];
        newItems[index][field] = value;
        setItems(newItems);
      };

     const selectService = (index, serviceName) => {
  const service = serviceOptions.find(s => s.name === serviceName);

  // Ignore headers / placeholder
  if (!service || service.isHeader || service.name === "-- Select Service --") return;

  const newItems = [...items];

  if (service.id === "__custom__") {
    // Let user type description and price manually
    newItems[index].description = "Custom Service (enter manually)";
    newItems[index].amount = 0;
  } else {
    newItems[index].description = service.name;
    newItems[index].amount = Number(service.price || 0);

    // (Optional snapshots so invoice history doesn't change when service changes)
    newItems[index].serviceId = service.id;
    newItems[index].serviceNameSnapshot = service.name;
    newItems[index].unitPriceSnapshot = Number(service.price || 0);
  }

  setItems(newItems);
};


      const removeItem = (index) => {
        setItems(items.filter((_, i) => i !== index));
      };

      const total = items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

      const generatePaymentLink = async () => {
        if (!customerName || !customerEmail) {
          setError('Customer name and email are required');
          return;
        }

        if (total <= 0) {
          setError('Invoice total must be greater than $0');
          return;
        }

        // Clean up items - replace "Custom Service (enter manually)" with placeholder if not changed
        const cleanedItems = items
  .filter(i => String(i.description || "").trim() || Number(i.amount || 0) > 0)
  .map(i => ({
    // display fields
    description: String(i.description || "").trim(),
    horseName: String(i.horseName || "").trim(),
    qty: Number(i.qty || 1),
    amount: Number(i.amount || 0),

    // service linkage + immutable snapshots (so old invoices never change)
    serviceId: i.serviceId || "",
    serviceNameSnapshot: i.serviceNameSnapshot || String(i.description || "").trim(),
    unitPriceSnapshot: Number(i.unitPriceSnapshot ?? i.amount ?? 0),
  }));


        setError('');
        setLoading(true);

        try {
          // Save invoice to Firestore (no payment link needed - using Pay Now button)
          if (db) {
            // Generate sequential 5-digit invoice number
            let invoiceNumber;
            
            // Get all invoices for this farrier to find the highest number
            const allInvoicesQuery = await db.collection('invoices')
              .where('farrierId', '==', userId)
              .get();
            
            if (!allInvoicesQuery.empty) {
              // Find the highest 5-digit invoice number (ignore old 13-digit ones)
              let highestNumber = 9999; // Start below 10000
              
              allInvoicesQuery.docs.forEach(doc => {
                const data = doc.data();
                if (data.invoiceNumber && data.invoiceNumber.startsWith('INV-')) {
                  const num = parseInt(data.invoiceNumber.replace('INV-', ''));
                  // Only count 5-digit numbers (10000-99999)
                  if (!isNaN(num) && num >= 10000 && num <= 99999 && num > highestNumber) {
                    highestNumber = num;
                  }
                }
              });
              
              const nextNumber = highestNumber + 1;
              invoiceNumber = `INV-${nextNumber}`;
            } else {
              // First invoice - start at 10000
              invoiceNumber = 'INV-10000';
            }
            console.log('ðŸ”µ Creating invoice:', {
              farrierId: userId,
              customerName,
              total,
              invoiceNumber
            });
            
            const docRef = await db.collection('invoices').add({
              farrierId: userId,
              customerName: customerName,
              customerEmail: customerEmail,
              customerPhone: customerPhone,
              items: cleanedItems,
              total: total,
              invoiceNumber: invoiceNumber,
              status: 'outstanding',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            console.log('âœ… Invoice created with ID:', docRef.id);
            alert('âœ… Invoice created successfully! Customer can now pay using the "Pay Now" button.');
            const createdInvoice = {
              id: docRef.id,
              farrierId: userId,
              customerName,
              customerEmail,
              customerPhone,
              items: cleanedItems,
              total,
              invoiceNumber,
              status: 'outstanding',
              paymentUrl: '',
              createdAt: new Date()
            };
                      onCreated(createdInvoice);
          } else {
            console.error('âŒ Database not initialized');
            setError('Database not available');
          }
       } catch (err) {
  console.error('âŒ Error creating invoice:', err);
  setError('Error creating invoice. Please try again.');
} finally {
  setLoading(false);
}
};

      const sendInvoice = () => {
        const message = `Hi ${customerName}! Your invoice for $${total.toFixed(2)} is ready. Pay here: ${paymentUrl}`;
        alert(`SMS would be sent to ${customerPhone}:\n\n${message}`);
        onCreated();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Create Invoice</h2>
              <button className="close-btn" onClick={onClose}>Ã—</button>
            </div>

            {error && <div className="error-message">{error}</div>}

            {prefillData && (
              <div style={{
                marginBottom: '1.5rem',
                padding: '1rem',
                background: '#f0f9ff',
                border: '2px solid #0ea5e9',
                borderRadius: '8px'
              }}>
                <div style={{fontSize: '0.875rem', fontWeight: '600', color: '#46C5FF', marginBottom: '0.5rem'}}>
                  ðŸ“‹ Invoice from Appointment
                </div>
                <div style={{fontSize: '0.875rem', color: '#46C5FF'}}>
                  Customer info pre-filled from appointment booking
                </div>
              </div>
            )}

            {!prefillData && (
              <div className="form-group">
                <label>Select Existing Customer (Optional)</label>
                {loadingCustomers ? (
                  <div style={{padding: '0.75rem', color: 'var(--text-muted)'}}>Loading customers...</div>
                ) : (
                  <select
                    onChange={(e) => {
                      const customer = customers.find(c => c.email === e.target.value);
                      if (customer) {
                        selectCustomer(customer);
                      } else {
                        selectCustomer(null);
                      }
                    }}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      border: '2px solid var(--border)',
                      borderRadius: '8px',
                      fontSize: '1rem'
                    }}
                  >
                    <option value="">-- Select Customer or Enter New Below --</option>
                    {customers.map((customer, i) => (
                      <option key={i} value={customer.email}>
                        {customer.name} - {customer.email}
                      </option>
                    ))}
                  </select>
                )}
                <div style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                  Or search by phone number below
                </div>
              </div>
            )}

            {selectedCustomerInfo && (
              <div style={{
                background: 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',
                border: '2px solid #0ea5e9',
                borderRadius: '12px',
                padding: '1rem',
                marginBottom: '1rem'
              }}>
                <div style={{
                  fontSize: '0.9rem',
                  fontWeight: '600',
                  color: '#46C5FF',
                  marginBottom: '0.75rem',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}>
                  ðŸ“Š Customer Account Summary
                </div>
                
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem'}}>
                  <div>
                    <div style={{fontSize: '0.75rem', color: '#64748b', marginBottom: '0.25rem'}}>
                      Current Balance
                    </div>
                    <div style={{
                      fontSize: '1.5rem',
                      fontWeight: 'bold',
                      color: selectedCustomerInfo.balance > 0 ? '#dc2626' : '#2683FB'
                    }}>
                      ${selectedCustomerInfo.balance.toFixed(2)}
                    </div>
                    {selectedCustomerInfo.balance > 0 && (
                      <div style={{fontSize: '0.7rem', color: '#dc2626', fontWeight: '500'}}>
                        OUTSTANDING
                      </div>
                    )}
                  </div>

                  <div>
                    <div style={{fontSize: '0.75rem', color: '#64748b', marginBottom: '0.25rem'}}>
                      Total Paid
                    </div>
                    <div style={{fontSize: '1.5rem', fontWeight: 'bold', color: '#2683FB'}}>
                      ${selectedCustomerInfo.totalPaid.toFixed(2)}
                    </div>
                    <div style={{fontSize: '0.7rem', color: '#64748b'}}>
                      {selectedCustomerInfo.totalInvoices} invoice{selectedCustomerInfo.totalInvoices !== 1 ? 's' : ''}
                    </div>
                  </div>
                </div>

                {selectedCustomerInfo.lastInvoice && (
                  <div style={{
                    marginTop: '0.75rem',
                    paddingTop: '0.75rem',
                    borderTop: '1px solid #bae6fd'
                  }}>
                    <div style={{fontSize: '0.75rem', color: '#64748b', marginBottom: '0.25rem'}}>
                      Last Invoice
                    </div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                      <div>
                        <div style={{fontSize: '0.85rem', fontWeight: '600', color: '#46C5FF'}}>
                          {selectedCustomerInfo.lastInvoice.invoiceNumber}
                        </div>
                        <div style={{fontSize: '0.75rem', color: '#64748b'}}>
                          {selectedCustomerInfo.lastInvoice.createdAt?.toDate().toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                          })}
                        </div>
                      </div>
                      <div style={{textAlign: 'right'}}>
                        <div style={{fontSize: '1rem', fontWeight: 'bold', color: '#46C5FF'}}>
                          ${selectedCustomerInfo.lastInvoice.total?.toFixed(2)}
                        </div>
                        <span style={{
                          fontSize: '0.7rem',
                          padding: '0.125rem 0.5rem',
                          borderRadius: '12px',
                          fontWeight: '600',
                          textTransform: 'uppercase',
                          background: selectedCustomerInfo.lastInvoice.status === 'paid' ? '#dcfce7' : '#fef3c7',
                          color: selectedCustomerInfo.lastInvoice.status === 'paid' ? '#166534' : '#92400e'
                        }}>
                          {selectedCustomerInfo.lastInvoice.status}
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            <div className="form-group">
              <label>Customer Phone {phoneSearching && <span style={{color: 'var(--primary)'}}>ðŸ” Searching...</span>}</label>
              <input 
                type="tel"
                value={customerPhone}
                onChange={(e) => {
                  setCustomerPhone(e.target.value);
                  if (e.target.value.replace(/\D/g, '').length >= 10) {
                    lookupByPhone(e.target.value);
                  }
                }}
                placeholder="555-123-4567 (auto-fills customer info)"
              />
              <div style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                Enter phone to auto-fill customer details
              </div>
            </div>

            <div className="form-group">
              <label>Customer Name *</label>
              <input 
                type="text"
                value={customerName}
                onChange={(e) => setCustomerName(e.target.value)}
                placeholder="John Smith"
              />
            </div>

            <div className="form-group">
              <label>Customer Email *</label>
              <input 
                type="email"
                value={customerEmail}
                onChange={(e) => setCustomerEmail(e.target.value)}
                placeholder="customer@email.com"
              />
            </div>

            <div className="form-group">
              <label>Invoice Items</label>
              {items.map((item, idx) => (
                <div key={idx} style={{marginBottom: '1rem', padding: '1rem', background: '#f8f9fa', borderRadius: '8px'}}>
                  <div style={{display: 'flex', gap: '0.5rem', marginBottom: '0.5rem'}}>
                    <select
                      value={item.description}
                      onChange={(e) => selectService(idx, e.target.value)}
                      style={{
                        flex: 2,
                        padding: '0.75rem',
                        border: '2px solid var(--border)',
                        borderRadius: '8px',
                        fontSize: '1rem',
                        fontFamily: 'inherit'
                      }}
                    >
                      {serviceOptions.map((service, i) => (
                        <option 
                          key={i} 
                          value={service.name}
                          disabled={service.isHeader}
                          style={{
                            fontWeight: service.isHeader ? 'bold' : 'normal',
                            color: service.isHeader ? '#666' : 'inherit'
                          }}
                        >
                          {service.name}
                        </option>
                      ))}
                    </select>
                    {items.length > 1 && (
                      <button 
                        className="btn btn-sm btn-outline"
                        onClick={() => removeItem(idx)}
                        type="button"
                        style={{padding: '0.75rem 1rem'}}
                      >
                        âœ•
                      </button>
                    )}
                  </div>
                  
                  {item.description === 'Custom Service (enter manually)' || 
                   (item.description && !serviceOptions.find(s => s.name === item.description)) ? (
                    <input 
                      type="text"
                      placeholder="Enter custom service description"
                      value={item.description === 'Custom Service (enter manually)' ? '' : item.description}
                      onChange={(e) => updateItem(idx, 'description', e.target.value)}
                      style={{
                        width: '100%',
                        padding: '0.75rem',
                        border: '2px solid var(--border)',
                        borderRadius: '8px',
                        fontSize: '1rem',
                        marginBottom: '0.5rem'
                      }}
                    />
                  ) : null}

                  <input
                    type="text"
                    placeholder="Horse name or comment"
                    value={item.horseName || ''}
                    onChange={(e) => updateItem(idx, 'horseName', e.target.value)}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      border: '2px solid var(--border)',
                      borderRadius: '8px',
                      fontSize: '1rem',
                      marginBottom: '0.5rem'
                    }}
                  />

                  <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                    <label style={{marginBottom: 0, fontSize: '0.9rem', fontWeight: '500'}}>Price:</label>
                    <span style={{fontSize: '1.5rem', fontWeight: 'bold'}}>$</span>
                    <input 
                      type="number"
                      placeholder="0.00"
                      value={item.amount || ''}
                      onChange={(e) => updateItem(idx, 'amount', e.target.value)}
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        border: '2px solid var(--border)',
                        borderRadius: '8px',
                        fontSize: '1rem'
                      }}
                      step="0.01"
                      min="0"
                    />
                  </div>
                </div>
              ))}
              <button className="btn btn-sm btn-outline" onClick={addItem} type="button">
                + Add Another Service
              </button>
            </div>

            <div style={{borderTop: '2px solid var(--border)', paddingTop: '1rem', marginTop: '1rem'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '1.5rem', fontWeight: '800', color: 'var(--primary)'}}>
                <span>Total</span>
                <span>${total.toFixed(2)}</span>
              </div>
            </div>

            <button 
              className="btn btn-primary" 
              style={{width: '100%', marginTop: '1rem'}}
              onClick={generatePaymentLink}
              disabled={loading}
            >
              {loading ? <span className="spinner"></span> : 'âœ“ Create Invoice'}
            </button>

            <p style={{fontSize: '0.875rem', color: 'rgba(234,242,255,0.65)', marginTop: '0.5rem', textAlign: 'center'}}>
              Customer will use "Pay Now" button to pay with Authorize.Net
            </p>
          </div>
        </div>
      );
    }

    function SettingsView({ user, userProfile, setUserProfile, farrierId }) {
  const safeFarrierId = String((farrierId || (userProfile && (userProfile.farrierId || userProfile.farrierID || userProfile.id || userProfile.uid)) || (user && user.uid) || "")).trim();

      const [businessName, setBusinessName] = useState(userProfile?.businessName || '');
      const [firstName, setFirstName] = useState(userProfile?.firstName || '');
      const [lastName, setLastName] = useState(userProfile?.lastName || '');
      const [logoUrl, setLogoUrl] = useState(userProfile?.logoUrl || '');
      const [autoPrintPdf, setAutoPrintPdf] = useState(userProfile?.autoPrintPdf ?? true);
      const [allowManualPayments, setAllowManualPayments] = useState(userProfile?.allowManualPayments ?? true);
      const [smsEnabled, setSmsEnabled] = useState(userProfile?.smsEnabled ?? false);
      const [phone, setPhone] = useState(userProfile?.phone || '');
      const [address, setAddress] = useState(userProfile?.address || '');
      const [city, setCity] = useState(userProfile?.city || '');
      const [state, setState] = useState(userProfile?.state || '');
      const [zip, setZip] = useState(userProfile?.zip || '');
      const [loading, setLoading] = useState(false);
      const [successMessage, setSuccessMessage] = useState('');
      const [error, setError] = useState('');
      
      // Availability settings with defaults
      const defaultAvailability = {
        monday: { enabled: true, start: '09:00', end: '17:00' },
        tuesday: { enabled: true, start: '09:00', end: '17:00' },
        wednesday: { enabled: true, start: '09:00', end: '17:00' },
        thursday: { enabled: true, start: '09:00', end: '17:00' },
        friday: { enabled: true, start: '09:00', end: '17:00' },
        saturday: { enabled: false, start: '09:00', end: '17:00' },
        sunday: { enabled: false, start: '09:00', end: '17:00' }
      };
      
      const [availability, setAvailability] = useState(
        userProfile?.availability || defaultAvailability
      );

      const updateDayAvailability = (day, field, value) => {
        setAvailability({
          ...availability,
          [day]: {
            ...availability[day],
            [field]: value
          }
        });
      };

      const handleSave = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        setSuccessMessage('');

        try {
          if (db) {
            if (!safeFarrierId) {
              throw new Error('Missing farrier id');
            }
            // Use merge-safe set so we never wipe other fields (ex: Google Calendar tokens)
            await ensureFarriTechfile_(safeFarrierId, {
              businessName: businessName,
              firstName: firstName,
              lastName: lastName,
              phone: phone,
              address: address,
              city: city,
              state: state,
              zip: zip,
              logoUrl: logoUrl,
              autoPrintPdf: autoPrintPdf,
              allowManualPayments: allowManualPayments,
              smsEnabled: smsEnabled,
              availability: availability,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Update local state
            setUserProfile(prev => ({
              ...(prev || {}),
              businessName,
              firstName,
              lastName,
              phone,
              address,
              city,
              state,
              zip,
              logoUrl,
              autoPrintPdf,
              allowManualPayments,
              smsEnabled,
              availability
            }));

            setSuccessMessage('Profile updated successfully!');
          }
        } catch (err) {
          console.error('Error updating profile:', err);
          setError('Failed to update profile. Please try again.');
        }

        setLoading(false);
      };

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>
            Account Settings
          </h1>

          {successMessage && <div className="success-message">{successMessage}</div>}
          {error && <div className="error-message">{error}</div>}

          <div className="card">
            <h2>Business Profile</h2>
            <form onSubmit={handleSave}>
              <div className="form-group">
                <label>Business Name *</label>
                <input 
                  type="text"
                  required
                  value={businessName}
                  onChange={(e) => setBusinessName(e.target.value)}
                  placeholder="John's Farrier Services"
                />
              </div>

              <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem'}}>
                <div className="form-group">
                  <label>First Name *</label>
                  <input 
                    type="text"
                    required
                    value={firstName}
                    onChange={(e) => setFirstName(e.target.value)}
                    placeholder="John"
                  />
                </div>
                <div className="form-group">
                  <label>Last Name *</label>
                  <input 
                    type="text"
                    required
                    value={lastName}
                    onChange={(e) => setLastName(e.target.value)}
                    placeholder="Smith"
                  />
                </div>
              </div>

              <div className="form-group">
                <label>Email (Cannot be changed)</label>
                <input 
                  type="email"
                  value={userProfile?.email || user.email}
                  disabled
                  style={{background: '#f5f5f5', cursor: 'not-allowed'}}
                />
              </div>

              <div className="form-group">
                <label>Phone Number *</label>
                <input 
                  type="tel"
                  required
                  value={phone}
                  onChange={(e) => setPhone(e.target.value)}
                  placeholder="(555) 555-5555"
                />
              </div>

              <div className="form-group">
                <label>Business Address *</label>
                <input 
                  type="text"
                  required
                  value={address}
                  onChange={(e) => setAddress(e.target.value)}
                  placeholder="123 Main Street"
                />
              </div>

              <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem'}}>
                <div className="form-group">
                  <label>City *</label>
                  <input 
                    type="text"
                    required
                    value={city}
                    onChange={(e) => setCity(e.target.value)}
                    placeholder="City"
                  />
                </div>

                <div className="form-group">
                  <label>State *</label>
                  <input 
                    type="text"
                    required
                    value={state}
                    onChange={(e) => setState(e.target.value.toUpperCase())}
                    placeholder="VA"
                    maxLength="2"
                    style={{textTransform: 'uppercase'}}
                  />
                </div>

                <div className="form-group">
                  <label>ZIP *</label>
                  <input 
                    type="text"
                    required
                    value={zip}
                    onChange={(e) => setZip(e.target.value)}
                    placeholder="12345"
                    maxLength="5"
                    pattern="[0-9]{5}"
                  />
                </div>
              </div>

              <div style={{marginTop: '1.5rem', padding: '1rem', background: '#f8f9fa', borderRadius: '8px'}}>
                <div style={{fontWeight: '600', marginBottom: '0.75rem'}}>âš™ï¸ Preferences</div>
                <div style={{display:'flex', alignItems:'center', gap:'10px', marginBottom:'0.75rem'}}>
                  <input type="checkbox" id="autoPrintPdfToggle" checked={Boolean(autoPrintPdf)} onChange={(e)=>setAutoPrintPdf(e.target.checked)} style={{width:'18px',height:'18px'}} />
                  <label htmlFor="autoPrintPdfToggle" style={{cursor:'pointer'}}>Auto-open PDF after creating an invoice</label>
                </div>
                <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                  <input type="checkbox" id="manualPayToggle" checked={Boolean(allowManualPayments)} onChange={(e)=>setAllowManualPayments(e.target.checked)} style={{width:'18px',height:'18px'}} />
                  <label htmlFor="manualPayToggle" style={{cursor:'pointer'}}>Allow manual payments (Cash / Check) on invoices</label>
                </div>
              </div>

              <button 
                type="submit" 
                className="btn btn-primary"
                disabled={loading}
                style={{marginTop: '1rem'}}
              >
                {loading ? <span className="spinner"></span> : 'Save Changes'}
              </button>
            </form>
          </div>

          {/* Availability Settings */}
          <div className="card" style={{marginTop: '1.5rem'}}>
            <h2>ðŸ“… Availability Settings</h2>
            <p style={{color: 'var(--text-muted)', marginBottom: '1.5rem'}}>
              Set your working hours. Customers will only see available times when booking.
            </p>

            <form onSubmit={handleSave}>
              {['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].map(day => (
                <div 
                  key={day}
                  style={{
                    display: 'grid',
                    gridTemplateColumns: '120px 1fr 1fr 1fr',
                    gap: '0.75rem',
                    alignItems: 'center',
                    marginBottom: '1rem',
                    padding: '0.75rem',
                    background: availability[day].enabled ? '#f8f9fa' : '#fff',
                    borderRadius: '4px',
                    border: '1px solid #e0e0e0'
                  }}
                >
                  <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem', margin: 0}}>
                    <input
                      type="checkbox"
                      checked={availability[day].enabled}
                      onChange={(e) => updateDayAvailability(day, 'enabled', e.target.checked)}
                      style={{width: '18px', height: '18px'}}
                    />
                    <span style={{fontWeight: '500', textTransform: 'capitalize'}}>
                      {day}
                    </span>
                  </label>

                  {availability[day].enabled && (
                    <>
                      <div>
                        <label style={{fontSize: '0.875rem', color: 'rgba(234,242,255,0.65)', display: 'block', marginBottom: '0.25rem'}}>
                          Start Time
                        </label>
                        <input
                          type="time"
                          value={availability[day].start}
                          onChange={(e) => updateDayAvailability(day, 'start', e.target.value)}
                          required
                          style={{width: '100%'}}
                        />
                      </div>

                      <div>
                        <label style={{fontSize: '0.875rem', color: 'rgba(234,242,255,0.65)', display: 'block', marginBottom: '0.25rem'}}>
                          End Time
                        </label>
                        <input
                          type="time"
                          value={availability[day].end}
                          onChange={(e) => updateDayAvailability(day, 'end', e.target.value)}
                          required
                          style={{width: '100%'}}
                        />
                      </div>

                      <div style={{fontSize: '0.875rem', color: 'rgba(234,242,255,0.65)', textAlign: 'center'}}>
                        {availability[day].start && availability[day].end && (
                          <>
                            {(() => {
                              const start = new Date(`1970-01-01T${availability[day].start}`);
                              const end = new Date(`1970-01-01T${availability[day].end}`);
                              const hours = (end - start) / (1000 * 60 * 60);
                              return `${hours.toFixed(1)} hours`;
                            })()}
                          </>
                        )}
                      </div>
                    </>
                  )}

                  {!availability[day].enabled && (
                    <div style={{gridColumn: '2 / 5', color: '#999', fontStyle: 'italic'}}>
                      Not available
                    </div>
                  )}
                </div>
              ))}

              <button 
                type="submit" 
                className="btn btn-primary"
                disabled={loading}
                style={{marginTop: '1rem'}}
              >
                {loading ? <span className="spinner"></span> : 'Save Availability'}
              </button>
            </form>
          </div>

          {/* SMS & Messaging Settings */}
          <div className="card" style={{marginTop: '1.5rem'}}>
            <h2>ðŸ“± SMS & Messaging</h2>
            <p style={{color: 'var(--text-muted)', marginBottom: '1.5rem'}}>
              Send automated appointment reminders and invoice notifications to your customers via text message.
              {userProfile?.subscriptionPlan === 'basic' && <><br/><span style={{color:'#d97706', fontWeight:'500'}}>SMS is a $9.95/month add-on for Basic plan subscribers.</span></>}
            </p>

            <div style={{display:'flex', alignItems:'center', gap:'10px', marginBottom:'1rem'}}>
              <input
                type="checkbox"
                id="smsToggle"
                checked={Boolean(smsEnabled)}
                onChange={(e) => setSmsEnabled(e.target.checked)}
                style={{width:'18px', height:'18px'}}
              />
              <label htmlFor="smsToggle" style={{cursor:'pointer', fontWeight:'500'}}>
                Enable SMS notifications for my customers
              </label>
            </div>

            {smsEnabled && (
              <div style={{background:'#f0fdf4', border:'1px solid #bbf7d0', borderRadius:'8px', padding:'1rem', marginBottom:'1rem'}}>
                <div style={{fontWeight:'600', marginBottom:'0.5rem', color:'#166534'}}>âœ… SMS Active</div>
                {userProfile?.twilioPhoneNumber ? (
                  <div style={{fontSize:'0.9rem', color:'#166534'}}>
                    Your dedicated number: <strong>{userProfile.twilioPhoneNumber}</strong>
                  </div>
                ) : (
                  <div>
                    <div style={{fontSize:'0.9rem', color:'#166534', marginBottom:'0.75rem'}}>
                      No phone number assigned yet. Click below to provision your dedicated SMS number.
                    </div>
                    <button
                      className="btn btn-sm"
                      style={{background:'#059669', color:'white'}}
                      onClick={async () => {
                        try {
                          const res = await fetch('/api/provision-twilio-number', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ farrierId: safeFarrierId })
                          });
                          const data = await res.json();
                          if (data.success) {
                            await ensureFarriTechfile_(safeFarrierId, { twilioPhoneNumber: data.phoneNumber });
                            setUserProfile(prev => ({ ...prev, twilioPhoneNumber: data.phoneNumber }));
                            alert(`âœ… Your SMS number has been provisioned: ${data.phoneNumber}`);
                          } else {
                            alert('âŒ Failed to provision number: ' + data.error);
                          }
                        } catch(e) {
                          alert('âŒ Error provisioning number. Please try again.');
                        }
                      }}
                    >
                      ðŸ“ž Get My SMS Number
                    </button>
                  </div>
                )}
              </div>
            )}

            {smsEnabled && (
              <div style={{fontSize:'0.85rem', color:'var(--text-muted)', marginTop:'0.5rem'}}>
                <strong>What gets sent automatically:</strong>
                <ul style={{marginTop:'0.5rem', paddingLeft:'1.25rem'}}>
                  <li>Appointment confirmation when you confirm an appointment</li>
                  <li>Invoice notification with payment link when you create an invoice</li>
                  <li>Reminders via the ðŸ“± Send Reminder button on appointments</li>
                </ul>
                Customers can reply <strong>CONFIRM</strong> to confirm appointments or <strong>STOP</strong> to opt out.
              </div>
            )}

            <div style={{marginTop:'1rem'}}>
              <button className="btn btn-primary" onClick={async () => {
                try {
                  await ensureFarriTechfile_(safeFarrierId, { smsEnabled });
                  setUserProfile(prev => ({ ...prev, smsEnabled }));
                  alert(smsEnabled ? 'âœ… SMS enabled!' : 'âœ… SMS disabled.');
                } catch(e) { alert('Failed to save SMS settings.'); }
              }}>
                Save SMS Settings
              </button>
            </div>
          </div>

          <div className="card" style={{marginTop: '1.5rem'}}>
            <h2>Account Information</h2>
            <p style={{color: 'var(--text-muted)', marginBottom: '1rem'}}>
              <strong>Account Created:</strong> {userProfile?.createdAt?.toDate().toLocaleDateString() || 'N/A'}
            </p>
            <div style={{marginBottom: '1rem'}}>
              <strong>Booking URL:</strong><br/>
              <code style={{background: '#f5f5f5', padding: '0.5rem', borderRadius: '4px', display: 'inline-block', marginTop: '0.5rem', wordBreak: 'break-all'}}>
                {`${window.location.origin}?farrier=${safeFarrierId}`}
              </code>
              <div style={{marginTop: '0.5rem'}}>
                <button 
                  className="btn btn-sm"
                  onClick={() => {
                    const url = `${window.location.origin}?farrier=${safeFarrierId}`;
                    navigator.clipboard.writeText(url);
                    alert('Booking URL copied to clipboard!');
                  }}
                  style={{marginRight: '0.5rem'}}
                >
                  ðŸ“‹ Copy URL
                </button>
                <button 
                  className="btn btn-sm"
                  onClick={async () => {
                    try {
                      if (db) {
                        // Use merge-safe set so we never wipe other fields (ex: Google Calendar tokens)
            await ensureFarriTechfile_(safeFarrierId, { bookingUrl: `${window.location.origin}/?farrier=${safeFarrierId}` });
setUserProfile({
                          ...userProfile,
                          bookingUrl: `${window.location.origin}?farrier=${safeFarrierId}`
                        });
                        alert('Booking URL updated successfully!');
                      }
                    } catch (error) {
                      console.error('Error updating URL:', error);
                      alert('Failed to update URL');
                    }
                  }}
                >
                  ðŸ”„ Update URL
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
