<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farrier Pro - Multi-User Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <!-- Authorize.Net integration via backend functions -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Google API for Calendar -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2D5016;
      --primary-light: #4A7C2A;
      --secondary: #D4A574;
      --accent: #E8773D;
      --bg: #F5F1E8;
      --surface: #FFFFFF;
      --text: #1A1A1A;
      --text-muted: #666666;
      --success: #4A7C2A;
      --warning: #E8773D;
      --error: #C53030;
      --border: #E0D8C8;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      max-width: 100%;
      min-height: 100vh;
    }

    /* Header */
    .app-header {
      background: var(--primary);
      color: white;
      padding: 1rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo {
      font-family: 'Space Mono', monospace;
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-icon {
      font-size: 2rem;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .user-info {
      font-size: 0.875rem;
    }

    /* Main Content */
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* Auth Forms */
    .auth-container {
      max-width: 450px;
      margin: 3rem auto;
    }

    .auth-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      border: 2px solid var(--border);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .auth-header h1 {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .auth-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: var(--bg);
      padding: 0.25rem;
      border-radius: 8px;
    }

    .auth-tab {
      flex: 1;
      padding: 0.75rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .auth-tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
      border: 2px solid var(--border);
    }

    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--primary);
    }

    .form-group {
      margin-bottom: 1.25rem;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      padding: 0.875rem 2rem;
      border: none;
      border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--secondary);
      color: var(--text);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-google {
      background: white;
      color: #444;
      border: 2px solid var(--border);
    }

    .btn-google:hover {
      background: #f8f9fa;
    }

    /* QR Code Display */
    .qr-section {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      color: white;
      margin-bottom: 2rem;
    }

    .qr-code-container {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      display: inline-block;
      margin: 1.5rem 0;
    }

    .qr-code-container canvas {
      display: block;
    }

    .booking-link {
      background: rgba(255,255,255,0.2);
      padding: 1rem;
      border-radius: 8px;
      word-break: break-all;
      margin-top: 1rem;
      font-family: 'Space Mono', monospace;
      font-size: 0.875rem;
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--surface);
      padding: 1.5rem;
      border-radius: 12px;
      border: 2px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
    }

    .stat-change {
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .stat-change.positive {
      color: var(--success);
    }

    /* Calendar */
    .calendar {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      border: 2px solid var(--border);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .calendar-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .calendar-nav {
      display: flex;
      gap: 0.5rem;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .calendar-day.header {
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      cursor: default;
    }

    .calendar-day:not(.header):hover {
      background: var(--border);
    }

    .calendar-day.today {
      background: var(--primary);
      color: white;
    }

    .calendar-day.has-appointment {
      background: var(--accent);
      color: white;
    }

    /* Appointments List */
    .appointments-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .appointment-item {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s;
    }

    .appointment-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .appointment-info {
      flex: 1;
    }

    .appointment-customer {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
      color: var(--primary);
    }

    .appointment-details {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .appointment-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-success {
      background: #E6F4EA;
      color: var(--success);
    }

    .badge-warning {
      background: #FEF3E2;
      color: var(--warning);
    }

    .badge-pending {
      background: #E8EAF6;
      color: #5E35B1;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .success-message {
      background: #E6F4EA;
      border: 2px solid var(--success);
      color: var(--success);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 600;
      text-align: center;
    }

    .error-message {
      background: #FEE;
      border: 2px solid var(--error);
      color: var(--error);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 600;
      text-align: center;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
    }

    .tab {
      padding: 0.75rem 1.5rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* Time Slots */
    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .time-slot {
      padding: 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      font-weight: 600;
    }

    .time-slot:hover {
      border-color: var(--primary);
    }

    .time-slot.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .time-slot.booked {
      opacity: 0.4;
      cursor: not-allowed;
      background: var(--border);
    }

    /* Google Calendar Status */
    .calendar-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .status-indicator.connected {
      background: var(--success);
    }

    .status-indicator.disconnected {
      background: var(--error);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .appointment-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .appointment-actions {
        width: 100%;
      }
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hero {
      text-align: center;
      margin-bottom: 3rem;
    }

    .hero h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 1rem;
      color: var(--primary);
    }

    .hero p {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAQ1LaWG9lE9j5h6X0T0YQKa_j04vJZHE4",
      authDomain: "farrier-pro.firebaseapp.com",
      projectId: "farrier-pro",
      storageBucket: "farrier-pro.firebasestorage.app",
      messagingSenderId: "1010833069179",
      appId: "1:1010833069179:web:844b6055462b55640b3ede",
      measurementId: "G-H14XM830EY"
    };

    // Initialize Firebase
    let app, auth, db;
    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
    } catch (error) {
      console.log("Firebase not configured yet - using demo mode");
    }

    // Google Calendar API Configuration
    const GOOGLE_CLIENT_ID = "458461432563-pkncm66du9pipuihdrbrhfrsuggo7loh.apps.googleusercontent.com";
    const CALENDAR_SCOPES = "https://www.googleapis.com/auth/calendar";

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [userProfile, setUserProfile] = useState(null);

      useEffect(() => {
        // Check authentication state
        if (auth) {
          const unsubscribe = auth.onAuthStateChanged(async (user) => {
            if (user) {
              setUser(user);
              // Load user profile from Firestore
              const profileDoc = await db.collection('farriers').doc(user.uid).get();
              if (profileDoc.exists) {
                setUserProfile(profileDoc.data());
              }
            } else {
              setUser(null);
              setUserProfile(null);
            }
            setLoading(false);
          });
          return () => unsubscribe();
        } else {
          setLoading(false);
        }
      }, []);

      // Check if URL is for customer booking
      const urlParams = new URLSearchParams(window.location.search);
      const farrierId = urlParams.get('farrier');

      if (loading) {
        return (
          <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}>
            <div className="spinner"></div>
          </div>
        );
      }

      // Customer booking view
      if (farrierId) {
        return <CustomerBookingView farrierId={farrierId} />;
      }

      // Authentication view
      if (!user) {
        return <AuthView />;
      }

      // Farrier dashboard
      return <FarrierDashboard user={user} userProfile={userProfile} setUserProfile={setUserProfile} />;
    }

    function AuthView() {
      const [mode, setMode] = useState('login'); // 'login' or 'signup'
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [businessName, setBusinessName] = useState('');
      const [phone, setPhone] = useState('');
      const [address, setAddress] = useState('');
      const [city, setCity] = useState('');
      const [state, setState] = useState('');
      const [zip, setZip] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [successMessage, setSuccessMessage] = useState('');

      const handleForgotPassword = async () => {
        if (!email) {
          setError('Please enter your email address first');
          return;
        }
        
        setError('');
        setLoading(true);
        
        try {
          if (!auth) {
            setError('Firebase not configured. Please add your Firebase credentials.');
            setLoading(false);
            return;
          }
          await auth.sendPasswordResetEmail(email);
          setSuccessMessage('Password reset email sent! Check your inbox.');
          setError('');
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        
        try {
          if (!auth) {
            setError('Firebase not configured. Please add your Firebase credentials.');
            setLoading(false);
            return;
          }
          await auth.signInWithEmailAndPassword(email, password);
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      const handleSignup = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        
        try {
          if (!auth) {
            setError('Firebase not configured. Please add your Firebase credentials.');
            setLoading(false);
            return;
          }

          // Create user account
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;
          
          // Send welcome/verification email
          await user.sendEmailVerification();
          
          // Create farrier profile in Firestore
          await db.collection('farriers').doc(user.uid).set({
            businessName: businessName,
            email: email,
            phone: phone,
            address: address,
            city: city,
            state: state,
            zip: zip,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            googleCalendarConnected: false,
            bookingUrl: window.location.origin + '?farrier=' + user.uid
          });
          
          alert('Welcome! Please check your email to verify your account.');

        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      return (
        <div className="app-container">
          <header className="app-header">
            <div className="header-content">
              <div className="logo">
                <span className="logo-icon">üê¥</span>
                <span>Farrier Pro</span>
              </div>
            </div>
          </header>

          <div className="auth-container">
            <div className="auth-card">
              <div className="auth-header">
                <h1>Welcome Back</h1>
                <p>Manage your farrier business with ease</p>
              </div>

              <div className="auth-tabs">
                <button 
                  className={`auth-tab ${mode === 'login' ? 'active' : ''}`}
                  onClick={() => setMode('login')}
                >
                  Login
                </button>
                <button 
                  className={`auth-tab ${mode === 'signup' ? 'active' : ''}`}
                  onClick={() => setMode('signup')}
                >
                  Sign Up
                </button>
              </div>

              {error && <div className="error-message">{error}</div>}
              {successMessage && <div className="success-message">{successMessage}</div>}

              <form onSubmit={mode === 'login' ? handleLogin : handleSignup}>
                {mode === 'signup' && (
                  <>
                    <div className="form-group">
                      <label>Business Name *</label>
                      <input 
                        type="text"
                        required
                        value={businessName}
                        onChange={(e) => setBusinessName(e.target.value)}
                        placeholder="John's Farrier Services"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Phone Number *</label>
                      <input 
                        type="tel"
                        required
                        value={phone}
                        onChange={(e) => setPhone(e.target.value)}
                        placeholder="(555) 555-5555"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Business Address *</label>
                      <input 
                        type="text"
                        required
                        value={address}
                        onChange={(e) => setAddress(e.target.value)}
                        placeholder="123 Main Street"
                      />
                    </div>
                    
                    <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem'}}>
                      <div className="form-group">
                        <label>City *</label>
                        <input 
                          type="text"
                          required
                          value={city}
                          onChange={(e) => setCity(e.target.value)}
                          placeholder="City"
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>State *</label>
                        <input 
                          type="text"
                          required
                          value={state}
                          onChange={(e) => setState(e.target.value.toUpperCase())}
                          placeholder="VA"
                          maxLength="2"
                          style={{textTransform: 'uppercase'}}
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>ZIP *</label>
                        <input 
                          type="text"
                          required
                          value={zip}
                          onChange={(e) => setZip(e.target.value)}
                          placeholder="12345"
                          maxLength="5"
                          pattern="[0-9]{5}"
                        />
                      </div>
                    </div>
                  </>
                )}

                <div className="form-group">
                  <label>Email</label>
                  <input 
                    type="email"
                    required
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="your@email.com"
                  />
                </div>

                <div className="form-group">
                  <label>Password</label>
                  <input 
                    type="password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    minLength={6}
                  />
                </div>

                <button 
                  type="submit" 
                  className="btn btn-primary" 
                  style={{width: '100%'}}
                  disabled={loading}
                >
                  {loading ? <span className="spinner"></span> : (mode === 'login' ? 'Login' : 'Create Account')}
                </button>
                
                {mode === 'login' && (
                  <div style={{textAlign: 'center', marginTop: '1rem'}}>
                    <button 
                      type="button"
                      onClick={handleForgotPassword}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: 'var(--primary)',
                        textDecoration: 'underline',
                        cursor: 'pointer',
                        fontSize: '0.875rem'
                      }}
                    >
                      Forgot password?
                    </button>
                  </div>
                )}
              </form>
            </div>
          </div>
        </div>
      );
    }

    function FarrierDashboard({ user, userProfile, setUserProfile }) {
      const [tab, setTab] = useState('qrcode');
      const [showQRModal, setShowQRModal] = useState(false);

      const handleLogout = async () => {
        if (auth) {
          await auth.signOut();
        }
      };

      const connectGoogleCalendar = async () => {
        try {
          const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: CALENDAR_SCOPES,
            callback: async (response) => {
              if (response.access_token) {
                // Save token to Firestore
                if (db) {
                  await db.collection('farriers').doc(user.uid).update({
                    googleCalendarConnected: true,
                    googleAccessToken: response.access_token
                  });
                  setUserProfile({...userProfile, googleCalendarConnected: true});
                  alert('Google Calendar connected successfully!');
                }
              }
            },
          });
          tokenClient.requestAccessToken();
        } catch (error) {
          console.error('Error connecting Google Calendar:', error);
          alert('Please configure Google Calendar API credentials');
        }
      };

      const tabs = [
        { id: 'qrcode', label: 'My QR Code', icon: 'üì±' },
        { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
        { id: 'calendar', label: 'Calendar', icon: 'üìÖ' },
        { id: 'appointments', label: 'Appointments', icon: 'üìã' },
        { id: 'invoices', label: 'Invoices', icon: 'üí∞' },
        { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' }
      ];

      return (
        <div className="app-container">
          <header className="app-header">
            <div className="header-content">
              <div className="logo">
                <span className="logo-icon">üê¥</span>
                <span>Farrier Pro</span>
              </div>
              <div className="header-actions">
                <div className="user-info">
                  {userProfile?.businessName || user.email}
                </div>
                <button 
                  className="btn btn-sm" 
                  onClick={handleLogout}
                  style={{background: 'white', color: 'var(--primary)', fontWeight: '600'}}
                >
                  üö™ Logout
                </button>
              </div>
            </div>
          </header>

          <main className="main-content">
            <div className="tabs">
              {tabs.map(t => (
                <button 
                  key={t.id}
                  className={`tab ${tab === t.id ? 'active' : ''}`}
                  onClick={() => setTab(t.id)}
                >
                  {t.icon} {t.label}
                </button>
              ))}
            </div>

            {tab === 'qrcode' && (
              <QRCodeView 
                user={user} 
                userProfile={userProfile}
                connectGoogleCalendar={connectGoogleCalendar}
              />
            )}
            {tab === 'dashboard' && <DashboardView userId={user.uid} />}
            {tab === 'calendar' && <CalendarView userId={user.uid} />}
            {tab === 'appointments' && <AppointmentsView userId={user.uid} />}
            {tab === 'invoices' && <InvoicesView userId={user.uid} />}
            {tab === 'settings' && <SettingsView user={user} userProfile={userProfile} setUserProfile={setUserProfile} />}
          </main>
        </div>
      );
    }

    function QRCodeView({ user, userProfile, connectGoogleCalendar }) {
      const bookingUrl = window.location.origin + window.location.pathname + '?farrier=' + user.uid;
      
      // Use Google Charts API for QR code as backup
      const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(bookingUrl)}&color=2D5016&bgcolor=FFFFFF`;

      const downloadQR = () => {
        const link = document.createElement('a');
        link.download = 'farrier-booking-qr.png';
        link.href = qrImageUrl;
        link.click();
      };

      const copyLink = () => {
        navigator.clipboard.writeText(bookingUrl);
        alert('Booking link copied to clipboard!');
      };

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>
            Your Personal QR Code & Booking Link
          </h1>

          {/* Google Calendar Status */}
          <div className="calendar-status">
            <div className={`status-indicator ${userProfile?.googleCalendarConnected ? 'connected' : 'disconnected'}`}></div>
            <span>
              Google Calendar: {userProfile?.googleCalendarConnected ? 'Connected ‚úì' : 'Not Connected'}
            </span>
            {!userProfile?.googleCalendarConnected && (
              <button 
                className="btn btn-sm btn-google" 
                onClick={connectGoogleCalendar}
                style={{marginLeft: 'auto'}}
              >
                Connect Google Calendar
              </button>
            )}
          </div>

          <div className="qr-section">
            <h2 style={{fontSize: '1.75rem', marginBottom: '1rem'}}>
              üöó Put This QR Code on Your Vehicle
            </h2>
            <p style={{opacity: 0.9, marginBottom: '1rem'}}>
              Customers can scan this code to book appointments instantly
            </p>

            <div className="qr-code-container">
              <img src={qrImageUrl} alt="QR Code" style={{display: 'block', maxWidth: '100%'}} />
            </div>

            <div style={{display: 'flex', gap: '1rem', justifyContent: 'center', flexWrap: 'wrap'}}>
              <button className="btn btn-success" onClick={downloadQR}>
                üì• Download QR Code
              </button>
              <button className="btn btn-secondary" onClick={copyLink}>
                üìã Copy Booking Link
              </button>
            </div>

            <div className="booking-link">
              {bookingUrl}
            </div>
          </div>

          <div className="card">
            <h2>How to Use Your QR Code</h2>
            <ol style={{paddingLeft: '1.5rem', lineHeight: '2'}}>
              <li><strong>Download</strong> the QR code image above</li>
              <li><strong>Print</strong> it on a sticker or magnetic sign</li>
              <li><strong>Place</strong> it on your vehicle, business cards, or flyers</li>
              <li><strong>Customers scan</strong> with their phone camera</li>
              <li><strong>They book</strong> appointments directly!</li>
            </ol>
            <p style={{marginTop: '1rem', color: 'var(--text-muted)'}}>
              üí° Tip: Print multiple copies for your truck, trailer, and business cards. The more visible, the more bookings!
            </p>
          </div>
        </div>
      );
    }

    function CustomerBookingView({ farrierId }) {
      const [step, setStep] = useState('landing');
      const [farrierInfo, setFarrierInfo] = useState(null);
      const [loading, setLoading] = useState(true);
      const [formData, setFormData] = useState({
        name: '',
        phone: '',
        email: '',
        services: [], // Multiple services
        numberOfHorses: '',
        address: '',
        city: '',
        state: '',
        zip: '',
        comments: '',
        date: '',
        time: ''
      });

      useEffect(() => {
        loadFarrierInfo();
      }, []);

      const loadFarrierInfo = async () => {
        try {
          if (db) {
            const doc = await db.collection('farriers').doc(farrierId).get();
            if (doc.exists) {
              setFarrierInfo(doc.data());
            }
          } else {
            // Demo mode
            setFarrierInfo({
              businessName: "Demo Farrier Services",
              email: "demo@farrier.com"
            });
          }
        } catch (error) {
          console.error('Error loading farrier info:', error);
        }
        setLoading(false);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        
        try {
          if (db) {
            // Save appointment request to Firestore
            await db.collection('appointments').add({
              farrierId: farrierId,
              customerName: formData.name,
              phone: formData.phone,
              email: formData.email,
              services: formData.services,
              numberOfHorses: formData.numberOfHorses,
              address: formData.address,
              city: formData.city,
              state: formData.state,
              zip: formData.zip,
              comments: formData.comments,
              requestedDate: formData.date,
              requestedTime: formData.time,
              status: 'pending',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // If Google Calendar is connected, create event
            // (This would be done server-side in production)
          }
          
          setStep('success');
        } catch (error) {
          console.error('Error submitting booking:', error);
          alert('Error submitting booking. Please try again.');
        }
      };

      const services = [
        'Routine Trim',
        'Shoeing (All 4)',
        'Shoeing (Front Only)',
        'Corrective Shoeing',
        'Hoof Care Consultation'
      ];

      const availableSlots = ['09:00', '11:00', '13:00', '15:00'];

      if (loading) {
        return (
          <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}>
            <div className="spinner"></div>
          </div>
        );
      }

      if (!farrierInfo) {
        return (
          <div className="app-container">
            <div className="main-content">
              <div className="error-message">
                Farrier not found. Please check your QR code or booking link.
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="app-container">
          <header className="app-header">
            <div className="header-content">
              <div className="logo">
                <span className="logo-icon">üê¥</span>
                <span>{farrierInfo.businessName}</span>
              </div>
            </div>
          </header>

          <main className="main-content">
            {step === 'success' ? (
              <div style={{textAlign: 'center', padding: '2rem'}}>
                <div className="success-message">
                  ‚úì Appointment Request Sent Successfully!
                </div>
                <div className="card">
                  <h2>What's Next?</h2>
                  <p style={{marginBottom: '1rem'}}>
                    Your appointment request has been sent. You'll receive an SMS confirmation once it's approved.
                  </p>
                  <div style={{marginBottom: '1rem', color: 'var(--text-muted)', textAlign: 'left'}}>
                    <strong>Booking Details:</strong><br/>
                    {formData.services.length > 0 && (
                      <>Services: {formData.services.join(', ')}<br/></>
                    )}
                    {formData.numberOfHorses && (
                      <>Number of Horses: {formData.numberOfHorses}<br/></>
                    )}
                    Date: {formData.date} at {formData.time}<br/>
                    {formData.address && (
                      <>
                        Location: {formData.address}
                        {formData.city && `, ${formData.city}`}
                        {formData.state && `, ${formData.state}`}
                        {formData.zip && ` ${formData.zip}`}
                        <br/>
                      </>
                    )}
                  </div>
                  <button className="btn btn-primary" onClick={() => {
                    setStep('landing');
                    setFormData({
                      name: '',
                      phone: '',
                      email: '',
                      services: [],
                      numberOfHorses: '',
                      address: '',
                      city: '',
                      state: '',
                      zip: '',
                      comments: '',
                      date: '',
                      time: ''
                    });
                  }}>
                    Book Another Appointment
                  </button>
                </div>
              </div>
            ) : (
              <div style={{textAlign: 'center'}}>
                <div className="hero">
                  <h1>üê¥ {farrierInfo.businessName}</h1>
                  <p>Professional hoof care for your horses. Book your appointment below.</p>
                </div>

                <div className="card" style={{textAlign: 'left', maxWidth: '600px', margin: '0 auto'}}>
                  <h2>Book Your Appointment</h2>
                  <form onSubmit={handleSubmit}>
                    <div className="form-group">
                      <label>Name *</label>
                      <input 
                        type="text" 
                        required 
                        value={formData.name}
                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                        placeholder="Your name"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Phone Number *</label>
                      <input 
                        type="tel" 
                        required 
                        value={formData.phone}
                        onChange={(e) => setFormData({...formData, phone: e.target.value})}
                        placeholder="(555) 555-5555"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Email</label>
                      <input 
                        type="email" 
                        value={formData.email}
                        onChange={(e) => setFormData({...formData, email: e.target.value})}
                        placeholder="your@email.com"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Services Needed</label>
                      <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                        {services.map(service => (
                          <label key={service} style={{display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer'}}>
                            <input 
                              type="checkbox"
                              checked={formData.services.includes(service)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setFormData({...formData, services: [...formData.services, service]});
                                } else {
                                  setFormData({...formData, services: formData.services.filter(s => s !== service)});
                                }
                              }}
                              style={{width: 'auto', margin: 0}}
                            />
                            <span style={{fontWeight: 'normal'}}>{service}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                    
                    <div className="form-group">
                      <label>Number of Horses</label>
                      <input 
                        type="number" 
                        value={formData.numberOfHorses}
                        onChange={(e) => setFormData({...formData, numberOfHorses: e.target.value})}
                        placeholder="1"
                        min="1"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Address</label>
                      <input 
                        type="text" 
                        value={formData.address}
                        onChange={(e) => setFormData({...formData, address: e.target.value})}
                        placeholder="123 Main Street"
                      />
                    </div>
                    
                    <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem'}}>
                      <div className="form-group">
                        <label>City</label>
                        <input 
                          type="text" 
                          value={formData.city}
                          onChange={(e) => setFormData({...formData, city: e.target.value})}
                          placeholder="City"
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>State</label>
                        <input 
                          type="text" 
                          value={formData.state}
                          onChange={(e) => setFormData({...formData, state: e.target.value})}
                          placeholder="VA"
                          maxLength="2"
                          style={{textTransform: 'uppercase'}}
                        />
                      </div>
                      
                      <div className="form-group">
                        <label>ZIP</label>
                        <input 
                          type="text" 
                          value={formData.zip}
                          onChange={(e) => setFormData({...formData, zip: e.target.value})}
                          placeholder="12345"
                          maxLength="5"
                        />
                      </div>
                    </div>
                    
                    <div className="form-group">
                      <label>Comments or Special Requests</label>
                      <textarea 
                        value={formData.comments}
                        onChange={(e) => setFormData({...formData, comments: e.target.value})}
                        placeholder="Any special notes, concerns, or requests..."
                        rows="4"
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Preferred Date *</label>
                      <input 
                        type="date" 
                        required 
                        value={formData.date}
                        onChange={(e) => setFormData({...formData, date: e.target.value})}
                        min={new Date().toISOString().split('T')[0]}
                      />
                    </div>
                    
                    <div className="form-group">
                      <label>Available Time Slots *</label>
                      <div className="time-slots">
                        {availableSlots.map(slot => (
                          <div 
                            key={slot}
                            className={`time-slot ${formData.time === slot ? 'selected' : ''}`}
                            onClick={() => setFormData({...formData, time: slot})}
                          >
                            {slot}
                          </div>
                        ))}
                      </div>
                    </div>
                    
                    <button 
                      type="submit" 
                      className="btn btn-success" 
                      style={{width: '100%', marginTop: '1rem'}} 
                      disabled={!formData.time}
                    >
                      Request Appointment
                    </button>
                  </form>
                </div>
              </div>
            )}
          </main>
        </div>
      );
    }

    function DashboardView({ userId }) {
      const kpis = [
        { label: 'Appointments This Month', value: '24', change: '+12%', positive: true },
        { label: 'Total Revenue', value: '$4,800', change: '+18%', positive: true },
        { label: 'Outstanding Invoices', value: '$650', change: '-5%', positive: true },
        { label: 'This Week', value: '6', change: 'Upcoming', positive: true }
      ];

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Dashboard Overview</h1>
          
          <div className="dashboard-grid">
            {kpis.map((kpi, idx) => (
              <div key={idx} className="stat-card">
                <div className="stat-label">{kpi.label}</div>
                <div className="stat-value">{kpi.value}</div>
                <div className={`stat-change ${kpi.positive ? 'positive' : ''}`}>
                  {kpi.change}
                </div>
              </div>
            ))}
          </div>

          <div className="card">
            <h2>Recent Activity</h2>
            <p style={{color: 'var(--text-muted)'}}>
              Your appointments and bookings will appear here once customers start booking through your QR code!
            </p>
          </div>
        </div>
      );
    }

    function CalendarView({ userId }) {
      const [currentDate, setCurrentDate] = useState(new Date());
      
      const daysInMonth = new Date(
        currentDate.getFullYear(),
        currentDate.getMonth() + 1,
        0
      ).getDate();

      const firstDay = new Date(
        currentDate.getFullYear(),
        currentDate.getMonth(),
        1
      ).getDay();

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

      const days = [];
      for (let i = 0; i < firstDay; i++) {
        days.push(<div key={`empty-${i}`} className="calendar-day"></div>);
      }
      for (let i = 1; i <= daysInMonth; i++) {
        const isToday = i === new Date().getDate() && 
                        currentDate.getMonth() === new Date().getMonth();
        days.push(
          <div 
            key={i} 
            className={`calendar-day ${isToday ? 'today' : ''}`}
          >
            {i}
          </div>
        );
      }

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Calendar</h1>
          
          <div className="calendar">
            <div className="calendar-header">
              <h2 className="calendar-title">
                {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
              </h2>
              <div className="calendar-nav">
                <button className="btn btn-sm btn-outline" onClick={() => {
                  const newDate = new Date(currentDate);
                  newDate.setMonth(newDate.getMonth() - 1);
                  setCurrentDate(newDate);
                }}>
                  ‚Üê
                </button>
                <button className="btn btn-sm btn-outline" onClick={() => {
                  const newDate = new Date(currentDate);
                  newDate.setMonth(newDate.getMonth() + 1);
                  setCurrentDate(newDate);
                }}>
                  ‚Üí
                </button>
              </div>
            </div>

            <div className="calendar-grid">
              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                <div key={day} className="calendar-day header">{day}</div>
              ))}
              {days}
            </div>
          </div>

          <div className="card" style={{marginTop: '1.5rem'}}>
            <h2>Synced with Google Calendar</h2>
            <p style={{color: 'var(--text-muted)'}}>
              All appointments automatically sync to your Google Calendar. Updates made here or in Google Calendar will sync both ways.
            </p>
          </div>
        </div>
      );
    }

    function AppointmentsView({ userId }) {
      const [appointments, setAppointments] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        loadAppointments();
      }, []);

      const loadAppointments = async () => {
        if (db) {
          try {
            const snapshot = await db.collection('appointments')
              .where('farrierId', '==', userId)
              .get();
            
            const appointmentData = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            
            // Sort in JavaScript instead of Firestore
            appointmentData.sort((a, b) => {
              const dateA = new Date(a.requestedDate);
              const dateB = new Date(b.requestedDate);
              return dateB - dateA; // Newest first
            });
            
            setAppointments(appointmentData);
            console.log('Loaded appointments:', appointmentData.length);
          } catch (error) {
            console.error('Error loading appointments:', error);
            alert('Error loading appointments: ' + error.message);
          }
        }
        setLoading(false);
      };

      const updateStatus = async (appointmentId, newStatus) => {
        if (db) {
          await db.collection('appointments').doc(appointmentId).update({
            status: newStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          loadAppointments();
        }
      };

      const sendReminder = (appointment) => {
        const message = `Hi ${appointment.customerName}! Reminder: Your farrier appointment is on ${appointment.requestedDate} at ${appointment.requestedTime}. ${appointment.address ? 'Location: ' + appointment.address : ''}`;
        alert(`SMS would be sent to ${appointment.phone}:\n\n${message}`);
      };

      if (loading) {
        return (
          <div style={{display: 'flex', justifyContent: 'center', padding: '3rem'}}>
            <div className="spinner"></div>
          </div>
        );
      }

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Appointments</h1>
          
          {appointments.length === 0 ? (
            <div className="card">
              <h2>No Appointments Yet</h2>
              <p style={{color: 'var(--text-muted)'}}>
                Appointments booked through your QR code will appear here. Share your QR code to start receiving bookings!
              </p>
            </div>
          ) : (
            <div className="card">
              <h2>Your Appointments ({appointments.length})</h2>
              <div className="appointments-list">
                {appointments.map(apt => (
                  <div key={apt.id} className="appointment-item">
                    <div className="appointment-info">
                      <div className="appointment-customer">{apt.customerName}</div>
                      <div className="appointment-details">
                        üìû {apt.phone} {apt.email && `‚Ä¢ ‚úâÔ∏è ${apt.email}`}<br/>
                        üìÖ {apt.requestedDate} at {apt.requestedTime}<br/>
                        {apt.services && apt.services.length > 0 && (
                          <>üîß Services: {apt.services.join(', ')}<br/></>
                        )}
                        {apt.numberOfHorses && (
                          <>üê¥ Horses: {apt.numberOfHorses}<br/></>
                        )}
                        {apt.address && (
                          <>üìç {apt.address}, {apt.city}, {apt.state} {apt.zip}<br/></>
                        )}
                        {apt.comments && (
                          <>üí¨ Notes: {apt.comments}<br/></>
                        )}
                        <small style={{color: 'var(--text-muted)'}}>
                          Requested: {apt.createdAt?.toDate().toLocaleDateString()}
                        </small>
                      </div>
                    </div>
                    <div className="appointment-actions">
                      <span className={`badge badge-${apt.status === 'confirmed' ? 'success' : apt.status === 'pending' ? 'warning' : 'pending'}`}>
                        {apt.status || 'pending'}
                      </span>
                      {apt.status !== 'confirmed' && (
                        <button 
                          className="btn btn-sm btn-success"
                          onClick={() => updateStatus(apt.id, 'confirmed')}
                        >
                          ‚úì Confirm
                        </button>
                      )}
                      <button 
                        className="btn btn-sm btn-warning"
                        onClick={() => sendReminder(apt)}
                      >
                        üì± Send Reminder
                      </button>
                      {apt.status !== 'cancelled' && (
                        <button 
                          className="btn btn-sm btn-outline"
                          onClick={() => updateStatus(apt.id, 'cancelled')}
                        >
                          ‚úï Cancel
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    function InvoicesView({ userId }) {
      const [invoices, setInvoices] = useState([]);
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [loading, setLoading] = useState(false);

      useEffect(() => {
        loadInvoices();
      }, []);

      const loadInvoices = async () => {
        if (db) {
          const snapshot = await db.collection('invoices')
            .where('farrierId', '==', userId)
            .orderBy('createdAt', 'desc')
            .get();
          
          const invoiceData = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setInvoices(invoiceData);
        }
      };

      const totalCollected = invoices
        .filter(inv => inv.status === 'paid')
        .reduce((sum, inv) => sum + (inv.total || 0), 0);

      const totalOutstanding = invoices
        .filter(inv => inv.status === 'outstanding')
        .reduce((sum, inv) => sum + (inv.total || 0), 0);

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>Invoices & Payments</h1>
          
          <div className="dashboard-grid">
            <div className="stat-card">
              <div className="stat-label">Total Collected</div>
              <div className="stat-value" style={{color: 'var(--success)'}}>${totalCollected.toFixed(2)}</div>
            </div>
            <div className="stat-card">
              <div className="stat-label">Outstanding</div>
              <div className="stat-value" style={{color: 'var(--warning)'}}>${totalOutstanding.toFixed(2)}</div>
            </div>
          </div>

          <div className="card">
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem'}}>
              <h2 style={{marginBottom: 0}}>Your Invoices</h2>
              <button className="btn btn-primary" onClick={() => setShowCreateModal(true)}>
                + Create Invoice
              </button>
            </div>
            
            {invoices.length === 0 ? (
              <p style={{color: 'var(--text-muted)'}}>
                No invoices yet. Create your first invoice with Authorize.Net payment links!
              </p>
            ) : (
              <div className="appointments-list">
                {invoices.map(invoice => (
                  <div key={invoice.id} className="appointment-item">
                    <div className="appointment-info">
                      <div className="appointment-customer">
                        Invoice #{invoice.invoiceNumber} - {invoice.customerName}
                      </div>
                      <div className="appointment-details">
                        Amount: ${invoice.total?.toFixed(2)} ‚Ä¢ Created: {invoice.createdAt?.toDate().toLocaleDateString()}
                        {invoice.paymentUrl && (
                          <><br/>Payment Link: <a href={invoice.paymentUrl} target="_blank" style={{color: 'var(--primary)'}}>View</a></>
                        )}
                      </div>
                    </div>
                    <div className="appointment-actions">
                      <span className={`badge badge-${invoice.status === 'paid' ? 'success' : 'warning'}`}>
                        {invoice.status}
                      </span>
                      {invoice.status === 'outstanding' && invoice.paymentUrl && (
                        <button 
                          className="btn btn-sm btn-warning"
                          onClick={() => {
                            const message = `Hi ${invoice.customerName}! Your invoice #${invoice.invoiceNumber} for $${invoice.total?.toFixed(2)} is ready. Pay here: ${invoice.paymentUrl}`;
                            alert(`SMS would be sent:\n\n${message}`);
                          }}
                        >
                          üì± Send Reminder
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {showCreateModal && (
            <InvoiceCreateModal 
              userId={userId}
              onClose={() => setShowCreateModal(false)}
              onCreated={() => {
                setShowCreateModal(false);
                loadInvoices();
              }}
            />
          )}
        </div>
      );
    }

    function InvoiceCreateModal({ userId, onClose, onCreated }) {
      const [customerName, setCustomerName] = useState('');
      const [customerEmail, setCustomerEmail] = useState('');
      const [customerPhone, setCustomerPhone] = useState('');
      const [items, setItems] = useState([{ description: 'Farrier Service', amount: 0 }]);
      const [paymentUrl, setPaymentUrl] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const addItem = () => {
        setItems([...items, { description: '', amount: 0 }]);
      };

      const updateItem = (index, field, value) => {
        const newItems = [...items];
        newItems[index][field] = value;
        setItems(newItems);
      };

      const removeItem = (index) => {
        setItems(items.filter((_, i) => i !== index));
      };

      const total = items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

      const generatePaymentLink = async () => {
        if (!customerName || !customerEmail) {
          setError('Customer name and email are required');
          return;
        }

        if (total <= 0) {
          setError('Invoice total must be greater than $0');
          return;
        }

        setError('');
        setLoading(true);

        try {
          // Call Netlify function to create Authorize.Net payment
          const response = await fetch('/.netlify/functions/create-authorize-payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              customerName: customerName,
              customerEmail: customerEmail,
              amount: total,
              invoiceNumber: `INV-${Date.now()}`,
              description: items.map(i => i.description).join(', ')
            })
          });

          const data = await response.json();

          if (data.success) {
            setPaymentUrl(data.paymentUrl);
            
            // Save invoice to Firestore
            if (db) {
              const invoiceNumber = `INV-${Date.now()}`;
              await db.collection('invoices').add({
                farrierId: userId,
                customerName: customerName,
                customerEmail: customerEmail,
                customerPhone: customerPhone,
                items: items,
                total: total,
                invoiceNumber: invoiceNumber,
                paymentUrl: data.paymentUrl,
                status: 'outstanding',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }

            alert('Invoice created successfully!');
          } else {
            setError(data.error || 'Failed to create payment link');
          }
        } catch (err) {
          console.error('Error:', err);
          setError('Error creating payment link. Make sure Authorize.Net is configured.');
        }

        setLoading(false);
      };

      const sendInvoice = () => {
        const message = `Hi ${customerName}! Your invoice for $${total.toFixed(2)} is ready. Pay here: ${paymentUrl}`;
        alert(`SMS would be sent to ${customerPhone}:\n\n${message}`);
        onCreated();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Create Invoice</h2>
              <button className="close-btn" onClick={onClose}>√ó</button>
            </div>

            {error && <div className="error-message">{error}</div>}

            <div className="form-group">
              <label>Customer Name *</label>
              <input 
                type="text"
                value={customerName}
                onChange={(e) => setCustomerName(e.target.value)}
                placeholder="John Smith"
              />
            </div>

            <div className="form-group">
              <label>Customer Email *</label>
              <input 
                type="email"
                value={customerEmail}
                onChange={(e) => setCustomerEmail(e.target.value)}
                placeholder="customer@email.com"
              />
            </div>

            <div className="form-group">
              <label>Customer Phone</label>
              <input 
                type="tel"
                value={customerPhone}
                onChange={(e) => setCustomerPhone(e.target.value)}
                placeholder="+1234567890"
              />
            </div>

            <div className="form-group">
              <label>Invoice Items</label>
              {items.map((item, idx) => (
                <div key={idx} style={{display: 'flex', gap: '0.5rem', marginBottom: '0.75rem'}}>
                  <input 
                    type="text"
                    placeholder="Description"
                    value={item.description}
                    onChange={(e) => updateItem(idx, 'description', e.target.value)}
                    style={{flex: 2}}
                  />
                  <input 
                    type="number"
                    placeholder="Amount"
                    value={item.amount}
                    onChange={(e) => updateItem(idx, 'amount', e.target.value)}
                    style={{flex: 1}}
                    step="0.01"
                    min="0"
                  />
                  {items.length > 1 && (
                    <button 
                      className="btn btn-sm btn-outline"
                      onClick={() => removeItem(idx)}
                      type="button"
                    >
                      ‚úï
                    </button>
                  )}
                </div>
              ))}
              <button className="btn btn-sm btn-outline" onClick={addItem} type="button">
                + Add Item
              </button>
            </div>

            <div style={{borderTop: '2px solid var(--border)', paddingTop: '1rem', marginTop: '1rem'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '1.5rem', fontWeight: '800', color: 'var(--primary)'}}>
                <span>Total</span>
                <span>${total.toFixed(2)}</span>
              </div>
            </div>

            {!paymentUrl ? (
              <button 
                className="btn btn-primary" 
                style={{width: '100%', marginTop: '1rem'}}
                onClick={generatePaymentLink}
                disabled={loading}
              >
                {loading ? <span className="spinner"></span> : 'üîó Generate Authorize.Net Payment Link'}
              </button>
            ) : (
              <div>
                <div style={{background: '#E6F4EA', border: '2px solid var(--success)', borderRadius: '8px', padding: '1rem', marginTop: '1rem'}}>
                  <strong>‚úì Payment Link Created!</strong>
                  <div style={{marginTop: '0.5rem', wordBreak: 'break-all', fontSize: '0.875rem'}}>
                    {paymentUrl}
                  </div>
                </div>
                <button 
                  className="btn btn-outline" 
                  style={{width: '100%', marginTop: '0.5rem'}}
                  onClick={() => {
                    navigator.clipboard.writeText(paymentUrl);
                    alert('Payment link copied!');
                  }}
                >
                  üìã Copy Link
                </button>
                <button 
                  className="btn btn-success" 
                  style={{width: '100%', marginTop: '0.5rem'}}
                  onClick={sendInvoice}
                >
                  üì± Send Invoice via SMS
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    function SettingsView({ user, userProfile, setUserProfile }) {
      const [businessName, setBusinessName] = useState(userProfile?.businessName || '');
      const [phone, setPhone] = useState(userProfile?.phone || '');
      const [address, setAddress] = useState(userProfile?.address || '');
      const [city, setCity] = useState(userProfile?.city || '');
      const [state, setState] = useState(userProfile?.state || '');
      const [zip, setZip] = useState(userProfile?.zip || '');
      const [loading, setLoading] = useState(false);
      const [successMessage, setSuccessMessage] = useState('');
      const [error, setError] = useState('');

      const handleSave = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        setSuccessMessage('');

        try {
          if (db) {
            await db.collection('farriers').doc(user.uid).update({
              businessName: businessName,
              phone: phone,
              address: address,
              city: city,
              state: state,
              zip: zip,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Update local state
            setUserProfile({
              ...userProfile,
              businessName,
              phone,
              address,
              city,
              state,
              zip
            });

            setSuccessMessage('Profile updated successfully!');
          }
        } catch (err) {
          console.error('Error updating profile:', err);
          setError('Failed to update profile. Please try again.');
        }

        setLoading(false);
      };

      return (
        <div>
          <h1 style={{marginBottom: '1.5rem', fontSize: '2rem', color: 'var(--primary)'}}>
            Account Settings
          </h1>

          {successMessage && <div className="success-message">{successMessage}</div>}
          {error && <div className="error-message">{error}</div>}

          <div className="card">
            <h2>Business Profile</h2>
            <form onSubmit={handleSave}>
              <div className="form-group">
                <label>Business Name *</label>
                <input 
                  type="text"
                  required
                  value={businessName}
                  onChange={(e) => setBusinessName(e.target.value)}
                  placeholder="John's Farrier Services"
                />
              </div>

              <div className="form-group">
                <label>Email (Cannot be changed)</label>
                <input 
                  type="email"
                  value={userProfile?.email || user.email}
                  disabled
                  style={{background: '#f5f5f5', cursor: 'not-allowed'}}
                />
              </div>

              <div className="form-group">
                <label>Phone Number *</label>
                <input 
                  type="tel"
                  required
                  value={phone}
                  onChange={(e) => setPhone(e.target.value)}
                  placeholder="(555) 555-5555"
                />
              </div>

              <div className="form-group">
                <label>Business Address *</label>
                <input 
                  type="text"
                  required
                  value={address}
                  onChange={(e) => setAddress(e.target.value)}
                  placeholder="123 Main Street"
                />
              </div>

              <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem'}}>
                <div className="form-group">
                  <label>City *</label>
                  <input 
                    type="text"
                    required
                    value={city}
                    onChange={(e) => setCity(e.target.value)}
                    placeholder="City"
                  />
                </div>

                <div className="form-group">
                  <label>State *</label>
                  <input 
                    type="text"
                    required
                    value={state}
                    onChange={(e) => setState(e.target.value.toUpperCase())}
                    placeholder="VA"
                    maxLength="2"
                    style={{textTransform: 'uppercase'}}
                  />
                </div>

                <div className="form-group">
                  <label>ZIP *</label>
                  <input 
                    type="text"
                    required
                    value={zip}
                    onChange={(e) => setZip(e.target.value)}
                    placeholder="12345"
                    maxLength="5"
                    pattern="[0-9]{5}"
                  />
                </div>
              </div>

              <button 
                type="submit" 
                className="btn btn-primary"
                disabled={loading}
                style={{marginTop: '1rem'}}
              >
                {loading ? <span className="spinner"></span> : 'Save Changes'}
              </button>
            </form>
          </div>

          <div className="card" style={{marginTop: '1.5rem'}}>
            <h2>Account Information</h2>
            <p style={{color: 'var(--text-muted)', marginBottom: '1rem'}}>
              <strong>Account Created:</strong> {userProfile?.createdAt?.toDate().toLocaleDateString() || 'N/A'}
            </p>
            <p style={{color: 'var(--text-muted)'}}>
              <strong>Booking URL:</strong><br/>
              <code style={{background: '#f5f5f5', padding: '0.5rem', borderRadius: '4px', display: 'inline-block', marginTop: '0.5rem'}}>
                {userProfile?.bookingUrl || `${window.location.origin}?farrier=${user.uid}`}
              </code>
            </p>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
